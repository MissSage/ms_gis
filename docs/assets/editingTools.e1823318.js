var zo=Object.defineProperty,No=Object.defineProperties;var Fo=Object.getOwnPropertyDescriptors;var Zs=Object.getOwnPropertySymbols;var Ho=Object.prototype.hasOwnProperty,ko=Object.prototype.propertyIsEnumerable;var qs=(t,e,i)=>e in t?zo(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i,L=(t,e)=>{for(var i in e||(e={}))Ho.call(e,i)&&qs(t,i,e[i]);if(Zs)for(var i of Zs(e))ko.call(e,i)&&qs(t,i,e[i]);return t},z=(t,e)=>No(t,Fo(e));import{aD as c,aE as g,aF as q,aB as _i,bL as te,a_ as jo,g5 as Uo,a8 as Bo,at as I,g6 as Xo,dV as Ot,U as m,O as h,g7 as Yo,eX as Wo,g8 as Qs,g9 as Js,fu as Zo,ab as re,ga as ia,gb as Yt,gc as qo,aR as _t,bQ as Qa,aT as At,aO as Se,gd as Qo,ag as b,ge as aa,gf as _e,ai as U,f_ as D,gg as Wt,gh as tt,gi as me,gj as ie,aI as fe,fH as sa,g2 as B,gk as Ks,gl as Tt,f$ as we,g0 as H,gm as en,gn as Jo,aP as N,go as mi,V as tn,gp as an,gq as Ja,fZ as na,gr as sn,gs as fi,aZ as it,$ as C,gt as Ka,gu as Zt,gv as $e,gw as Ce,bR as K,gx as Ko,gy as es,au as Ue,gz as Be,ax as ra,gA as el,fG as oa,gB as ts,g3 as S,gC as vi,gD as is,gE as yi,aL as Pt,gF as tl,gG as xe,gH as oe,gI as bi,f2 as mt,gJ as il,gK as as,gL as al,gM as Rt,gN as sl,gO as nl,bk as rl,gP as nn,gQ as Mi,ap as Le,aJ as Q,gR as rn,gS as ol,gT as ll,gU as on,gV as hl,gW as cl,gX as dl,gY as ve,eR as pl,gZ as ul,g_ as gl,g$ as ln,eU as X,h0 as ss,aX as hn,h1 as ae,h2 as ns,h3 as _l,h4 as cn,h5 as ml,h6 as la,h7 as fl,h8 as dn,h9 as pn,ha as qt,hb as un,g4 as gn,fx as vl,hc as rs,hd as yl,he as x,hf as bl,hg as Xe,hh as Ml,hi as Sl,hj as wl,hk as os,hl as xl,hm as El,hn as le,ho as Ol,hp as Al,hq as J,hr as _n,hs as Tl,ht as mn,hu as Pl,hv as fn,hw as ft,hx as vn,hy as ls,hz as Rl,g1 as Si,hA as Dl,hB as $l,hC as Ie,hD as wi,hE as Cl,hF as Qt,hG as hs,hH as yn,hI as ha,hJ as Ll,hK as bn,hL as Il,X as Mn,aM as Jt,hM as Kt,aA as Sn,f6 as ca,hN as Gl,f8 as vt,hO as da,hP as Vl,hQ as wn,hR as zl,hS as Nl,hT as pa,hU as ua,fb as Fl,fd as cs,hV as Hl,hW as kl,hX as xn,fT as xi,hY as En,fS as jl,hZ as ds,h_ as at,h$ as Dt,i0 as On,i1 as An,i2 as Ul,e$ as Bl,i3 as Xl,i4 as Tn,i5 as Yl,dI as ps,f7 as Pn,i6 as Wl,i7 as Zl,i8 as ga,ar as ql,i9 as Ql,ia as Ei,ib as Rn,ic as Dn,id as Jl,ie as Kl,ig as eh,dO as $n,dP as th,ih as Cn,ii as Ln,ij as ih,ik as In,il as Gn,im as Vn,io as ah,ip as sh,iq as nh,ir as rh,is as zn,it as Nn,iu as Fn,iv as oh,iw as lh,fP as $t,fF as hh,ix as Hn,iy as ch}from"./vendor.1bde3be2.js";import{d as dh,x as ph,v as _a,b as st,y as ma,j as Oi,c as Ai,e as fa,f as uh,m as gh,l as _h,a as Ti,g as us,p as kn,h as va,D as mh}from"./automaticLengthMeasurementUtils.a1544857.js";import{r as Ct,t as jn}from"./vec4f32.f3b49d2e.js";import{s as Un,p as Bn,a as Xn,v as Yn,A as Wn}from"./Octree.094ec680.js";import{l as Lt,v as Pi,h as ya,m as fh,b as Ri,M as vh,B as yh}from"./lineSegment.54baecae.js";import{o as bh}from"./glUtil.b02793dc.js";import{T as Zn}from"./InterleavedLayout.2f6f3736.js";import{a as Mh,n as Sh,o as pe,e as nt,f as gs,b as It,c as R,d as Di,g as qn,t as $i,h as Ci,i as Li,r as wh,j as k,k as xh,l as Eh,m as yt,p as Oh,E as _s,S as Ah,q as Te,B as Th,u as Ph,s as $,v as Rh,L as Qn,w as Jn,x as Dh,y as $h,z as Y,A as Kn,C as er,D as tr,F as ms,G as Ch,H as ir,I as Lh,J as ar,K as sr,M as fs,N as Ih,O as nr,P as Gh,Q as Vh,R as rr,T as zh,U as Nh,V as Fh,W as Hh}from"./SSAOHelper.fdd527db.js";import{O}from"./VertexAttribute.42396f25.js";import{R as Ye,E as or,F as kh,I as ba}from"./enums.2d9e6f64.js";import{W as Ii,a as vs,_ as Gi,i as Ma,o as We,n as se,c as jh,A as lr,h as hr,b as cr,E as dr,d as Uh,l as Bh,e as Xh,S as Yh,f as Wh}from"./OrderIndependentTransparency.9f3f7312.js";import{E as Zh}from"./VertexArrayObject.1a48ce00.js";import{l as ys,x as bs,H as Gt,q as rt,o as qh,Q as Qh,m as Sa,h as ei,b as Jh,a as Kh,c as Ze,r as Ms,e as ec,E as pr,s as tc,T as ic,d as ur,i as ac,f as sc,g as Vi,J as nc,j as Ss,v as rc,k as oc,F as ws,A as lc,Z as zi,B as gr,n as hc,X as cc,C as xs,p as _r}from"./NativeLineMaterial.f9bf9e62.js";import{i as dc}from"./BufferView.a124dc0f.js";import{e as pc}from"./Util.96d35f9a.js";import{Z as uc,q as gc}from"./DrawGraphicTool.2bee6f44.js";import{H as _c,G as ti,X as Ni}from"./boundedPlane.9be546f4.js";import{C as mc}from"./GraphicManipulator.11e45848.js";import{r as Fi,p as wa,a as Es,l as fc,c as vc,n as yc}from"./TranslateTooltipInfos.221f0d6e.js";import{i as bc}from"./automaticAreaMeasurementUtils.4eab3370.js";import{g as Mc,l as Sc}from"./axisAngleDegrees.735a5767.js";import{g as Hi}from"./persistable.f29838bc.js";import{i as wc,p as xc}from"./ExtentTooltipInfos.c5328943.js";let Ec=t=>({vnodeSelector:"",properties:void 0,children:void 0,text:t.toString(),domNode:null}),mr=(t,e,i)=>{for(let a=0,s=e.length;a<s;a++){let n=e[a];Array.isArray(n)?mr(t,n,i):n!=null&&n!==!1&&(typeof n=="string"&&(n=Ec(n)),i.push(n))}};function Oc(t,e,i){if(Array.isArray(e))i=e,e=void 0;else if(e&&(typeof e=="string"||e.hasOwnProperty("vnodeSelector"))||i&&(typeof i=="string"||i.hasOwnProperty("vnodeSelector")))throw new Error("h called with invalid arguments");let a,s;return i&&i.length===1&&typeof i[0]=="string"?a=i[0]:i&&(s=[],mr(t,i,s),s.length===0&&(s=void 0)),{vnodeSelector:t,properties:e,children:s,text:a===""?void 0:a,domNode:null}}const fr={bottom:"esri-text-overlay-item-anchor-bottom","bottom-right":"esri-text-overlay-item-anchor-bottom-right","bottom-left":"esri-text-overlay-item-anchor-bottom-left",top:"esri-text-overlay-item-anchor-top","top-right":"esri-text-overlay-item-anchor-top-right","top-left":"esri-text-overlay-item-anchor-top-left",center:"esri-text-overlay-item-anchor-center",right:"esri-text-overlay-item-anchor-right",left:"esri-text-overlay-item-anchor-left"};let he=class extends _i{constructor(t){super(t),this.x=0,this.y=0,this.text="-",this.fontSize=14,this.anchor="center",this.visible=!0,this.backgroundColor=new te([0,0,0,.6]),this.textColor=new te([255,255,255]),this._textShadowSize=1}get position(){return[this.x,this.y]}set position(t){this._set("x",t[0]),this._set("y",t[1])}get _textShadowColor(){return this.backgroundColor}get _textShadow(){const t=this._textShadowColor.toCss(!1);return`0 0 ${this._textShadowSize}px ${t}`}get _padding(){return .5*this.fontSize}get _borderRadius(){return this._padding}render(){return Oc("div",{classes:this._cssClasses(),styles:{left:Math.floor(this.x)+"px",top:Math.floor(this.y)+"px",visibility:this.visible?"visible":"hidden",fontSize:this.fontSize+"px",lineHeight:this.fontSize+"px",backgroundColor:this.backgroundColor.toCss(!0),color:this.textColor.toCss(!0),padding:this._padding+"px",borderRadius:this._borderRadius+"px",textShadow:this._textShadow}},[this.text])}renderCanvas(t){if(!this.visible)return;const e=t.font.replace(/^(.*?)px/,"");t.font=`${this.fontSize}px ${e}`;const i=this._padding,a=this._borderRadius,s=t.measureText(this.text).width,n=this.fontSize,r=Ac[this.anchor];t.textAlign="center",t.textBaseline="middle";const o=s+2*i,l=n+2*i,p=this.x+r.x*o,u=this.y+r.y*l;this._roundedRect(t,p,u,o,l,a),t.fillStyle=this.backgroundColor.toCss(!0),t.fill();const d=this.x+(r.x+.5)*o,_=this.y+(r.y+.5)*l;this._renderTextShadow(t,this.text,d,_),t.fillStyle=this.textColor.toCss(!0),t.fillText(this.text,d,_)}_renderTextShadow(t,e,i,a){t.lineJoin="miter",t.fillStyle=`rgba(${this._textShadowColor.r}, ${this._textShadowColor.g}, ${this._textShadowColor.b}, ${1/Os.length})`;const s=this._textShadowSize;for(const[n,r]of Os)t.fillText(e,i+s*n,a+s*r)}_roundedRect(t,e,i,a,s,n){t.beginPath(),t.moveTo(e,i+n),t.arcTo(e,i,e+n,i,n),t.lineTo(e+a-n,i),t.arcTo(e+a,i,e+a,i+n,n),t.lineTo(e+a,i+s-n),t.arcTo(e+a,i+s,e+a-n,i+s,n),t.lineTo(e+n,i+s),t.arcTo(e,i+s,e,i+s-n,n),t.closePath()}_cssClasses(){const t={"esri-text-overlay-item":!0};for(const e in fr)t[fr[e]]=this.anchor===e;return t}};c([g()],he.prototype,"x",void 0),c([g()],he.prototype,"y",void 0),c([g()],he.prototype,"position",null),c([g()],he.prototype,"text",void 0),c([g()],he.prototype,"fontSize",void 0),c([g()],he.prototype,"anchor",void 0),c([g()],he.prototype,"visible",void 0),c([g()],he.prototype,"backgroundColor",void 0),c([g()],he.prototype,"textColor",void 0),c([g()],he.prototype,"_textShadowSize",void 0),c([g()],he.prototype,"_textShadowColor",null),c([g()],he.prototype,"_textShadow",null),c([g()],he.prototype,"_padding",null),c([g()],he.prototype,"_borderRadius",null),he=c([q("esri.views.overlay.TextOverlayItem")],he);const Ac={bottom:{x:-.5,y:-1,textAlign:"center",textBaseline:"bottom"},"bottom-left":{x:0,y:-1,textAlign:"left",textBaseline:"bottom"},"bottom-right":{x:-1,y:-1,textAlign:"right",textBaseline:"bottom"},center:{x:-.5,y:-.5,textAlign:"center",textBaseline:"middle"},left:{x:0,y:-.5,textAlign:"left",textBaseline:"middle"},right:{x:-1,y:-.5,textAlign:"right",textBaseline:"middle"},top:{x:-.5,y:0,textAlign:"center",textBaseline:"top"},"top-left":{x:0,y:0,textAlign:"left",textBaseline:"top"},"top-right":{x:-1,y:0,textAlign:"right",textBaseline:"top"}},Os=[];{const t=16;for(let e=0;e<360;e+=360/t)Os.push([Math.cos(Math.PI*e/180),Math.sin(Math.PI*e/180)])}const Tc=he,Pc=3025,Rc={default:15,far:25};let qe=class extends _i{constructor(t){super(t),this.context=null,this.stagedVertex=null,this.visible=!0,this.edgeDistance="default",this._messagesUnits=null,this._labelInfos=[],this._nextLabelIndex=0}initialize(){const t=jo(async i=>{const a=await Uo("esri/core/t9n/Units");Bo(i),this._messagesUnits=a}),e=()=>Qa(this.context,i=>i.editGeometryOperations);this.addHandles([I(()=>[h(this.context)&&this.getCameraOrExtent(this.context),this.visible,this._edgeDistancePixels,this.stagedVertex,this._messagesUnits],()=>this._update()),...["vertex-add","vertex-update","vertex-remove"].map(i=>Xo(e,i,()=>this._update())),Ot(()=>t.abort())])}destroy(){for(this._nextLabelIndex=0;this._labelInfos.length;)this._destroyLabel(this._labelInfos.pop())}get updating(){return m(this._messagesUnits)}get test(){return{labelContents:this._labelInfos.slice(0,this._nextLabelIndex).map(t=>t.label.text)}}get _edgeDistancePixels(){return Rc[this.edgeDistance]}_update(){this._nextLabelIndex=0;const t=this.context;if(m(t))return void this._destroyUnusedLabels();const{components:e,geometry:i,coordinateHelper:a}=t.editGeometryOperations.data;if(!i)return void this._destroyUnusedLabels();const s=e.length;for(let n=0;n<s;++n){const r=[];if(e[n].iterateVertices(_=>{r.push(a.toXYZ(_.pos))}),n===0&&h(this.stagedVertex)&&r.push(a.toXYZ(this.stagedVertex)),r.length<2)continue;const o=r[0],l=r[r.length-1];i.type==="polygon"&&r.length>2&&!Yo(o,l)&&r.push(o);const p=s===1&&!Wo(r,!1,!1);let u=Dc,d=$c;this.toScreenPointArray(t,o,u);for(let _=1;_<r.length;++_){const f=r[_-1],v=r[_];this.toScreenPointArray(t,v,d),this._addLabel(t,f,u,v,d,p),[u,d]=[d,u]}}this._destroyUnusedLabels()}_addLabel(t,e,i,a,s,n){const{label:r}=this._getOrCreateLabel(t);if(!this.visible||Qs(i,s)<Pc)return void(r.visible=!1);const o=h(t.graphicState)?t.graphicState.isDraped?"on-the-ground":"absolute-height":Js(t.editGeometryOperations.data.geometry,t.elevationInfo),{spatialReference:l}=t.editGeometryOperations.data,p=dh(e,a,l,o),u=this._messagesUnits,d=Zo(t.view);r.text=h(u)&&h(p)?ph(u,p,d):"",r.visible=!0;const _=s[0]-i[0],f=s[1]-i[1];n?re(Ge,-f,_):re(Ge,f,-_),ia(Ge,Ge),Yt(Ge,Ge,this._edgeDistancePixels),qo(ki,i,s,.5),_t(ki,ki,Ge),r.position=[ki[0],ki[1]],Math.abs(Ge[0])>Math.abs(Ge[1])?r.anchor=Ge[0]>0?"left":"right":r.anchor=-Ge[1]<0?"top":"bottom"}_getOrCreateLabel(t){if(this._labelInfos.length>this._nextLabelIndex)return this._labelInfos[this._nextLabelIndex++];const e=new Tc({fontSize:10,anchor:"center"});t.view.overlay.items.add(e);const i={label:e};return this._labelInfos.push(i),this._nextLabelIndex=this._labelInfos.length,i}_destroyUnusedLabels(){for(;this._labelInfos.length>this._nextLabelIndex;)this._destroyLabel(this._labelInfos.pop())}_destroyLabel({label:t}){Qa(this.context,e=>e.view.overlay.items.remove(t)),t.destroy()}};c([g()],qe.prototype,"context",void 0),c([g()],qe.prototype,"stagedVertex",void 0),c([g()],qe.prototype,"visible",void 0),c([g()],qe.prototype,"edgeDistance",void 0),c([g()],qe.prototype,"updating",null),c([g()],qe.prototype,"_messagesUnits",void 0),c([g()],qe.prototype,"_edgeDistancePixels",null),qe=c([q("esri.views.interactive")],qe);const Ge=At(),ki=At(),Dc=Se(),$c=Se();let xa=class extends qe{getCameraOrExtent({view:t}){return t.state.camera}toScreenPointArray({view:t,elevationInfo:e,editGeometryOperations:i},a,s=Se()){const{spatialReference:n}=i.data.coordinateHelper;return Qo(a,n,e,t,vr),t.state.camera.projectToScreen(vr,s),s}};xa=c([q("esri.views.3d.interactive.SegmentLabels3D")],xa);const vr=b();class yr{constructor(e){this._attached=!1,this._resourcesCreated=!1,this._visible=!0,this.view=e,this._handle=I(()=>this.view.ready,i=>{this._resourcesCreated&&(i?this._createResources():this._destroyResources())})}applyProps(e){let i=!1;for(const a in e)a in this?a==="attached"?i=e[a]:this[a]=e[a]:console.error("Cannot set unknown property",a);this.attached=i}destroy(){this.attached=!1,this._handle.remove()}get attached(){return this._attached}set attached(e){e!==this._attached&&this.view._stage&&(this._attached=e,this._attached&&!this._resourcesCreated?this._createResources():!this._attached&&this._resourcesCreated&&this._destroyResources())}get visible(){return this._visible}set visible(e){e!==this._visible&&(this._visible=e,this.attached&&this.updateVisibility(e))}_createResources(){this.createResources(),this._resourcesCreated=!0,this.visible||this.updateVisibility(!1)}_destroyResources(){this.destroyResources(),this._resourcesCreated=!1}}function br(t,e){t.extensions.add("GL_OES_standard_derivatives");const i=t.fragment;i.include(Mh),t.include(Sh),i.uniforms.add([new pe("globalAlpha",a=>a.globalAlpha),new nt("glowColor",a=>a.glowColor),new pe("glowWidth",(a,s)=>a.glowWidth*s.camera.pixelRatio),new pe("glowFalloff",a=>a.glowFalloff),new nt("innerColor",a=>a.innerColor),new pe("innerWidth",(a,s)=>a.innerWidth*s.camera.pixelRatio),new gs("depthMap",(a,s)=>s.linearDepthTexture),new It("nearFar",(a,s)=>s.camera.nearFar),new gs("frameColor",(a,s)=>s.mainColorTexture)]),i.code.add(R`vec4 blendPremultiplied(vec4 source, vec4 dest) {
float oneMinusSourceAlpha = 1.0 - source.a;
return vec4(
source.rgb + dest.rgb * oneMinusSourceAlpha,
source.a + dest.a * oneMinusSourceAlpha
);
}`),i.code.add(R`vec4 premultipliedColor(vec3 rgb, float alpha) {
return vec4(rgb * alpha, alpha);
}`),i.code.add(R`vec4 laserlineProfile(float dist) {
if (dist > glowWidth) {
return vec4(0.0);
}
float innerAlpha = (1.0 - smoothstep(0.0, innerWidth, dist));
float glowAlpha = pow(max(0.0, 1.0 - dist / glowWidth), glowFalloff);
return blendPremultiplied(
premultipliedColor(innerColor, innerAlpha),
premultipliedColor(glowColor, glowAlpha)
);
}`),i.code.add(R`bool laserlineReconstructFromDepth(out vec3 pos, out vec3 normal, out float depthDiscontinuityAlpha) {
float depth = linearDepthFromTexture(depthMap, uv, nearFar);
if (-depth == nearFar[0]) {
return false;
}
pos = reconstructPosition(gl_FragCoord.xy, depth);
normal = normalize(cross(dFdx(pos), dFdy(pos)));
float ddepth = fwidth(depth);
depthDiscontinuityAlpha = 1.0 - smoothstep(0.0, 0.01, -ddepth / depth);
return true;
}`),e.contrastControlEnabled?(i.uniforms.add(new pe("globalAlphaContrastBoost",a=>h(a.globalAlphaContrastBoost)?a.globalAlphaContrastBoost:1)),i.code.add(R`float rgbToLuminance(vec3 color) {
return dot(vec3(0.2126, 0.7152, 0.0722), color);
}
vec4 laserlineOutput(vec4 color) {
float backgroundLuminance = rgbToLuminance(texture2D(frameColor, uv).rgb);
float alpha = clamp(globalAlpha * max(backgroundLuminance * globalAlphaContrastBoost, 1.0), 0.0, 1.0);
return color * alpha;
}`)):i.code.add(R`vec4 laserlineOutput(vec4 color) {
return color * globalAlpha;
}`)}function Cc(t){const e=new Di;e.include(br,t);const{vertex:i,fragment:a}=e;return i.uniforms.add([new qn("modelView",(s,n)=>aa(Ic,n.camera.viewMatrix,s.origin)),new qn("proj",(s,n)=>n.camera.projectionMatrix),new pe("glowWidth",(s,n)=>s.glowWidth*n.camera.pixelRatio),new It("pixelToNDC",(s,n)=>re(Lc,2/n.camera.fullViewport[2],2/n.camera.fullViewport[3]))]),e.attributes.add(O.START,"vec3"),e.attributes.add(O.END,"vec3"),e.attributes.add(O.UP,"vec3"),e.attributes.add(O.EXTRUDE,"vec2"),e.varyings.add("uv","vec2"),e.varyings.add("vViewStart","vec3"),e.varyings.add("vViewEnd","vec3"),e.varyings.add("vViewPlane","vec4"),i.code.add(R`void main() {
vec3 pos = mix(start, end, extrude.x);
vec4 viewPos = modelView * vec4(pos, 1);
vec4 projPos = proj * viewPos;
vec2 ndcPos = projPos.xy / projPos.w;
vec3 viewUp = (modelView * vec4(extrude.y * up, 0)).xyz;
vec4 projPosUp = proj * vec4(viewPos.xyz + viewUp, 1);
vec2 projExtrudeDir = normalize(projPosUp.xy / projPosUp.w - ndcPos);
vec2 lxy = abs(sign(projExtrudeDir) - ndcPos);
ndcPos += length(lxy) * projExtrudeDir;
vec3 worldPlaneNormal = normalize(cross(up, normalize(end - start)));
vec3 viewPlaneNormal = (modelView * vec4(worldPlaneNormal, 0)).xyz;
vViewStart = (modelView * vec4(start, 1)).xyz;
vViewEnd = (modelView * vec4(end, 1)).xyz;
vViewPlane = vec4(viewPlaneNormal, -dot(viewPlaneNormal, vViewStart));
float xPaddingPixels = sign(dot(viewPlaneNormal, viewPos.xyz)) * (extrude.x * 2.0 - 1.0) * glowWidth;
ndcPos.x += xPaddingPixels * pixelToNDC.x;
uv = ndcPos * 0.5 + 0.5;
gl_Position = vec4(ndcPos, 0, 1);
}`),a.uniforms.add(new pe("perScreenPixelRatio",(s,n)=>n.camera.perScreenPixelRatio)),a.code.add(R`float planeDistancePixels(vec4 plane, vec3 pos, vec3 start, vec3 end) {
vec3 origin = mix(start, end, 0.5);
vec3 basis = end - origin;
vec3 posAtOrigin = pos - origin;
float x = dot(normalize(basis), posAtOrigin);
float y = dot(plane.xyz, posAtOrigin);
float dx = max(abs(x) - length(basis), 0.0);
float dy = y;
float dist = length(vec2(dx, dy));
float width = fwidth(y);
float maxPixelDistance = length(pos) * perScreenPixelRatio * 2.0;
float pixelDist = dist / min(width, maxPixelDistance);
return abs(pixelDist);
}
void main() {
vec3 pos;
vec3 normal;
float depthDiscontinuityAlpha;
if (!laserlineReconstructFromDepth(pos, normal, depthDiscontinuityAlpha)) {
discard;
}
float distance = planeDistancePixels(vViewPlane, pos, vViewStart, vViewEnd);
vec4 color = laserlineProfile(distance);
float alpha = 1.0 - smoothstep(0.995, 0.999, abs(dot(normal, vViewPlane.xyz)));
gl_FragColor = laserlineOutput(color * alpha * depthDiscontinuityAlpha);
}`),e}const Lc=At(),Ic=_e(),Gc=Object.freeze(Object.defineProperty({__proto__:null,build:Cc},Symbol.toStringTag,{value:"Module"}));class Ea extends Ci{initializeProgram(e){return new Li(e.rctx,Ea.shader.get().build(this.configuration),Mr)}initializePipeline(){return Ii({blending:vs(Ye.ONE,Ye.ONE_MINUS_SRC_ALPHA),colorWrite:Gi})}}Ea.shader=new $i(Gc,()=>import("./LaserlinePath.glsl.fc014f86.js"));const Mr=new Map([[O.START,0],[O.END,1],[O.UP,2],[O.EXTRUDE,3]]);class Sr{constructor(e){this._renderCoordsHelper=e,this._buffers=null,this._origin=b(),this._dirty=!1,this._count=0,this._vao=null}set vertices(e){const i=new Float64Array(3*e.length);let a=0;for(const s of e)i[a++]=s[0],i[a++]=s[1],i[a++]=s[2];this.buffers=[i]}set buffers(e){if(this._buffers=e,this._buffers.length>0){const i=this._buffers[0],a=3*Math.floor(i.length/3/2);U(this._origin,i[a+0],i[a+1],i[a+2])}else U(this._origin,0,0,0);this._dirty=!0}get origin(){return this._origin}draw(e){const i=this._ensureVAO(e);h(i)&&(e.bindVAO(i),e.drawArrays(or.TRIANGLES,0,this._count))}dispose(){h(this._vao)&&this._vao.dispose()}_ensureVAO(e){return m(this._buffers)?null:(m(this._vao)&&(this._vao=this._createVAO(e,this._buffers)),this._ensureVertexData(this._vao,this._buffers),this._vao)}_createVAO(e,i){const a=this._createDataBuffer(i);return this._dirty=!1,new wh(e,Mr,{data:bh(xr)},{data:Zh.createVertex(e,kh.STATIC_DRAW,a)})}_ensureVertexData(e,i){if(!this._dirty)return;const a=this._createDataBuffer(i);e.vertexBuffers.data.setData(a),this._dirty=!1}_numberOfRenderVertices(e){return 3*(2*(e.length/3-1))}_createDataBuffer(e){const i=e.reduce((o,l)=>o+this._numberOfRenderVertices(l),0);this._count=i;const a=xr.createBuffer(i),s=this._origin;let n=0,r=0;for(const o of e){for(let l=0;l<o.length;l+=3){const p=U(wr,o[l+0],o[l+1],o[l+2]);l===0?r=this._renderCoordsHelper.getAltitude(p):this._renderCoordsHelper.setAltitude(p,r);const u=this._renderCoordsHelper.worldUpAtPosition(p,Vc),d=n+2*l,_=D(wr,p,s);if(l<o.length-3){a.up.setVec(d,u),a.up.setVec(d+3,u),a.up.setVec(d+5,u);for(let f=0;f<6;f++)a.start.setVec(d+f,_);a.extrude.setValues(d+0,0,-1),a.extrude.setValues(d+1,1,-1),a.extrude.setValues(d+2,1,1),a.extrude.setValues(d+3,0,-1),a.extrude.setValues(d+4,1,1),a.extrude.setValues(d+5,0,1)}if(l>0){a.up.setVec(d-2,u),a.up.setVec(d-4,u),a.up.setVec(d-5,u);for(let f=-6;f<0;f++)a.end.setVec(d+f,_)}}n+=this._numberOfRenderVertices(o)}return a.buffer}}const Vc=b(),wr=b(),xr=Zn().vec3f(O.START).vec3f(O.END).vec3f(O.UP).vec2f(O.EXTRUDE);class As extends xh{constructor(){super(...arguments),this.contrastControlEnabled=!1}}c([k()],As.prototype,"contrastControlEnabled",void 0);const Er=tt(6);function zc(t){const e=new Di;e.extensions.add("GL_OES_standard_derivatives"),e.include(Eh),e.include(br,t);const i=e.fragment;if(t.lineVerticalPlaneEnabled||t.heightManifoldEnabled)if(i.uniforms.add(new pe("maxPixelDistance",(a,s)=>t.heightManifoldEnabled?2*s.camera.computeScreenPixelSizeAt(a.heightManifoldTarget):2*s.camera.computeScreenPixelSizeAt(a.lineVerticalPlaneSegment.origin))),i.code.add(R`float planeDistancePixels(vec4 plane, vec3 pos) {
float dist = dot(plane.xyz, pos) + plane.w;
float width = fwidth(dist);
dist /= min(width, maxPixelDistance);
return abs(dist);
}`),t.spherical){const a=(n,r,o)=>me(n,r.heightManifoldTarget,o.camera.viewMatrix),s=(n,r)=>me(n,[0,0,0],r.camera.viewMatrix);i.uniforms.add([new yt("heightManifoldOrigin",(n,r)=>(a(Qe,n,r),s(ii,r),D(ii,ii,Qe),ie(Ee,ii),Ee[3]=fe(ii),Ee)),new nt("globalOrigin",(n,r)=>s(Qe,r)),new pe("cosSphericalAngleThreshold",(n,r)=>1-Math.max(2,sa(r.camera.eye,n.heightManifoldTarget)*r.camera.perRenderPixelRatio)/fe(n.heightManifoldTarget))]),i.code.add(R`float globeDistancePixels(float posInGlobalOriginLength) {
float dist = abs(posInGlobalOriginLength - heightManifoldOrigin.w);
float width = fwidth(dist);
dist /= min(width, maxPixelDistance);
return abs(dist);
}
float heightManifoldDistancePixels(vec4 heightPlane, vec3 pos) {
vec3 posInGlobalOriginNorm = normalize(globalOrigin - pos);
float cosAngle = dot(posInGlobalOriginNorm, heightManifoldOrigin.xyz);
vec3 posInGlobalOrigin = globalOrigin - pos;
float posInGlobalOriginLength = length(posInGlobalOrigin);
float sphericalDistance = globeDistancePixels(posInGlobalOriginLength);
float planarDistance = planeDistancePixels(heightPlane, pos);
return cosAngle < cosSphericalAngleThreshold ? sphericalDistance : planarDistance;
}`)}else i.code.add(R`float heightManifoldDistancePixels(vec4 heightPlane, vec3 pos) {
return planeDistancePixels(heightPlane, pos);
}`);if(t.pointDistanceEnabled&&(i.uniforms.add(new pe("maxPixelDistance",(a,s)=>2*s.camera.computeScreenPixelSizeAt(a.pointDistanceTarget))),i.code.add(R`float sphereDistancePixels(vec4 sphere, vec3 pos) {
float dist = distance(sphere.xyz, pos) - sphere.w;
float width = fwidth(dist);
dist /= min(width, maxPixelDistance);
return abs(dist);
}`)),t.intersectsLineEnabled&&(i.uniforms.add(new pe("perScreenPixelRatio",(a,s)=>s.camera.perScreenPixelRatio)),i.code.add(R`float lineDistancePixels(vec3 start, vec3 dir, float radius, vec3 pos) {
float dist = length(cross(dir, pos - start)) / (length(pos) * perScreenPixelRatio);
return abs(dist) - radius;
}`)),(t.lineVerticalPlaneEnabled||t.intersectsLineEnabled)&&i.code.add(R`bool pointIsWithinLine(vec3 pos, vec3 start, vec3 end) {
vec3 dir = end - start;
float t2 = dot(dir, pos - start);
float l2 = dot(dir, dir);
return t2 >= 0.0 && t2 <= l2;
}`),i.code.add(R`void main() {
vec3 pos;
vec3 normal;
float depthDiscontinuityAlpha;
if (!laserlineReconstructFromDepth(pos, normal, depthDiscontinuityAlpha)) {
discard;
}
vec4 color = vec4(0, 0, 0, 0);`),t.heightManifoldEnabled){i.uniforms.add([new It("angleCutoff",s=>Oa(s)),new yt("heightPlane",(s,n)=>Or(s.heightManifoldTarget,s.renderCoordsHelper.worldUpAtPosition(s.heightManifoldTarget,Qe),n.camera.viewMatrix))]);const a=t.spherical?R`normalize(globalOrigin - pos)`:R`heightPlane.xyz`;i.code.add(R`
    {
      float heightManifoldAlpha = 1.0 - smoothstep(angleCutoff.x, angleCutoff.y, abs(dot(normal, ${a})));
      vec4 heightManifoldColor = laserlineProfile(heightManifoldDistancePixels(heightPlane, pos));
      color = max(color, heightManifoldColor * heightManifoldAlpha);
    }
    `)}return t.pointDistanceEnabled&&(i.uniforms.add([new It("angleCutoff",a=>Oa(a)),new yt("pointDistanceSphere",(a,s)=>Nc(a,s))]),i.code.add(R`{
float pointDistanceSphereDistance = sphereDistancePixels(pointDistanceSphere, pos);
vec4 pointDistanceSphereColor = laserlineProfile(pointDistanceSphereDistance);
float pointDistanceSphereAlpha = 1.0 - smoothstep(angleCutoff.x, angleCutoff.y, abs(dot(normal, normalize(pos - pointDistanceSphere.xyz))));
color = max(color, pointDistanceSphereColor * pointDistanceSphereAlpha);
}`)),t.lineVerticalPlaneEnabled&&(i.uniforms.add([new It("angleCutoff",a=>Oa(a)),new yt("lineVerticalPlane",(a,s)=>Fc(a,s)),new nt("lineVerticalStart",(a,s)=>Hc(a,s)),new nt("lineVerticalEnd",(a,s)=>kc(a,s))]),i.code.add(R`{
if (pointIsWithinLine(pos, lineVerticalStart, lineVerticalEnd)) {
float lineVerticalDistance = planeDistancePixels(lineVerticalPlane, pos);
vec4 lineVerticalColor = laserlineProfile(lineVerticalDistance);
float lineVerticalAlpha = 1.0 - smoothstep(angleCutoff.x, angleCutoff.y, abs(dot(normal, lineVerticalPlane.xyz)));
color = max(color, lineVerticalColor * lineVerticalAlpha);
}
}`)),t.intersectsLineEnabled&&(i.uniforms.add([new It("angleCutoff",a=>Oa(a)),new nt("intersectsLineStart",(a,s)=>me(Qe,a.lineStartWorld,s.camera.viewMatrix)),new nt("intersectsLineEnd",(a,s)=>me(Qe,a.lineEndWorld,s.camera.viewMatrix)),new nt("intersectsLineDirection",(a,s)=>(B(Ee,a.intersectsLineSegment.vector),Ee[3]=0,ie(Qe,Ks(Ee,Ee,s.camera.viewMatrix)))),new pe("intersectsLineRadius",a=>a.intersectsLineRadius)]),i.code.add(R`{
if (pointIsWithinLine(pos, intersectsLineStart, intersectsLineEnd)) {
float intersectsLineDistance = lineDistancePixels(intersectsLineStart, intersectsLineDirection, intersectsLineRadius, pos);
vec4 intersectsLineColor = laserlineProfile(intersectsLineDistance);
float intersectsLineAlpha = 1.0 - smoothstep(angleCutoff.x, angleCutoff.y, 1.0 - abs(dot(normal, intersectsLineDirection)));
color = max(color, intersectsLineColor * intersectsLineAlpha);
}
}`)),i.code.add(R`gl_FragColor = laserlineOutput(color * depthDiscontinuityAlpha);
}`),e}function Oa(t){return re(jc,Math.cos(t.angleCutoff),Math.cos(Math.max(0,t.angleCutoff-tt(2))))}function Nc(t,e){return me(Ts,t.pointDistanceOrigin,e.camera.viewMatrix),Ts[3]=sa(t.pointDistanceOrigin,t.pointDistanceTarget),Ts}function Fc(t,e){const i=Lt(t.lineVerticalPlaneSegment,.5,Qe),a=t.renderCoordsHelper.worldUpAtPosition(i,Uc),s=ie(ii,t.lineVerticalPlaneSegment.vector),n=we(Ee,a,s);return ie(n,n),Or(t.lineVerticalPlaneSegment.origin,n,e.camera.viewMatrix)}function Hc(t,e){const i=B(Qe,t.lineVerticalPlaneSegment.origin);return t.renderCoordsHelper.setAltitude(i,0),me(i,i,e.camera.viewMatrix)}function kc(t,e){const i=H(Qe,t.lineVerticalPlaneSegment.origin,t.lineVerticalPlaneSegment.vector);return t.renderCoordsHelper.setAltitude(i,0),me(i,i,e.camera.viewMatrix)}function Or(t,e,i){return me(Ar,t,i),B(Ee,e),Ee[3]=0,Ks(Ee,Ee,i),Tt(Ar,Ee,Bc)}const jc=At(),Qe=b(),Ee=en(),Uc=b(),ii=b(),Ar=b(),Bc=Wt(),Ts=Jo(),Xc=Object.freeze(Object.defineProperty({__proto__:null,defaultAngleCutoff:Er,build:zc},Symbol.toStringTag,{value:"Module"}));class Yc extends Oh{constructor(){super(...arguments),this.innerColor=N(1,1,1),this.innerWidth=1,this.glowColor=N(1,.5,0),this.glowWidth=8,this.glowFalloff=8,this.globalAlpha=.75,this.globalAlphaContrastBoost=2,this.angleCutoff=tt(6),this.pointDistanceOrigin=b(),this.pointDistanceTarget=b(),this.lineVerticalPlaneSegment=Pi(),this.intersectsLineSegment=Pi(),this.intersectsLineRadius=3,this.heightManifoldTarget=b(),this.lineStartWorld=b(),this.lineEndWorld=b()}}class Aa extends Ci{initializeProgram(e){return new Li(e.rctx,Aa.shader.get().build(this.configuration),_s)}initializePipeline(){return Ii({blending:vs(Ye.ONE,Ye.ONE_MINUS_SRC_ALPHA),colorWrite:Gi})}}Aa.shader=new $i(Xc,()=>import("./Laserlines.glsl.838f0860.js"));class ai extends As{constructor(){super(...arguments),this.heightManifoldEnabled=!1,this.pointDistanceEnabled=!1,this.lineVerticalPlaneEnabled=!1,this.intersectsLineEnabled=!1,this.spherical=!1}}c([k()],ai.prototype,"heightManifoldEnabled",void 0),c([k()],ai.prototype,"pointDistanceEnabled",void 0),c([k()],ai.prototype,"lineVerticalPlaneEnabled",void 0),c([k()],ai.prototype,"intersectsLineEnabled",void 0),c([k()],ai.prototype,"spherical",void 0);class Wc{constructor(e,i={contrastControlEnabled:!1}){this._config=i,this._technique=null,this._heightManifoldEnabled=!1,this._pointDistanceEnabled=!1,this._lineVerticalPlaneEnabled=!1,this._intersectsLineEnabled=!1,this._intersectsLineInfinite=!1,this._viewingMode=mi.Local,this._pathVerticalPlaneEnabled=!1,this._pathVerticalPlaneData=null,this._pathTechnique=null,this.canRender=!0,this._passParameters=Ah(e,new Yc)}get renderSlots(){return[this._config.contrastControlEnabled?Te.LASERLINES_CONTRAST_CONTROL:Te.LASERLINES]}get needsLinearDepth(){return!0}get heightManifoldEnabled(){return this._heightManifoldEnabled}set heightManifoldEnabled(e){this._heightManifoldEnabled!==e&&(this._heightManifoldEnabled=e,this._requestRender())}get heightManifoldTarget(){return this._passParameters.heightManifoldTarget}set heightManifoldTarget(e){B(this._passParameters.heightManifoldTarget,e),this._requestRender()}get pointDistanceEnabled(){return this._pointDistanceEnabled}set pointDistanceEnabled(e){e!==this._pointDistanceEnabled&&(this._pointDistanceEnabled=e,this._requestRender())}get pointDistanceTarget(){return this._passParameters.pointDistanceTarget}set pointDistanceTarget(e){B(this._passParameters.pointDistanceTarget,e),this._requestRender()}get pointDistanceOrigin(){return this._passParameters.pointDistanceOrigin}set pointDistanceOrigin(e){B(this._passParameters.pointDistanceOrigin,e),this._requestRender()}get lineVerticalPlaneEnabled(){return this._lineVerticalPlaneEnabled}set lineVerticalPlaneEnabled(e){e!==this._lineVerticalPlaneEnabled&&(this._lineVerticalPlaneEnabled=e,this._requestRender())}get lineVerticalPlaneSegment(){return this._passParameters.lineVerticalPlaneSegment}set lineVerticalPlaneSegment(e){ya(e,this._passParameters.lineVerticalPlaneSegment),this._requestRender()}get intersectsLineEnabled(){return this._intersectsLineEnabled}set intersectsLineEnabled(e){e!==this._intersectsLineEnabled&&(this._intersectsLineEnabled=e,this._requestRender())}get intersectsLineSegment(){return this._passParameters.intersectsLineSegment}set intersectsLineSegment(e){ya(e,this._passParameters.intersectsLineSegment),this._requestRender()}get intersectsLineRadius(){return this._passParameters.intersectsLineRadius}set intersectsLineRadius(e){e!==this._passParameters.intersectsLineRadius&&(this._passParameters.intersectsLineRadius=e,this._requestRender())}get intersectsLineInfinite(){return this._intersectsLineInfinite}set intersectsLineInfinite(e){e!==this._intersectsLineInfinite&&(this._intersectsLineInfinite=e,this._requestRender())}get viewingMode(){return this._viewingMode}set viewingMode(e){e!==this._viewingMode&&(this._viewingMode=e,this._requestRender())}get pathVerticalPlaneEnabled(){return this._pathVerticalPlaneEnabled}set pathVerticalPlaneEnabled(e){e!==this._pathVerticalPlaneEnabled&&(this._pathVerticalPlaneEnabled=e,h(this._pathVerticalPlaneData)&&this._requestRender())}set pathVerticalPlaneVertices(e){m(this._pathVerticalPlaneData)&&(this._pathVerticalPlaneData=new Sr(this._passParameters.renderCoordsHelper)),this._pathVerticalPlaneData.vertices=e,this.pathVerticalPlaneEnabled&&this._requestRender()}set pathVerticalPlaneBuffers(e){m(this._pathVerticalPlaneData)&&(this._pathVerticalPlaneData=new Sr(this._passParameters.renderCoordsHelper)),this._pathVerticalPlaneData.buffers=e,this.pathVerticalPlaneEnabled&&this._requestRender()}setParameters(e){Th(this._passParameters,e)&&this._requestRender()}initializeRenderContext(e){this._context=e;const i=e.renderContext.rctx;this._quadVAO=Ph(i),this._techniqueRepository=e.shaderTechniqueRepository,this._techniqueConfig=new ai;const a=new As;a.contrastControlEnabled=this._config.contrastControlEnabled,this._pathTechnique=this._techniqueRepository.acquire(Ea,a)}uninitializeRenderContext(){this._quadVAO=tn(this._quadVAO),this._technique=an(this._technique),this._pathVerticalPlaneData=tn(this._pathVerticalPlaneData),this._pathTechnique=an(this._pathTechnique)}prepareTechnique(){return this.heightManifoldEnabled||this.pointDistanceEnabled||this.lineVerticalPlaneSegment||this.intersectsLineEnabled?(this._techniqueConfig.heightManifoldEnabled=this.heightManifoldEnabled,this._techniqueConfig.lineVerticalPlaneEnabled=this.lineVerticalPlaneEnabled,this._techniqueConfig.pointDistanceEnabled=this.pointDistanceEnabled,this._techniqueConfig.intersectsLineEnabled=this.intersectsLineEnabled,this._techniqueConfig.contrastControlEnabled=this._config.contrastControlEnabled,this._techniqueConfig.spherical=this._viewingMode===mi.Global,this._technique=this._techniqueRepository.releaseAndAcquire(Aa,this._techniqueConfig,this._technique),this._technique):this._pathTechnique}render(e,i){(this.heightManifoldEnabled||this.pointDistanceEnabled||this.lineVerticalPlaneSegment||this.intersectsLineEnabled)&&this._renderUnified(e,i),this.pathVerticalPlaneEnabled&&this._renderPath(e)}_renderUnified(e,i){const a=e.rctx;this._updatePassParameters(e),a.bindTechnique(i,this._passParameters,e.bindParameters),a.bindVAO(this._quadVAO),a.drawArrays(or.TRIANGLE_STRIP,0,4)}_renderPath(e){if(m(this._pathVerticalPlaneData)||m(this._pathTechnique))return;const i=e.rctx,a=this._pathTechnique;i.bindTechnique(a,z(L({},this._passParameters),{origin:this._pathVerticalPlaneData.origin}),e.bindParameters),this._pathVerticalPlaneData.draw(e.rctx)}_updatePassParameters(e){if(!this._intersectsLineEnabled)return;const i=e.bindParameters.camera;if(this._intersectsLineInfinite){if(Bn(Ja(this._passParameters.intersectsLineSegment.origin,this._passParameters.intersectsLineSegment.vector),ji),ji.c0=-Number.MAX_VALUE,!Xn(i.frustum,ji))return;Yn(ji,this._passParameters.lineStartWorld),Wn(ji,this._passParameters.lineEndWorld)}else B(this._passParameters.lineStartWorld,this._passParameters.intersectsLineSegment.origin),H(this._passParameters.lineEndWorld,this._passParameters.intersectsLineSegment.origin,this._passParameters.intersectsLineSegment.vector)}_requestRender(){this._context&&this._context.requestRender()}}const ji=Un();class Ui extends yr{constructor(e){super(e.view),this._angleCutoff=Er,this._style={},this._heightManifoldTarget=b(),this._heightManifoldEnabled=!1,this._intersectsLine=Pi(),this._intersectsLineEnabled=!1,this._intersectsLineInfinite=!1,this._lineVerticalPlaneSegment=null,this._pathVerticalPlaneBuffers=null,this._pointDistanceLine=null,this.applyProps(e)}get testData(){return this._renderer}createResources(){this._ensureRenderer()}destroyResources(){this._disposeRenderer()}updateVisibility(){this._syncRenderer(),this._syncHeightManifold(),this._syncIntersectsLine(),this._syncPathVerticalPlane(),this._syncLineVerticalPlane(),this._syncPointDistance()}get angleCutoff(){return this._angleCutoff}set angleCutoff(e){this._angleCutoff!==e&&(this._angleCutoff=e,this._syncAngleCutoff())}get style(){return this._style}set style(e){this._style=e,this._syncStyle()}get heightManifoldTarget(){return this._heightManifoldEnabled?this._heightManifoldTarget:null}set heightManifoldTarget(e){h(e)?(B(this._heightManifoldTarget,e),this._heightManifoldEnabled=!0):this._heightManifoldEnabled=!1,this._syncRenderer(),this._syncHeightManifold()}set intersectsWorldUpAtLocation(e){if(m(e))return void(this.intersectsLine=null);const i=this.view.renderCoordsHelper.worldUpAtPosition(e,Zc);this.intersectsLine=fh(e,i),this.intersectsLineInfinite=!0}get intersectsLine(){return this._intersectsLineEnabled?this._intersectsLine:null}set intersectsLine(e){h(e)?(ya(e,this._intersectsLine),this._intersectsLineEnabled=!0):this._intersectsLineEnabled=!1,this._syncIntersectsLine(),this._syncRenderer()}get intersectsLineInfinite(){return this._intersectsLineInfinite}set intersectsLineInfinite(e){this._intersectsLineInfinite=e,this._syncIntersectsLineInfinite()}get lineVerticalPlaneSegment(){return this._lineVerticalPlaneSegment}set lineVerticalPlaneSegment(e){this._lineVerticalPlaneSegment=h(e)?ya(e):null,this._syncLineVerticalPlane(),this._syncRenderer()}get pathVerticalPlane(){return this._pathVerticalPlaneBuffers}set pathVerticalPlane(e){this._pathVerticalPlaneBuffers=e,this._syncPathVerticalPlane(),this._syncLineVerticalPlane(),this._syncPointDistance(),this._syncRenderer()}get pointDistanceLine(){return this._pointDistanceLine}set pointDistanceLine(e){this._pointDistanceLine=h(e)?{origin:na(e.origin),target:na(e.target)}:null,this._syncPointDistance(),this._syncRenderer()}_syncRenderer(){this.attached&&this.visible&&(this._intersectsLineEnabled||this._heightManifoldEnabled||h(this._pointDistanceLine)||h(this._pathVerticalPlaneBuffers))?this._ensureRenderer():this._disposeRenderer()}_ensureRenderer(){h(this._renderer)||(this._renderer=new Wc({renderCoordsHelper:this.view.renderCoordsHelper},{contrastControlEnabled:!0}),this._renderer.viewingMode=this.view.state.viewingMode,this._syncStyle(),this._syncHeightManifold(),this._syncIntersectsLine(),this._syncIntersectsLineInfinite(),this._syncPathVerticalPlane(),this._syncLineVerticalPlane(),this._syncPointDistance(),this._syncAngleCutoff(),this.view._stage&&this.view._stage.addRenderPlugin(this._renderer.renderSlots,this._renderer))}_syncStyle(){m(this._renderer)||(this._renderer.setParameters(this._style),this._style.intersectsLineRadius!=null&&(this._renderer.intersectsLineRadius=this._style.intersectsLineRadius))}_syncAngleCutoff(){m(this._renderer)||this._renderer.setParameters({angleCutoff:this._angleCutoff})}_syncHeightManifold(){m(this._renderer)||(this._renderer.heightManifoldEnabled=this._heightManifoldEnabled&&this.visible,this._heightManifoldEnabled&&(this._renderer.heightManifoldTarget=this._heightManifoldTarget))}_syncIntersectsLine(){m(this._renderer)||(this._renderer.intersectsLineEnabled=this._intersectsLineEnabled&&this.visible,this._intersectsLineEnabled&&(this._renderer.intersectsLineSegment=this._intersectsLine))}_syncIntersectsLineInfinite(){m(this._renderer)||(this._renderer.intersectsLineInfinite=this._intersectsLineInfinite)}_syncPathVerticalPlane(){m(this._renderer)||(this._renderer.pathVerticalPlaneEnabled=h(this._pathVerticalPlaneBuffers)&&this.visible,h(this._pathVerticalPlaneBuffers)&&(this._renderer.pathVerticalPlaneBuffers=this._pathVerticalPlaneBuffers))}_syncLineVerticalPlane(){m(this._renderer)||(this._renderer.lineVerticalPlaneEnabled=h(this._lineVerticalPlaneSegment)&&this.visible,h(this._lineVerticalPlaneSegment)&&(this._renderer.lineVerticalPlaneSegment=this._lineVerticalPlaneSegment))}_syncPointDistance(){m(this._renderer)||(this._renderer.pointDistanceEnabled=h(this._pointDistanceLine)&&this.visible,h(this._pointDistanceLine)&&(this._renderer.pointDistanceOrigin=this._pointDistanceLine.origin,this._renderer.pointDistanceTarget=this._pointDistanceLine.target))}_disposeRenderer(){h(this._renderer)&&this.view._stage&&(this.view._stage.removeRenderPlugin(this._renderer),this._renderer=null)}}const Zc=b();class Ta extends yr{constructor(e){super(e.view),this._resources=null,this._transform=_e()}get object(){return h(this._resources)?this._resources.object:null}get transform(){return this._transform}set transform(e){sn(this._transform,e),h(this._resources)&&(this._resources.object.transformation=this._transform)}recreate(){this.attached&&this.createResources()}recreateGeometry(){if(m(this._resources))return;const e=this._resources.object,i=this.view._stage;i.removeMany(e.geometries),e.removeAllGeometries(),this.createGeometries(e),this.visible||e.setVisible(this.visible),i.addMany(e.geometries)}createResources(){this.destroyResources();const e=this.view._stage;if(!e)return;const i=new ys({isPickable:!1,updatePolicy:Ma.SYNC});e.add(i);const a=new bs({castShadow:!1});a.transformation=this._transform,this.createExternalResources(),this.createGeometries(a),e.addMany(a.geometries),this.forEachExternalMaterial(s=>e.add(s)),e.add(a),i.add(a),this.visible||a.setVisible(!1),this._resources={layer:i,object:a}}destroyResources(){const e=this.view._stage;!m(this._resources)&&e&&(e.remove(this._resources.object),e.remove(this._resources.layer),this.forEachExternalMaterial(i=>{e.remove(i),i.dispose()}),e.removeMany(this._resources.object.geometries),this._resources.object.dispose(),this.destroyExternalResources(),this._resources=null)}updateVisibility(e){m(this._resources)||this._resources.object.setVisible(e)}}class Pa extends Ta{constructor(e){super(e),this._ray=fi(),this._externalResources=null,this._handles=new it,this._isWorldDown=!1,this._start=b(),this._end=N(1,0,0),this._width=1,this._color=Ct(1,0,1,1),this._polygonOffset=!1,this._writeDepthEnabled=!0,this._innerWidth=0,this._innerColor=Ct(1,1,1,1),this._stipplePattern=null,this._stippleOffColor=null,this._stipplePreferContinuous=!0,this._falloff=0,this._extensionType=Oe.LINE,this._laserlineStyle=null,this._laserlineEnabled=!1,this._renderOccluded=$.OccludeAndTransparent,this._fadedExtensions=Rr,this.applyProps(e)}createExternalResources(){const e=new Gt(this.materialParameters);this._handles.add(I(()=>this.view.state.camera,()=>{this._updateGeometry()}));const i=new Ui({view:this.view,attached:this._laserlineEnabled});this._externalResources={material:e,laserline:i}}destroyExternalResources(){h(this._externalResources)&&this._externalResources.laserline.destroy(),this._externalResources=null,this._handles.removeAll()}forEachExternalMaterial(e){h(this._externalResources)&&e(this._externalResources.material)}createGeometries(e){const i=[b(),b()],a=this.extensionType===Oe.FADED;a&&i.push(b(),b());const s=a?new Float32Array([1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,0]):null,n=rt(i,null,s);e.addGeometry(n,C(this._externalResources).material),this._updateVertices(e)}updateVisibility(e){super.updateVisibility(e),h(this._externalResources)&&(this._externalResources.laserline.visible=e)}setStartEndFromWorldDownAtLocation(e){this._isWorldDown=!0,B(this._start,e),this.view.renderCoordsHelper.worldUpAtPosition(e,this._end),D(this._end,e,this._end),Ka(this._start,this._end,this._ray),this._updateGeometry()}get start(){return this._start}set start(e){this._isWorldDown=!1,Zt(this._start,e)||(B(this._start,e),Ka(this._start,this._end,this._ray),this._updateGeometry())}get end(){return this._end}set end(e){this._isWorldDown=!1,Zt(this._end,e)||(B(this._end,e),Ka(this._start,this._end,this._ray),this._updateGeometry())}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this._updateMaterial())}get color(){return this._color}set color(e){$e(e,this._color)||(Ce(this._color,e),this._updateMaterial())}get polygonOffset(){return this._polygonOffset}set polygonOffset(e){e!==this._polygonOffset&&(this._polygonOffset=e,this._updateMaterial())}get writeDepthEnabled(){return this._writeDepthEnabled}set writeDepthEnabled(e){this._writeDepthEnabled!==e&&(this._writeDepthEnabled=e,this._updateMaterial())}get innerWidth(){return this._innerWidth}set innerWidth(e){e!==this._innerWidth&&(this._innerWidth=e,this._updateMaterial())}get innerColor(){return this._innerColor}set innerColor(e){$e(e,this._innerColor)||(Ce(this._innerColor,e),this._updateMaterial())}get stipplePattern(){return this._stipplePattern}set stipplePattern(e){const i=h(e)!==h(this._stipplePattern);this._stipplePattern=e,i?this.recreate():this._updateMaterial()}get stippleOffColor(){return this._stippleOffColor}set stippleOffColor(e){(m(e)||m(this._stippleOffColor)||!$e(e,this._stippleOffColor))&&(this._stippleOffColor=h(e)?jn(e):null,this._updateMaterial())}get stipplePreferContinuous(){return this._stipplePreferContinuous}set stipplePreferContinuous(e){e!==this._stipplePreferContinuous&&(this._stipplePreferContinuous=e,this._updateMaterial())}get falloff(){return this._falloff}set falloff(e){e!==this._falloff&&(this._falloff=e,this._updateMaterial())}get extensionType(){return this._extensionType}set extensionType(e){e!==this._extensionType&&(this._extensionType=e,this._updateGeometry())}get _laserlineAttached(){return this._laserlineEnabled&&h(this._laserlineStyle)}get laserlineStyle(){return this._laserlineStyle}set laserlineStyle(e){this._laserlineStyle=e,h(this._externalResources)&&(this._externalResources.laserline.attached=this._laserlineAttached,h(e)&&(this._externalResources.laserline.style=e))}get laserlineEnabled(){return this._laserlineEnabled}set laserlineEnabled(e){this._laserlineEnabled!==e&&(this._laserlineEnabled=e,h(this._externalResources)&&(this._externalResources.laserline.attached=this._laserlineAttached))}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}get fadedExtensions(){return this._fadedExtensions}set fadedExtensions(e){this._fadedExtensions=K(e,Rr),this.recreateGeometry()}_updateMaterial(){m(this._externalResources)||this._externalResources.material.setParameters(this.materialParameters)}get materialParameters(){return{width:this._width,color:this._color,stippleOffColor:this._stippleOffColor,stipplePattern:this._stipplePattern,stipplePreferContinuous:this._stipplePreferContinuous,innerWidth:this._innerWidth,innerColor:this._innerColor,falloff:this._falloff,hasPolygonOffset:this._polygonOffset,renderOccluded:this._renderOccluded,writeDepth:this._writeDepthEnabled}}_updateGeometry(){h(this.object)&&this._updateVertices(this.object)}_updateVertices(e){const i=this._extensionType===Oe.FADED?this._updateLineSegmentFinite(Tr):this._updateLineSegmentInfinite(this._extensionType,Tr);this._updateVertexAttributes(e,i),h(this._externalResources)&&(this._externalResources.laserline.intersectsLine=i)}_updateLineSegmentFinite(e){return Ri(this._start,this._end,e)}_updateLineSegmentInfinite(e,i){const a=this.view.state.camera;switch(Bn(this._ray,bt),e){case Oe.LINE:bt.c0=-Number.MAX_VALUE;break;case Oe.RAY:case Oe.GROUND_RAY:{const r=this._ray.origin,o=K(this.view.elevationProvider.getElevation(r[0],r[1],r[2],this.view.renderCoordsHelper.spatialReference,"ground"),0),l=this.view.renderCoordsHelper.getAltitude(r);this._isWorldDown&&l<o&&Ko(bt.ray.direction,bt.ray.direction),this._extensionType===Oe.GROUND_RAY&&o!=null&&(bt.c1=Math.abs(l-o));break}}if(!Xn(a.frustum,bt))return Ri(this._start,this._end,i);const s=Yn(bt,Vt),n=Wn(bt,qc);return Ri(s,n,i)}_updateVertexAttributes(e,i){const a=e.geometries[0].getMutableAttribute(O.POSITION).data;if(this.extensionType===Oe.FADED){const s=Lt(i,-this.fadedExtensions.start,Vt);a[0]=s[0],a[1]=s[1],a[2]=s[2];const n=Lt(i,0,Vt);a[3]=n[0],a[4]=n[1],a[5]=n[2];const r=Lt(i,1,Vt);a[6]=r[0],a[7]=r[1],a[8]=r[2];const o=Lt(i,1+this.fadedExtensions.end,Vt);a[9]=o[0],a[10]=o[1],a[11]=o[2]}else{const s=Lt(i,0,Vt);a[0]=s[0],a[1]=s[1],a[2]=s[2];const n=Lt(i,1,Vt);a[3]=n[0],a[4]=n[1],a[5]=n[2]}e.geometryVertexAttrsUpdated(e.geometryRecords[0])}}const bt=Un(),Vt=b(),qc=b(),Tr=Pi();var Oe;(function(t){t[t.LINE=0]="LINE",t[t.RAY=1]="RAY",t[t.GROUND_RAY=2]="GROUND_RAY",t[t.FADED=3]="FADED"})(Oe||(Oe={}));const Pr=1/3,Rr={start:Pr,end:Pr};class Qc extends Ta{constructor(e){super(e),this._handles=new it,this._location=b(),this._direction=N(1,0,0),this._width=1,this._offset=1,this._length=18,this._color=Ct(1,0,1,1),this._renderOccluded=$.OccludeAndTransparent,this.applyProps(e)}get location(){return this._location}set location(e){Zt(this._location,e)||(B(this._location,e),this._updateGeometry())}get direction(){return this._direction}set direction(e){Zt(this._direction,e)||(B(this._direction,e),this._updateGeometry())}setDirectionFromPoints(e,i){ie(this._direction,D(this._direction,i,e)),this._updateGeometry()}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this._updateMaterial())}get offset(){return this._offset}set offset(e){e!==this._offset&&(this._offset=e,this._updateGeometry())}get length(){return this._length}set length(e){e!==this._length&&(this._length=e,this._updateGeometry())}get color(){return this._color}set color(e){$e(e,this._color)||(Ce(this._color,e),this._updateMaterial())}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}createExternalResources(){const e=new Gt(this.materialParameters);this._handles.add(I(()=>this.view.state.camera,()=>{this._updateGeometry()})),this._externalResources={material:e}}destroyExternalResources(){this._handles.removeAll(),this._externalResources=null}createGeometries(e){const i=rt([b(),b()]),a=rt([b(),b()]),s=C(this._externalResources).material;e.addGeometry(i,s),e.addGeometry(a,s),this._updateVertices(e)}forEachExternalMaterial(e){h(this._externalResources)&&e(this._externalResources.material)}_updateMaterial(){m(this._externalResources)||this._externalResources.material.setParameters(this.materialParameters)}get materialParameters(){return{width:this._width,color:this._color,renderOccluded:this._renderOccluded}}_updateGeometry(){const e=this.object;m(e)||this._updateVertices(e)}_updateVertices(e){const i=this.view.state.camera;i.projectToScreen(this.location,Ra),H(Je,this.location,this.direction),i.projectToScreen(Je,si),ia(si,es(si,si,Ra)),this._updateVertexAttributes(i,e,0,Ra,si,1),this._updateVertexAttributes(i,e,1,Ra,si,-1)}_updateVertexAttributes(e,i,a,s,n,r){const o=i.geometryRecords[a],l=o.geometry.getMutableAttribute(O.POSITION).data,p=Yt(Dr,re(Dr,n[1]*r,n[0]*-r),this.offset+this.width/2),u=_t(Da,_t(Da,_t(Da,s,Yt(Da,n,this.length/2)),p),p),d=_t($r,u,Yt($r,n,-this.length));e.unprojectFromScreen(u,Je),l[0]=Je[0],l[1]=Je[1],l[2]=Je[2],e.unprojectFromScreen(d,Je),l[3]=Je[0],l[4]=Je[1],l[5]=Je[2],i.geometryVertexAttrsUpdated(o)}}const Je=b(),Ra=Se(),si=Se(),Dr=Se(),Da=Se(),$r=Se();class Cr{constructor(e){this._resourceFactory=e,this._resources=null,this._visible=!0,this._attached=!1}destroy(){this._destroyResources()}get object(){return h(this._resources)?this._resources.object:null}get resources(){return h(this._resources)?this._resources.external:null}get visible(){return this._visible}set visible(e){e!==this._visible&&(this._visible=e,this._syncVisible())}get attached(){return this._attached}set attached(e){e!==this._attached&&(this._attached=e,this._createOrDestroyResources())}recreate(){this.attached&&this._createResources()}recreateGeometry(){if(!this._resourceFactory.recreateGeometry)return void this.recreate();const e=this._resourceFactory.view._stage;if(m(this._resources)||!e)return;const i=this._resources.object;this._resources.external.forEach(s=>{s.type===Rh.Geometry&&e.remove(s)}),i.removeAllGeometries();const a=this._resourceFactory.recreateGeometry(this._resources.external,i,this._resources.layer);e.addMany(a)}_createOrDestroyResources(){this._attached?this._resources||this._createResources():this._destroyResources()}_createResources(){this._destroyResources();const e=this._resourceFactory,i=e.view,a=i._stage;if(!a)return;const s=new ys({isPickable:!1,updatePolicy:Ma.SYNC});a.add(s);const n=new bs({castShadow:!1}),r=e.createResources(n,s);r.forEach(l=>{a.add(l),l instanceof Qn&&a.loadImmediate(l)}),a.add(n),s.add(n);const o=e.cameraChanged?I(()=>i.state.camera,l=>e.cameraChanged(l),Ue):null;this._resources={layer:s,object:n,external:r,cameraHandle:o},this._syncVisible()}_destroyResources(){if(m(this._resources))return;const e=this._resourceFactory.view._stage;e==null||e.remove(this._resources.object),e==null||e.remove(this._resources.layer),this._resources.external.forEach(i=>{e==null||e.remove(i),"dispose"in i&&i.dispose()}),this._resources.object.dispose(),this._resources.cameraHandle&&this._resources.cameraHandle.remove(),this._resources=null}_syncVisible(){m(this._resources)||this._resources.object.setVisible(this._visible)}}class Ps{constructor(e){this.view=null,this._geometry=null,this._size=3,this._color=Be(1,0,1,1),this._pixelSnappingEnabled=!0,this._primitive="square",this._outlineSize=1,this._outlineColor=Be(1,1,1,1),this._elevationInfo=null,this._resources=new Cr({view:e.view,createResources:a=>this._createResources(a),recreateGeometry:(a,s)=>(a.geometry=this._recreateGeometry(s,a.material),h(a.geometry)?[a.geometry]:[])});let i=!0;for(const a in e)a in this?a==="attached"?i=e[a]:this[a]=e[a]:console.error("Cannot set unknown property",a);this.attached=i}destroy(){this._resources.destroy()}get visible(){return this._resources.visible}set visible(e){this._resources.visible=e}get attached(){return this._resources.attached}set attached(e){this._resources.attached=e}get geometry(){return this._geometry}set geometry(e){this._geometry=e,this._resources.recreateGeometry()}get size(){return this._size}set size(e){if(e!==this._size){const i=this._preferredTextureSize;this._size=e,i<this._preferredTextureSize?h(this._resources)&&this._resources.recreate():this._updateSizeAttribute()}}get color(){return this._color}set color(e){$e(e,this._color)||(Ce(this._color,e),this._updateMaterial())}get pixelSnappingEnabled(){return this._pixelSnappingEnabled}set pixelSnappingEnabled(e){this._pixelSnappingEnabled!==e&&(this._pixelSnappingEnabled=e,this._updateMaterial())}get primitive(){return this._primitive}set primitive(e){this._primitive!==e&&(this._primitive=e,h(this._resources)&&this._resources.recreate())}get outlineSize(){return this._outlineSize}set outlineSize(e){e!==this._outlineSize&&(this._outlineSize=e,this._updateMaterial())}get outlineColor(){return this._outlineColor}set outlineColor(e){$e(e,this._outlineColor)||(Ce(this._outlineColor,e),this._updateMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this._resources&&this._resources.recreateGeometry()}_updateMaterial(){const e=this._resources.resources;m(e)||e.material.setParameters(this._materialParameters(e.texture.id))}_updateSizeAttribute(){const e=this._resources.resources,i=this._resources.object;if(m(e)||m(i))return;const a=e.geometry;if(m(a))return;const s=a.getMutableAttribute(O.SIZE).data,n=this._geometrySize;s[0]=n,s[1]=n,i.geometryVertexAttrsUpdated(i.geometryRecords[0])}_materialParameters(e){return{color:this._color,textureIsSignedDistanceField:!0,distanceFieldBoundingBox:Jc,occlusionTest:!1,outlineColor:this._outlineColor,outlineSize:this._outlineSize,textureId:e,polygonOffset:!1,shaderPolygonOffset:0,drawInSecondSlot:!0,depthEnabled:!1,pixelSnappingEnabled:this.pixelSnappingEnabled}}get _geometrySize(){return this._size/Bi}_recreateGeometry(e,i){const a=this._createRenderGeometry();return h(a)&&e.addGeometry(a,i),a}_createResources(e){const i=qh(this._primitive,this._preferredTextureSize),a=new Qh(this._materialParameters(i.id)),s=this._recreateGeometry(e,a);return{material:a,texture:i,geometry:s,forEach(n){n(i),n(a),h(this.geometry)&&n(this.geometry)}}}get _preferredTextureSize(){return ra(el(2*this._geometrySize),16,128)}calculateMapBounds(e){if(m(this._resources.resources)||m(this._resources.resources.geometry))return!1;const i=this._resources.resources.geometry.vertexAttributes.get(O.POSITION);return oa(i.data,this.view.renderCoordsHelper.spatialReference,Lr,this.view.spatialReference),ts(e,Lr),!0}_createRenderGeometry(){const e=this.geometry;if(m(e))return null;const{renderCoordsHelper:i,elevationProvider:a}=this.view,s=Sa(e,a,ei.fromElevationInfo(this.elevationInfo),i),n=U(S.get(),e.x,e.y,s),r=S.get();oa(n,e.spatialReference,r,i.spatialReference);const o=this._geometrySize;return Jh(null,r,null,[o,o],[0,0,0,1])}}const Bi=Kh,Jc=[Bi/2,Bi/2,1-Bi/2,1-Bi/2],Lr=b();class Kc extends Ta{constructor(e){super(e),this._handles=new it,this._quadMaterial=null,this._outlineMaterial=null,this._maxSize=0,this._position=b(),this._up=b(),this._right=b(),this._renderOccluded=$.OccludeAndTransparent,this._color=Ct(1,0,0,1),this._outlineColor=Ct(0,0,0,1),this._outlineSize=0,this._size=32,this._outlineRenderOccluded=$.Opaque,this.applyProps(e)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateQuadMaterial())}get color(){return this._color}set color(e){Ce(this._color,e),this._updateQuadMaterial()}get outlineColor(){return this._outlineColor}set outlineColor(e){Ce(this._outlineColor,e),this._updateOutlineMaterial()}get outlineSize(){return this._outlineSize}set outlineSize(e){const i=this._outlineSize===0!=(e===0);this._outlineSize=e,i?this.recreateGeometry():this._updateOutlineMaterial()}get size(){return this._size}set size(e){e!==this._size&&(this._size=e,this._updateTransform())}get outlineRenderOccluded(){return this._outlineRenderOccluded}set outlineRenderOccluded(e){this._outlineRenderOccluded=e,this._updateOutlineMaterial()}set geometry({previous:e,center:i,next:a}){this._maxSize=Math.min(sa(i,e),sa(i,a))/3,ie(this._up,D(this._up,e,i)),ie(this._right,D(this._right,a,i)),B(this._position,i),this.recreateGeometry()}createExternalResources(){this._quadMaterial=new Ze(this._quadMaterialParameters),this._outlineMaterial=new Gt(this._outlineMaterialParameters),this._handles.add(I(()=>this.view.state.camera,()=>this._updateTransform()))}destroyExternalResources(){this._quadMaterial=null,this._outlineMaterial=null,this._handles.removeAll()}forEachExternalMaterial(e){e(this._quadMaterial),e(this._outlineMaterial)}createGeometries(e){Zt(this._up,vi)&&Zt(this._right,vi)||(this._createQuadGeometry(e),this._createOutlineGeometry(e),this._updateTransform(e))}_createQuadGeometry(e){const i=this._quadGeometryData(this._up,this._right);e.addGeometry(i,this._quadMaterial)}_createOutlineGeometry(e){if(this._outlineSize===0)return;const i=H(S.get(),this._up,this._right),a=rt([this._up,i,this._right]);e.addGeometry(a,this._outlineMaterial)}_updateTransform(e=this.object){const i=this.view.state.camera,a=this._size*i.computeScreenPixelSizeAt(this._position),s=Math.min(this._maxSize,a);is($a,this._position),yi($a,$a,[s,s,s]),h(e)&&(e.transformation=$a)}_quadGeometryData(e,i){const a=H(S.get(),e,i);return new Jn([[O.POSITION,{size:3,data:[0,0,0,...i,...e,...a],exclusive:!0}]],[[O.POSITION,[0,1,2,1,2,3]]])}get _quadMaterialParameters(){return{color:this._color,transparent:!0,writeDepth:!1,polygonOffset:!0,renderOccluded:this._renderOccluded}}_updateQuadMaterial(){this._quadMaterial&&this._quadMaterial.setParameters(this._quadMaterialParameters)}get _outlineMaterialParameters(){return{color:this._outlineColor,width:this._outlineSize,renderOccluded:this._outlineRenderOccluded}}_updateOutlineMaterial(){this._outlineMaterial&&this._outlineMaterial.setParameters(this._outlineMaterialParameters)}}const $a=_e();class Xi extends tl{visualizeIntersectionPoint(e,i){const{coordinateHelper:a,view:s}=i;return xe(new Ps({view:s,primitive:"circle",geometry:a.vectorToPoint(e.intersectionPoint),elevationInfo:K(e.elevationInfo,i.elevationInfo),size:20,outlineSize:2,color:[0,0,0,0],outlineColor:te.toUnitRGBA(oe.orange),pixelSnappingEnabled:!1}))}visualizePoint(e,i){const{view:a,coordinateHelper:s}=i,n=this._alignPoint(e.point,e.domain,i);return xe(new Ps({view:a,primitive:"circle",geometry:s.vectorToPoint(n),elevationInfo:this._hintElevationInfo(e,i),size:20,outlineSize:2,color:[0,0,0,0],outlineColor:te.toUnitRGBA(oe.orange),pixelSnappingEnabled:!1}))}visualizeLine(e,i){const{view:a,coordinateHelper:s}=i,n=this._alignPoint(e.lineStart,e.domain,i),r=this._alignPoint(e.lineEnd,e.domain,i);return xe(this._createLineSegmentHintFromMap(e.type,n,r,s,this._hintElevationInfo(e,i),a,e.fadeLeft,e.fadeRight))}visualizeParallelSign(e,i){const{view:a,coordinateHelper:s}=i,n=this._hintElevationInfo(e,i),r=this._alignPoint(e.lineStart,e.domain,i),o=this._alignPoint(e.lineEnd,e.domain,i),l=bi(r,s,n,a),p=bi(o,s,n,a),u=mt(p,l,p,.5),d=new Qc({view:a,attached:!1,offset:oe.parallelLineHintOffset,length:oe.parallelLineHintLength,width:oe.parallelLineHintWidth,color:te.toUnitRGBA(oe.orange),location:u,renderOccluded:$.Opaque});return d.setDirectionFromPoints(l,u),d.attached=!0,xe(d)}visualizeRightAngleQuad(e,i){const{view:a,coordinateHelper:s}=i,n=this._hintElevationInfo(e,i),r=this._alignPoint(e.previousVertex,e.domain,i),o=this._alignPoint(e.centerVertex,e.domain,i),l=this._alignPoint(e.nextVertex,e.domain,i);return xe(new Kc({view:a,attached:!0,color:te.toUnitRGBA(oe.orange),renderOccluded:$.Transparent,outlineRenderOccluded:$.Opaque,outlineColor:te.toUnitRGBA(oe.orange),outlineSize:oe.rightAngleHintOutlineSize,size:oe.rightAngleHintSize,geometry:{previous:bi(r,s,n,a),center:bi(o,s,n,a),next:bi(l,s,n,a)}}))}_createLineSegmentHintFromMap(e,i,a,s,n,r,o=!0,l=!0){const p=b(),u=b();return il(i,a,s,n,r,p,u),this._createLineSegmentHint(e,r,p,u,o,l)}_createLineSegmentHint(e,i,a,s,n=!0,r=!0){const o=new Pa({view:i,extensionType:Oe.FADED,start:a,end:s,color:te.toUnitRGBA(oe.orange),renderOccluded:$.Opaque});switch(e){case as.TARGET:o.width=oe.lineHintWidthTarget,o.fadedExtensions={start:0,end:oe.lineHintFadedExtensions};break;case as.REFERENCE_EXTENSION:o.width=oe.lineHintWidthReference,o.fadedExtensions={start:0,end:0};break;case as.REFERENCE:o.width=oe.lineHintWidthReference,o.fadedExtensions={start:n?oe.lineHintFadedExtensions:0,end:r?oe.lineHintFadedExtensions:0}}return o.attached=!0,o}_alignPoint(e,i,a){const s=this._getSelfSnappingZ(i,a);if(m(s))return e;const n=a.coordinateHelper,r=n.vectorToPoint(e,ed);return r.z=s,n.pointToVector(r)}_hintElevationInfo(e,i){return h(this._getSelfSnappingZ(e.domain,i))?C(i.selfSnappingZ).elevationInfo:K(e.elevationInfo,i.elevationInfo)}_getSelfSnappingZ(e,{selfSnappingZ:i}){return e===al.SELF&&h(i)?i.value:null}}const ed=new Pt,T={main:new te([255,127,0]),selected:new te([255,255,255]),staged:new te([12,207,255]),outline:new te([0,0,0,.5]),selectedOutline:new te([255,255,255])},ni=.3;function Yi(t,e){const i=t.clone();return i.a*=e,i}function td(t,e){const i=t.clone(),a=sl(i);a.s*=e;const s=nl(a);return i.r=s.r,i.g=s.g,i.b=s.b,i}function Pe(t,e){if(e)for(const i in e)t[i]=e[i]}class id{constructor(e){this.color=T.main,this.height=90,this.coneHeight=40,this.coneWidth=23,this.width=3,this.renderOccluded=$.Opaque,Pe(this,e)}}class Rs{constructor(e){this.size=11,this.outlineSize=1,this.collisionPadding=9,this.color=T.main,this.outlineColor=T.outline,this.renderOccluded=$.Opaque,this.hoverOutlineColor=T.selectedOutline,Pe(this,e)}apply(e,i){const a=this[e];i.setParameters({color:Mt(a),transparent:e!=="color"||a.a<1,renderOccluded:this.renderOccluded})}}class ad{constructor(e){this.size=40,this.height=.2,this.offset=.25,this.collisionPadding=2,this.color=Yi(T.main,.5),this.hoverColor=T.main,this.renderOccluded=$.Transparent,this.minSquaredEdgeLength=900,Pe(this,e)}apply(e,i){const a=this[e];i.setParameters({color:Mt(a),transparent:a.a<1,renderOccluded:this.renderOccluded})}}class sd{constructor(e){this.vertex=new Rs({color:T.main,outlineColor:T.outline}),this.edge=new Rs({color:td(Yi(T.main,2/3),.5),outlineColor:Yi(T.outline,.5),size:8,collisionPadding:8}),this.selected=new Rs({color:T.selected,outlineColor:T.outline}),this.edgeOffset=new ad,Pe(this,e)}}class Ds{constructor(e){this.color=T.selected,this.width=1.5,this.stipplePattern=Ms(5),this.stippleOffColor=T.outline,this.falloff=0,this.innerWidth=1.5,this.innerColor=T.selected,this.renderOccluded=$.OccludeAndTransparent,Pe(this,e)}apply(e){e.color=Mt(this.color),e.width=this.width,e.stipplePattern=this.stipplePattern,e.stippleOffColor=Mt(this.stippleOffColor),e.falloff=this.falloff,e.innerWidth=this.innerWidth,e.innerColor=Mt(this.innerColor),e.renderOccluded=this.renderOccluded}}class nd{constructor(e){this.color=T.selected,this.size=4,this.outlineSize=1,this.outlineColor=T.outline,this.shape="square",Pe(this,e)}apply(e){e.color=Mt(this.color),e.size=this.size,e.outlineSize=this.outlineSize,e.outlineColor=Mt(this.outlineColor),e.primitive=this.shape}}class Ca{constructor(e){this.innerColor=T.selected,this.innerWidth=1,this.glowColor=T.main,this.glowWidth=8,this.glowFalloff=8,this.globalAlpha=ni,this.globalAlphaContrastBoost=1.5,this.radius=3,this.heightFillColor=T.main,Pe(this,e)}apply(e,i=1){const a={glowColor:te.toUnitRGB(this.glowColor),glowFalloff:this.glowFalloff,glowWidth:this.glowWidth,innerColor:te.toUnitRGB(this.innerColor),innerWidth:this.innerWidth,globalAlpha:this.globalAlpha*i,globalAlphaContrastBoost:this.globalAlphaContrastBoost,intersectsLineRadius:this.radius};"style"in e?e.style=a:e.laserlineStyle=a}}class rd{constructor(e){this.outline=new Ds({color:T.outline,renderOccluded:$.OccludeAndTransparentStencil,stippleOffColor:T.selected,stipplePattern:Ms(5),width:1.5,innerWidth:0}),this.staged=new Ds({color:T.selected,renderOccluded:$.OccludeAndTransparentStencil,innerColor:T.staged,stippleOffColor:T.outline,stipplePattern:Ms(5),width:1.5}),this.shadowStyle=new Ca({globalAlpha:ni,glowColor:T.main,glowFalloff:8,glowWidth:8,innerColor:T.selected,innerWidth:1}),Pe(this,e)}}class od{constructor(e){this.outline=new nd({color:T.selected,outlineColor:T.outline,outlineSize:1,shape:"circle",size:4}),this.shadowStyle=new Ca({globalAlpha:ni,glowColor:T.main,glowFalloff:1.5,glowWidth:6,innerColor:T.selected,innerWidth:1,radius:2}),Pe(this,e)}}class ld extends Ds{constructor(e){super(),this.extensionType=Oe.GROUND_RAY,Pe(this,e)}}class hd{constructor(e){this.lineGraphics=new rd,this.pointGraphics=new od,this.heightPlane=new Ca({globalAlpha:ni,glowColor:T.main,glowFalloff:8,glowWidth:8,innerColor:T.selected,innerWidth:1}),this.heightBox=new Ca({globalAlpha:ni,glowColor:T.main,glowFalloff:8,glowWidth:8,innerColor:T.selected,innerWidth:0,heightFillColor:T.main}),this.zVerticalLine=new ld({color:Yi(T.main,5*ni/3),falloff:2,innerColor:Yi(T.selected,0),renderOccluded:$.OccludeAndTransparent,stipplePattern:null,width:5,extensionType:Oe.GROUND_RAY}),this.laserlineAlphaMultiplier=1.5,this.heightPlaneAngleCutoff=20,Pe(this,e)}}class cd{constructor(e){this.visualElements=new hd,this.reshapeManipulators=new sd,this.zManipulator=new id,Pe(this,e)}colorToVec4(e){return Mt(e)}}function Mt(t){return Rt(te.toUnitRGBA(t))}const y=new cd;class dd{constructor(e){this._resourceFactory=e,this._resources=null,this._visible=!0,this._attached=!1}destroy(){this._destroyResources()}get resources(){return h(this._resources)?this._resources.external:null}get visible(){return this._visible}set visible(e){e!==this._visible&&(this._visible=e,this._syncGeometriesToRenderer())}get attached(){return this._attached}set attached(e){e!==this._attached&&(this._attached=e,this._createOrDestroyResources())}recreate(){this.attached&&this._createResources()}recreateGeometry(){this._resourceFactory.recreateGeometry?m(this._resources)||(this._ensureRenderGeometriesRemoved(),this._resourceFactory.recreateGeometry(this._resources.external),this._syncGeometriesToRenderer()):this.recreate()}_createOrDestroyResources(){this._attached?m(this._resources)&&this._createResources():this._destroyResources()}_createResources(){var s;this._destroyResources();const e=this._resourceFactory.createResources(),i=new ri({view:this._resourceFactory.view}),a=(s=this._resourceFactory.view.basemapTerrain)==null?void 0:s.overlayManager;this._resources={layerView:new ri({view:this._resourceFactory.view}),external:e,geometriesAdded:!1},a&&(this._resources.drapeSourceRenderer=a.registerGeometryDrapeSource(i)),this._syncGeometriesToRenderer()}_destroyResources(){var i;if(m(this._resources))return;this._ensureRenderGeometriesRemoved();const e=(i=this._resourceFactory.view.basemapTerrain)==null?void 0:i.overlayManager;e&&e.unregisterDrapeSource(this._resources.layerView),this._resources=null}_syncGeometriesToRenderer(){this._visible?this._ensureRenderGeometriesAdded():this._ensureRenderGeometriesRemoved()}_ensureRenderGeometriesRemoved(){m(this._resources)||m(this._resources.drapeSourceRenderer)||!this._resources.geometriesAdded||(this._resources.drapeSourceRenderer.removeGeometries(this._resources.external.geometries,pr.UPDATE),this._resources.geometriesAdded=!1)}_ensureRenderGeometriesAdded(){m(this._resources)||m(this._resources.drapeSourceRenderer)||this._resources.geometriesAdded||(this._resources.drapeSourceRenderer.addGeometries(this._resources.external.geometries,pr.UPDATE),this._resources.geometriesAdded=!0)}}let ri=class extends rl(_i){constructor(t){super(t),this.drapeSourceType=ec.Features,this.updatePolicy=Ma.SYNC}};c([g({constructOnly:!0})],ri.prototype,"view",void 0),c([g({readOnly:!0})],ri.prototype,"drapeSourceType",void 0),ri=c([q("DrapedVisualElementLayerView")],ri);class zt{constructor(e){this.view=null,this._attachmentOrigin=Mi(0,0,0,null),this._attachmentOriginDirty=!0,this.events=new Le,this._isDraped=!1,this._geometry=null,this._width=1,this._color=Ct(1,0,1,1),this._innerWidth=0,this._innerColor=Ct(1,1,1,1),this._stipplePattern=null,this._stippleOffColor=null,this._falloff=0,this._elevationInfo=null,this._laserlineStyle=null,this._laserlineEnabled=!1,this._renderOccluded=$.OccludeAndTransparentStencil,this._resources=new Cr({view:e.view,createResources:a=>this._createResources(a),recreateGeometry:(a,s)=>(a.geometries.length=0,this._recreateGeometry(s,a.material,a.geometries),a.geometries)}),this._attachmentOrigin.spatialReference=e.view.spatialReference,this._drapedResources=new dd({view:e.view,createResources:()=>this._createDrapedResources(),recreateGeometry:a=>{a.geometries=this._createRenderGeometriesDraped(a.material),this._attachmentOriginChanged()}});let i=!0;this._laserline=new Ui({view:e.view});for(const a in e)a in this?a==="attached"?i=e[a]:this[a]=e[a]:console.error("Cannot set unknown property",a);this.attached=i}destroy(){this._resources.destroy(),this._drapedResources.destroy(),this._laserline.destroy()}get isDraped(){return this._isDraped}set isDraped(e){e!==this._isDraped&&(this._isDraped=e,this._updateAttached(this.attached),this._laserline.attached=this._laserlineAttached)}get _laserlineAttached(){return this.attached&&this.visible&&h(this._laserlineStyle)&&!this.isDraped&&this.laserlineEnabled}get visible(){return this._resources.visible}set visible(e){this._resources.visible=e,this._drapedResources.visible=e,this._laserline.attached=this._laserlineAttached}get attached(){return this._resources.attached||this._drapedResources.attached}set attached(e){this._updateAttached(e)}_updateAttached(e){this._resources.attached=!this.isDraped&&e,this._drapedResources.attached=this.isDraped&&e,this._laserline.attached=this._laserlineAttached,this.attached&&this._attachmentOriginChanged()}get geometry(){return this._geometry}set geometry(e){this._geometry=e,this._resources.recreateGeometry(),this._drapedResources.recreateGeometry()}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this._updateMaterial())}get color(){return this._color}set color(e){$e(e,this._color)||(Ce(this._color,e),this._updateMaterial())}get innerWidth(){return this._innerWidth}set innerWidth(e){e!==this._innerWidth&&(this._innerWidth=e,this._updateMaterial())}get innerColor(){return this._innerColor}set innerColor(e){$e(e,this._innerColor)||(Ce(this._innerColor,e),this._updateMaterial())}get stipplePattern(){return this._stipplePattern}set stipplePattern(e){const i=h(e)!==h(this._stipplePattern);this._stipplePattern=e,i?this._resources.recreate():this._updateMaterial()}get stippleOffColor(){return this._stippleOffColor}set stippleOffColor(e){e&&this._stippleOffColor&&$e(e,this._stippleOffColor)||(this._stippleOffColor=e?jn(e):null,this._updateMaterial())}get falloff(){return this._falloff}set falloff(e){e!==this._falloff&&(this._falloff=e,this._updateMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this._resources.recreateGeometry()}get laserlineStyle(){return this._laserlineStyle}set laserlineStyle(e){this._laserlineStyle=e,this._laserline.attached=this._laserlineAttached,h(e)&&(this._laserline.style=e)}get laserlineEnabled(){return this._laserlineEnabled}set laserlineEnabled(e){this._laserlineEnabled!==e&&(this._laserlineEnabled=e,this._laserline.attached=this._laserlineAttached)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}get attachmentOrigin(){if(!this._attachmentOriginDirty)return this._attachmentOrigin;const e=h(this._resources.resources)?this._resources.resources.geometries:null;if(!e||e.length===0)return null;U(oi,0,0,0);let i=0;for(const a of e){const s=a.vertexAttributes.get(O.POSITION),n=a.indices.get(O.POSITION),r=C(this._resources.resources).material.isClosed(s.data,n);Dh(s,n,r,Ir)&&(H(oi,oi,Ir),i++)}return i===0?null:(Q(oi,oi,1/i),this.view.renderCoordsHelper.fromRenderCoords(oi,this._attachmentOrigin),this._attachmentOriginDirty=!1,this._attachmentOrigin)}_updateMaterial(){h(this._resources.resources)&&this._resources.resources.material.setParameters(this._materialParameters),h(this._drapedResources.resources)&&this._drapedResources.resources.material.setParameters(this._materialParameters)}get _isClosed(){return h(this.geometry)&&this.geometry.type==="polygon"}get _materialParameters(){return{width:this._width,color:this._color,stippleOffColor:this._stippleOffColor,stipplePattern:this._stipplePattern,stipplePreferContinuous:!1,isClosed:this._isClosed,falloff:this._falloff,innerColor:this._innerColor,innerWidth:this._innerWidth,join:"round",hasPolygonOffset:!0,renderOccluded:this._normalizedRenderOccluded}}get _normalizedRenderOccluded(){return this.isDraped&&this._renderOccluded===$.OccludeAndTransparentStencil?$.OccludeAndTransparent:this._renderOccluded}_recreateGeometry(e,i,a){const s=this._createRenderGeometries();for(const n of s)e.addGeometry(n,i),a.push(n);this._attachmentOriginChanged()}_attachmentOriginChanged(){this._attachmentOriginDirty=!0,this.events.emit("attachment-origin-changed")}_createResources(e){const i=new Gt(this._materialParameters),a=[];return this._recreateGeometry(e,i,a),{material:i,geometries:a,forEach:s=>{s(i),a.forEach(s)}}}_createDrapedResources(){const e=new Gt(this._materialParameters);return{material:e,geometries:this._createRenderGeometriesDraped(e)}}_createRenderGeometriesDraped(e){const i=this.geometry;if(m(i)||m(this.view.basemapTerrain.spatialReference))return[];const a=tc(i,this.view.basemapTerrain.spatialReference),s=[];for(const{position:n}of a.lines){const r={overlayInfo:{spatialReference:this.view.basemapTerrain.spatialReference,renderCoordsHelper:this.view.renderCoordsHelper},attributeData:{position:n},removeDuplicateStartEnd:this._isClosed},o=new ic(ur(r),e),l=rn(pd);ts(l,n),ol(o.boundingSphere,.5*(l[0]+l[3]),.5*(l[1]+l[4]),0,.5*Math.sqrt((l[3]-l[0])*(l[3]-l[0])+(l[4]-l[1])*(l[4]-l[1]))),s.push(o)}return s}calculateMapBounds(e){if(m(this._resources.resources))return!1;const i=this.view.renderCoordsHelper;for(const a of this._resources.resources.geometries){const s=a.vertexAttributes.get(O.POSITION),n=new Float64Array(s.data.length);ll(s.data,i.spatialReference,0,n,this.view.spatialReference,0,s.data.length/3),ts(e,n)}return!0}_createRenderGeometries(){var n;const e=this.geometry;if(m(e))return[];const i=ac(e,this.view.elevationProvider,this.view.renderCoordsHelper,ei.fromElevationInfo((n=this.elevationInfo)!=null?n:new on({mode:Js(e,null)}))),a=[],s=[];for(const{position:r,mapPosition:o}of i.lines){const l={attributeData:{position:r,mapPosition:o},removeDuplicateStartEnd:this._isClosed};a.push(ur(l)),s.push(r)}return this._laserline.pathVerticalPlane=s,a}}const pd=nn(),Ir=b(),oi=b();function ud(t,e,i,a,s){const n=new Float64Array(3*t.length),r=new Float64Array(n.length);t.forEach((p,u)=>{n[3*u+0]=p[0],n[3*u+1]=p[1],n[3*u+2]=p.length>2?p[2]:0});const o=sc(n,e,0,r,0,n,0,n.length/3,i,a,s),l=o!=null;return{numVertices:t.length,position:n,mapPosition:r,projectionSuccess:l,sampledElevation:o}}function gd(t,e){if(!e.screenSizeEnabled)return;const i=t.vertex;$h(i,e),i.uniforms.add(new pe("perScreenPixelRatio",(a,s)=>s.camera.perScreenPixelRatio)),i.uniforms.add(new pe("screenSizeScale",a=>a.screenSizeScale)),i.code.add(R`float computeRenderPixelSizeAt( vec3 pWorld ){
vec3 viewForward = - vec3(view[0][2], view[1][2], view[2][2]);
float viewDirectionDistance = abs(dot(viewForward, pWorld - cameraPosition));
return viewDirectionDistance * perScreenPixelRatio;
}
vec3 screenSizeScaling(vec3 position, vec3 anchor){
return position * screenSizeScale * computeRenderPixelSizeAt(anchor) + anchor;
}`)}function _d(t){const e=new Di,i=t.hasMultipassTerrain&&(t.output===Y.Color||t.output===Y.Alpha);e.include(Kn,t),e.include(gd,t),e.include(er,t);const{vertex:a,fragment:s}=e;return s.include(tr),ms(a,t),s.uniforms.add(new yt("uColor",n=>n.color)),e.attributes.add(O.POSITION,"vec3"),e.varyings.add("vWorldPosition","vec3"),i&&e.varyings.add("depth","float"),t.screenSizeEnabled&&e.attributes.add(O.OFFSET,"vec3"),t.shadingEnabled&&(Ch(a),e.attributes.add(O.NORMAL,"vec3"),e.varyings.add("vViewNormal","vec3")),a.code.add(R`
    void main(void) {
      vWorldPosition = ${t.screenSizeEnabled?"screenSizeScaling(offset, position)":"position"};
  `),t.shadingEnabled&&a.code.add(R`vec3 worldNormal = normal;
vViewNormal = (viewNormal * vec4(worldNormal, 1)).xyz;`),a.code.add(R`
    ${i?"depth = (view * vec4(vWorldPosition, 1.0)).z;":""}
    gl_Position = transformPosition(proj, view, vWorldPosition);
  }
  `),i&&e.include(ir,t),s.code.add(R`
    void main() {
      discardBySlice(vWorldPosition);
      ${i?"terrainDepthTest(gl_FragCoord, depth);":""}
    `),t.shadingEnabled?(s.uniforms.add(new nt("shadingDirection",n=>n.shadingDirection)),s.uniforms.add(new yt("shadedColor",n=>md(n.shadingTint,n.color))),s.code.add(R`vec3 viewNormalNorm = normalize(vViewNormal);
float shadingFactor = 1.0 - clamp(-dot(viewNormalNorm, shadingDirection), 0.0, 1.0);
vec4 finalColor = mix(uColor, shadedColor, shadingFactor);`)):s.code.add(R`vec4 finalColor = uColor;`),s.code.add(R`
      if (finalColor.a < ${R.float(Lh)}) {
        discard;
      }
      ${t.output===Y.Alpha?R`gl_FragColor = vec4(finalColor.a);`:""}

      ${t.output===Y.Color?R`gl_FragColor = highlightSlice(finalColor, vWorldPosition); ${t.transparencyPassType===We.Color?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}`:""}
    }
    `),e}function md(t,e){const i=1-t[3],a=t[3]+e[3]*i;return a===0?(Nt[3]=a,Nt):(Nt[0]=(t[0]*t[3]+e[0]*e[3]*i)/a,Nt[1]=(t[1]*t[3]+e[1]*e[3]*i)/a,Nt[2]=(t[2]*t[3]+e[2]*e[3]*i)/a,Nt[3]=e[3],Nt)}const Nt=en(),fd=Object.freeze(Object.defineProperty({__proto__:null,build:_d},Symbol.toStringTag,{value:"Module"}));class La extends Ci{initializeProgram(e){return new Li(e.rctx,La.shader.get().build(this.configuration),Gr)}_setPipelineState(e){const i=this.configuration,a=e===We.NONE,s=e===We.FrontFace;return Ii({blending:i.output!==Y.Color&&i.output!==Y.Alpha||!i.transparent?null:a?jh:lr(e),culling:hr(i.cullFace),depthTest:{func:s?ba.LESS:i.shadingEnabled?ba.LEQUAL:ba.LESS},depthWrite:a?i.writeDepth&&cr:dr(e),colorWrite:Gi,polygonOffset:a||s?null:Uh})}initializePipeline(){return this._setPipelineState(this.configuration.transparencyPassType)}}La.shader=new $i(fd,()=>import("./ShadedColorMaterial.glsl.09ac0e12.js"));class Ve extends ar{constructor(){super(...arguments),this.output=Y.Color,this.cullFace=se.None,this.transparencyPassType=We.NONE,this.hasSlicePlane=!1,this.transparent=!1,this.writeDepth=!0,this.screenSizeEnabled=!0,this.shadingEnabled=!0,this.hasMultipassTerrain=!1,this.cullAboveGround=!1}}c([k({count:Y.COUNT})],Ve.prototype,"output",void 0),c([k({count:se.COUNT})],Ve.prototype,"cullFace",void 0),c([k({count:We.COUNT})],Ve.prototype,"transparencyPassType",void 0),c([k()],Ve.prototype,"hasSlicePlane",void 0),c([k()],Ve.prototype,"transparent",void 0),c([k()],Ve.prototype,"writeDepth",void 0),c([k()],Ve.prototype,"screenSizeEnabled",void 0),c([k()],Ve.prototype,"shadingEnabled",void 0),c([k()],Ve.prototype,"hasMultipassTerrain",void 0),c([k()],Ve.prototype,"cullAboveGround",void 0);const Gr=new Map([[O.POSITION,0],[O.NORMAL,1],[O.OFFSET,2]]);class $s extends sr{constructor(e){super(e,new yd),this.supportsEdges=!0,this._configuration=new Ve,this._vertexAttributeLocations=Gr}getConfiguration(e,i){return this._configuration.output=e,this._configuration.cullFace=this.parameters.cullFace,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this.parameters.transparent,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.screenSizeEnabled=this.parameters.screenSizeEnabled,this._configuration.shadingEnabled=this.parameters.shadingEnabled,this._configuration.transparencyPassType=i.transparencyPassType,this._configuration.hasMultipassTerrain=i.multipassTerrain.enabled,this._configuration.cullAboveGround=i.multipassTerrain.cullAboveGround,this._configuration}intersect(e,i,a,s,n,r,o){if(this.parameters.screenSizeEnabled){const l=e.vertexAttributes.get(O.OFFSET);fs(e,i,s,n,r,{applyToVertex:(u,d,_,f)=>{const v=U(Vr,l.data[3*f+0],l.data[3*f+1],l.data[3*f+2]),M=U(Md,u,d,_);return Q(v,v,this.parameters.screenSizeScale*s.camera.computeRenderPixelSizeAt(v)),H(M,M,v),[M[0],M[1],M[2]]},applyToAabb:u=>{const d=hl(u,Vr);return cl(u,this.parameters.screenSizeScale*s.camera.computeRenderPixelSizeAt(d))}},o)}else fs(e,i,s,n,r,void 0,o)}requiresSlot(e,i){if(i===Y.Highlight)return e===Te.OPAQUE_MATERIAL;if(i===Y.Color||i===Y.Alpha||i===Y.ObjectAndLayerIdColor){let a=Te.OPAQUE_MATERIAL;return this.parameters.transparent&&(a=this.parameters.writeDepth?Te.TRANSPARENT_MATERIAL:Te.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL),e===a||e===Te.DRAPED_MATERIAL}return!1}createGLMaterial(e){return new vd(e)}createBufferWriter(){return new bd(this.parameters.screenSizeEnabled)}}class vd extends Ih{beginSlot(e){return this.ensureTechnique(La,e)}}class yd extends nr{constructor(){super(...arguments),this.color=Be(1,1,1,1),this.shadingTint=Be(0,0,0,.25),this.shadingDirection=ie(b(),[.5,-.5,-.5]),this.screenSizeScale=14,this.transparent=!1,this.writeDepth=!0,this.hasSlicePlane=!1,this.cullFace=se.None,this.screenSizeEnabled=!1,this.shadingEnabled=!0}}class bd{constructor(e){this.screenSizeEnabled=e;const i=Zn().vec3f(O.POSITION).vec3f(O.NORMAL);this.screenSizeEnabled&&i.vec3f(O.OFFSET),this.vertexBufferLayout=i}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){return e.indices.get(O.POSITION).length}write(e,i,a,s,n){if(Gh(a,this.vertexBufferLayout,e,i,s,n),this.screenSizeEnabled){if(!a.vertexAttributes.has(O.OFFSET))throw new Error(`${O.OFFSET} vertex attribute required for screenSizeEnabled ShadedColorMaterial`);{const r=a.vertexAttributes.get(O.OFFSET),o=a.indices.get(O.OFFSET);pc(r.size===3);const l=s.getField(O.OFFSET,dc);if(!l)throw new Error("unable to acquire view for "+O.OFFSET);Vh(o,r.data,i,l,n)}}}}const Vr=b(),Md=b();class zr extends Ta{constructor(e){super(e),this.view=null,this._renderOccluded=$.OccludeAndTransparent,this._vertices=null,this._spatialReference=null,this._color=y.colorToVec4(y.reshapeManipulators.vertex.color),this._size=y.reshapeManipulators.vertex.size,this._outlineColor=y.colorToVec4(y.reshapeManipulators.vertex.outlineColor),this._outlineSize=y.reshapeManipulators.vertex.outlineSize,this._elevationInfo=null,this.applyProps(e)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial(),this._updateOutlineMaterial())}get vertices(){return this._vertices}set vertices(e){this._vertices=e,this.recreateGeometry()}get spatialReference(){return this._spatialReference}set spatialReference(e){this._spatialReference=e,this.recreateGeometry()}get color(){return this._color}set color(e){$e(e,this._color)||(Ce(this._color,e),this._updateMaterial())}get size(){return this._size}set size(e){e!==this._size&&(this._size=e,this._updateMaterial())}get outlineColor(){return this._outlineColor}set outlineColor(e){$e(e,this._outlineColor)||(Ce(this._outlineColor,e),this._updateOutlineMaterial())}get outlineSize(){return this._outlineSize}set outlineSize(e){e!==this._outlineSize&&(this._outlineSize=e,this._updateOutlineMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this.recreateGeometry()}get _vertexMaterialParameters(){return{color:this._color,transparent:this._color[3]<1,screenSizeScale:this.size,renderOccluded:this._renderOccluded}}get _vertexOutlineMaterialParameters(){return{color:this._outlineColor,transparent:this._outlineColor[3]<1,screenSizeScale:this.size+2*this.outlineSize,renderOccluded:this._renderOccluded}}_updateMaterial(){this.attached&&this._vertexMaterial.setParameters(this._vertexMaterialParameters)}_updateOutlineMaterial(){this.attached&&this._vertexOutlineMaterial.setParameters(this._vertexOutlineMaterialParameters)}_createRenderGeometries(){const e=this.vertices;if(m(e)||e.length===0)return[];const i=.5,a=.5,s=ud(e,this.spatialReference,this.view.elevationProvider,this.view.renderCoordsHelper,ei.fromElevationInfo(this.elevationInfo)),n=[],r=s.numVertices,o=s.position;for(let l=0;l<r;++l){const p=U(Sd,o[3*l+0],o[3*l+1],o[3*l+2]),u=Nr(i,p),d=Nr(a,p);n.push({vertexGeometry:u,vertexOutlineGeometry:d})}return n}createGeometries(e){const i=this._createRenderGeometries();for(const{vertexGeometry:a,vertexOutlineGeometry:s}of i)e.addGeometry(a,this._vertexMaterial),e.addGeometry(s,this._vertexOutlineMaterial)}createExternalResources(){this._vertexMaterial=new $s(z(L({},this._vertexMaterialParameters),{writeDepth:!0,cullFace:se.Back,screenSizeEnabled:!0})),this._vertexOutlineMaterial=new $s(z(L({},this._vertexOutlineMaterialParameters),{transparent:!0,writeDepth:!0,cullFace:se.Front,screenSizeEnabled:!0,shadingEnabled:!1}))}destroyExternalResources(){this._vertexMaterial=null,this._vertexOutlineMaterial=null}forEachExternalMaterial(e){e(this._vertexMaterial),e(this._vertexOutlineMaterial)}}const Sd=b();function Nr(t,e){return Vi(t,16,16,{offset:e})}let Ae=class extends Le.EventedAccessor{constructor(t){super(t),this.tracking=!1,this.displaying=!1,this.isDraped=!1}};c([g({constructOnly:!0})],Ae.prototype,"graphic",void 0),c([g()],Ae.prototype,"tracking",void 0),c([g()],Ae.prototype,"displaying",void 0),c([g()],Ae.prototype,"isDraped",void 0),Ae=c([q("esri.views.3d.layers.graphics.GraphicState")],Ae);let Ft=class extends uc{constructor(t){super(t),this._activeVertexVisualElement=null,this._createGraphicState=null,this._outlineVisualElement=null,this._verticesVisualElement=null,this._verticalLineVisualElement=null,this.geometryType=null,this.type="draw-3d"}initialize(){const{mode:t,offset:e}=this.elevationInfo;this.internalGraphicsLayer.elevationInfo=new on({mode:t,offset:e})}normalizeCtorArgs(t){var e;if(!t.elevationInfo){const i=(e=t.hasZ)!=null?e:!0;return z(L({},t),{elevationInfo:dl(i)})}return t}initializeGraphic(t){const e=this._createGraphicState=new Ae({graphic:t});return ve([this.view.maskOccludee(t),this.view.trackGraphicState(e),I(()=>({element:this._outlineVisualElement,isDraped:e.isDraped}),({element:i,isDraped:a})=>{Qa(i,s=>s.isDraped=a)},Ue)])}makeDrawOperation(){const{geometryType:t}=this,e=t!=="circle"&&t!=="rectangle";return new pl({view:this.view,manipulators:this.manipulators,geometryType:gc(t),drawingMode:this.mode,hasZ:this.hasZ,defaultZ:this.defaultZ,snapToSceneEnabled:this.snapToScene,drawSurface:new ul(this.view,this.elevationInfo,[this.internalGraphicsLayer]),elevationDrawSurface:new gl(this.elevationInfo,this.defaultZ,this.view,this.internalGraphicsLayer),hasM:!1,elevationInfo:this.elevationInfo,snappingManager:this.snappingManager,snappingVisualizer:new Xi,segmentLabels:e?new xa:null,labelOptions:this.labelOptions,tooltipOptions:this.tooltipOptions,isDraped:h(this._createGraphicState)?this._createGraphicState.isDraped:ln(this.hasZ,this.elevationInfo)==="on-the-ground"})}onActiveVertexChanged(t){const{view:e}=this;return h(this._activeVertexVisualElement)?(this._activeVertexVisualElement.vertices=[t],this._updateVerticalLineVisualElement(t),null):(this._activeVertexVisualElement=new zr({view:e,spatialReference:e.spatialReference,vertices:[t],elevationInfo:this.internalGraphicsLayer.elevationInfo,renderOccluded:y.reshapeManipulators.vertex.renderOccluded,attached:!1}),this._activeVertexVisualElement.color=y.colorToVec4(y.reshapeManipulators.selected.color),this._activeVertexVisualElement.attached=!0,this._verticalLineVisualElement=new Pa({view:e,extensionType:y.visualElements.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:$.OccludeAndTransparent}),y.visualElements.zVerticalLine.apply(this._verticalLineVisualElement),Ot(()=>{this._activeVertexVisualElement=X(this._activeVertexVisualElement),this._verticalLineVisualElement=X(this._verticalLineVisualElement)}))}_updateVerticalLineVisualElement(t){const e=this._verticalLineVisualElement;if(m(e))return;const{renderCoordsHelper:i,spatialReference:a,elevationProvider:s}=this.view;U(li,t[0],t[1],t[2]),Fr.setFromElevationInfo(this.elevationInfo),li[2]=Sa(li,s,Fr,i),i.toRenderCoords(li,a,li)?(e.setStartEndFromWorldDownAtLocation(li),e.attached=!0):e.attached=!1}onOutlineChanged(t){if(h(this._outlineVisualElement))return this._outlineVisualElement.geometry=t,null;const e=this.internalGraphicsLayer.elevationInfo;return this._outlineVisualElement=new zt({view:this.view,geometry:t,elevationInfo:e,isDraped:h(this._createGraphicState)?this._createGraphicState.isDraped:ln(this.hasZ,e)==="on-the-ground",attached:!1}),y.visualElements.lineGraphics.outline.apply(this._outlineVisualElement),y.visualElements.lineGraphics.shadowStyle.apply(this._outlineVisualElement),this._outlineVisualElement.attached=!0,this._outlineVisualElement.laserlineEnabled=!0,Ot(()=>{this._outlineVisualElement=X(this._outlineVisualElement)})}onRegularVerticesChanged(t){return h(this._verticesVisualElement)?(this._verticesVisualElement.vertices=t,null):(this._verticesVisualElement=new zr({view:this.view,spatialReference:this.view.spatialReference,vertices:t,elevationInfo:this.internalGraphicsLayer.elevationInfo,renderOccluded:y.reshapeManipulators.vertex.renderOccluded,attached:!1}),this._verticesVisualElement.attached=!0,Ot(()=>{this._verticesVisualElement=X(this._verticesVisualElement)}))}};c([g({constructOnly:!0})],Ft.prototype,"elevationInfo",void 0),c([g({constructOnly:!0})],Ft.prototype,"geometryType",void 0),c([g()],Ft.prototype,"type",void 0),c([g({constructOnly:!0})],Ft.prototype,"view",void 0),Ft=c([q("esri.views.3d.interactive.editingTools.draw.DrawGraphicTool3D")],Ft);const Fr=new ei,li=b();function hi(t,e,i){return wd(t,t.screenToRender(e,ss(S.get())),i)}function wd(t,e,i){const a=ss(hn(S.get(),e));if(a[2]=0,!t.unprojectFromRenderScreen(a,i.origin))return null;const s=ss(hn(S.get(),e));s[2]=1;const n=t.unprojectFromRenderScreen(s,S.get());return m(n)?null:(D(i.direction,n,i.origin),i)}class ge{constructor(e){this._camera=new nc,this._elevation={offset:0,override:null},this.collisionType={type:"point"},this.collisionPriority=0,this._renderObjects=[],this.autoScaleRenderObjects=!0,this._available=!0,this._noDisplayCount=0,this._radius=10,this._worldSized=!1,this.focusMultiplier=2,this.touchMultiplier=2.5,this.worldOriented=!1,this._modelTransform=_e(),this._worldFrame=null,this._renderLocation=b(),this._renderLocationDirty=!0,this._location=new Pt({x:0,y:0,z:0}),this._elevationAlignedLocation=new Pt,this._elevationAlignedLocationDirty=!0,this.interactive=!0,this.selectable=!1,this.grabbable=!0,this.cursor=null,this.grabCursor=null,this._grabbing=!1,this.dragging=!1,this._hovering=!1,this._selected=!1,this._state=ae.None,this._focused=!1,this.events=new Le.EventEmitter,this._screenLocation={screenPointArray:Se(),renderScreenPointArray:ns(),pixelSize:0},this._screenLocationDirty=!0,this._applyObjectTransform=null,this._engineResourcesAddedToStage=!1,this._engineResources=null,this._attached=!1,this._engineLayer=null,this._materialIdReferences=null,this._location.spatialReference=e.view.spatialReference;for(const i in e)this[i]=e[i];this.view.state&&this.view.state.camera&&this._camera.copyFrom(this.view.state.camera)}destroy(){this._removeResourcesFromStage(),this._engineResources=null,this.view=null,this._camera=null}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this._elevationAlignedLocationDirty=!0,this._renderLocationDirty=!0,this._updateEngineObject()}get renderObjects(){return this._renderObjects}set renderObjects(e){this._removeResourcesFromStage(),this._engineResources=null,this._renderObjects=e.slice(),this._updateEngineObject()}set available(e){e!==this._available&&(this._available=e,this._updateEngineObject())}get available(){return this._available}disableDisplay(){return this._noDisplayCount++,this._noDisplayCount===1&&this._updateEngineObject(),{remove:_l(()=>{this._noDisplayCount--,this._noDisplayCount===0&&this._updateEngineObject()})}}set radius(e){e!==this._radius&&(this._radius=e,this._updateEngineObject())}get radius(){return this._radius}set worldSized(e){e!==this._worldSized&&(this._worldSized=e,this._updateEngineObject())}get worldSized(){return this._worldSized}get modelTransform(){return this._modelTransform}set modelTransform(e){Hr(e)&&(this._screenLocationDirty=!0),sn(this._modelTransform,e),this._updateEngineObject()}get renderLocation(){return this._renderLocationDirty&&(this._renderLocationDirty=!1,this.view.renderCoordsHelper.toRenderCoords(this.elevationAlignedLocation,this._renderLocation),this.worldOriented?(this._worldFrame||(this._worldFrame=_e()),xd(this.view,this._renderLocation,this._worldFrame)):this._worldFrame&&(this._worldFrame=null)),this._renderLocation}set renderLocation(e){this.view.renderCoordsHelper.fromRenderCoords(e,this._location),this.elevationAlignedLocation=this._location}get location(){return this._location}set location(e){cn(e,this._location),this._renderLocationDirty=!0,this._screenLocationDirty=!0,this._elevationAlignedLocationDirty=!0,this._updateEngineObject(),this.events.emit("location-update",{location:this._location})}get elevationAlignedLocation(){return this._elevationAlignedLocationDirty?(this._evaluateElevationAlignment(),this._updateElevationAlignedLocation(),this._elevationAlignedLocation):this._elevationAlignedLocation}set elevationAlignedLocation(e){cn(e,this._location),this._evaluateElevationAlignment(),this._location.z-=this._elevation.offset,this._updateElevationAlignedLocation(),this._updateEngineObject(),this.events.emit("location-update",{location:this._location})}_updateElevationAlignedLocation(){this._elevationAlignedLocation.x=this.location.x,this._elevationAlignedLocation.y=this.location.y;const e=h(this._elevation.override)?this._elevation.override:this.location.z||0;this._elevationAlignedLocation.z=e+this._elevation.offset,this._elevationAlignedLocation.spatialReference=ml(this.location.spatialReference),this._renderLocationDirty=!0,this._screenLocationDirty=!0,this._elevationAlignedLocationDirty=!1}grabbableForEvent(){return!0}get grabbing(){return this._grabbing}set grabbing(e){e!==this._grabbing&&(this._grabbing=e,this._setFocused(this._hovering||this._grabbing),this._updateEngineObject())}get hovering(){return this._hovering}set hovering(e){e!==this._hovering&&(this._hovering=e,this._setFocused(this._hovering||this._grabbing),this._updateEngineObject())}get selected(){return this._selected}set selected(e){e!==this._selected&&(this._selected=e,this._updateEngineObject(),this.events.emit("select-changed",{action:e?"select":"deselect"}))}get state(){return this._state}set state(e){e!==this._state&&(this._state=e,this._updateEngineObject())}updateStateEnabled(e,i){i?this.state|=e:this.state&=~e}_setFocused(e){e!==this._focused&&(this._focused=e,this.events.emit("focus-changed",{action:e===!0?"focus":"unfocus"}))}get focused(){return this._focused}get screenLocation(){return this._ensureScreenLocation(),this._screenLocation}_ensureScreenLocation(){if(!this._screenLocationDirty)return;this._screenLocation.pixelSize=this._camera.computeScreenPixelSizeAt(this.renderLocation),this._screenLocationDirty=!1;let e;if(Hr(this._modelTransform)){const i=this._calculateModelTransformOffset(Ad);e=H(i,i,this.renderLocation)}else e=this.renderLocation;this._camera.projectToRenderScreen(e,this._screenLocation.renderScreenPointArray),this._camera.renderToScreen(this._screenLocation.renderScreenPointArray,this._screenLocation.screenPointArray)}get applyObjectTransform(){return this._applyObjectTransform}set applyObjectTransform(e){this._applyObjectTransform=e,this._screenLocationDirty=!0,this._updateEngineObject()}get attached(){return this._attached}intersectionDistance(e,i){var r;if(!this.available)return null;const a=la(e,Ed),s=this._getCollisionRadius(i),n=-1*this.collisionPriority;switch(this.collisionType.type){case"point":if(Qs(this.screenLocation.screenPointArray,a)<s*s)return this.screenLocation.renderScreenPointArray[2]+n;break;case"line":{const o=this.collisionType.paths,l=this._getWorldToScreenObjectScale(),p=this._calculateObjectTransform(l,Ia),u=s*this.screenLocation.pixelSize,d=hi(this._camera,a,Cs);if(m(d))return null;for(const _ of o){if(_.length===0)continue;const f=me(Wi,_[0],p);for(let v=1;v<_.length;v++){const M=me(Ur,_[v],p),E=yh(Ri(f,M,kr),d);if(E!=null&&E<u*u){const w=H(S.get(),f,M);Q(w,w,.5);const A=un(S.get());return this._camera.projectToRenderScreen(w,A),A[2]+n}B(f,M)}}break}case"disc":{const o=this.collisionType.direction,l=(r=this.collisionType.offset)!=null?r:vi,p=this._getWorldToScreenObjectScale(),u=this._calculateObjectTransform(p,Ia),d=s*this.screenLocation.pixelSize,_=hi(this._camera,a,Cs);if(m(_))return null;const f=dn(jr,u),v=pn(Xr,o,f),M=me(Yr,l,u);Tt(M,v,Ga);const E=Br;if(qt(Ga,_,E)&&gn(E,M)<d*d)return this.screenLocation.renderScreenPointArray[2]+n;break}case"ribbon":{const{paths:o,direction:l}=this.collisionType,p=this._getWorldToScreenObjectScale(),u=this._calculateObjectTransform(p,Ia),d=s*this._camera.computeScreenPixelSizeAt(this.renderLocation),_=hi(this._camera,a,Cs);if(m(_))return null;const f=dn(jr,u),v=pn(Xr,l,f),M=this._calculateModelTransformPosition(Yr);Tt(M,v,Ga);const E=Br;if(!qt(Ga,_,E))break;for(const w of o){if(w.length===0)continue;const A=me(Wi,w[0],u);for(let F=1;F<w.length;F++){const ne=me(Ur,w[F],u),De=vh(Ri(A,ne,kr),E);if(De!=null&&De<d*d){const W=H(S.get(),A,ne);Q(W,W,.5);const ke=un(S.get());return this._camera.projectToRenderScreen(W,ke),ke[2]+n}B(A,ne)}}break}default:fl(this.collisionType)}return null}attach(e={manipulator3D:{}}){var a;if(!this.view._stage)return;const i=e.manipulator3D;if(m(i.engineLayerId)){const s=new ys({isPickable:!1,updatePolicy:Ma.SYNC});this.view._stage.add(s),i.engineLayerId=s.id,this._engineLayer=s}else((a=this.view._stage)==null?void 0:a.getObject)&&(this._engineLayer=this.view._stage.getObject(i.engineLayerId));i.engineLayerReferences=(i.engineLayerReferences||0)+1,this._materialIdReferences=i.materialIdReferences,m(this._materialIdReferences)&&(this._materialIdReferences=new Map,i.materialIdReferences=this._materialIdReferences),this._camera.copyFrom(this.view.state.camera),this._attached=!0,this._updateEngineObject(),vl(this._location.spatialReference,this.view.spatialReference)||(this.location=new Pt({x:0,y:0,z:0,spatialReference:this.view.spatialReference}))}detach(e={manipulator3D:{}}){const i=e.manipulator3D;i.engineLayerReferences--;const a=i.engineLayerReferences===0;a&&(i.engineLayerId=null),this._removeResourcesFromStage(a),this._engineResources=null,this._engineLayer=null,this._materialIdReferences=null,this._attached=!1}onViewChange(){this._camera.copyFrom(this.view.state.camera),this._screenLocationDirty=!0,this._updateEngineObject()}onElevationChange(e){rs(this.location,Wr,e.spatialReference),yl(e.extent,Wr)&&(this.location=this._location)}_evaluateElevationAlignment(e=this.location){if(m(this.elevationInfo))return!1;let i=null,a=0;const s=K(this.elevationInfo.offset,0);switch(this.elevationInfo.mode){case"on-the-ground":i=K(Ss(this.view.elevationProvider,e,"ground"),0);break;case"relative-to-ground":a=K(Ss(this.view.elevationProvider,e,"ground"),0)+s;break;case"relative-to-scene":a=K(Ss(this.view.elevationProvider,e,"scene"),0)+s;break;case"absolute-height":a=s}return(a!==this._elevation.offset||i!==this._elevation.override)&&(this._elevation.offset=a,this._elevation.override=i,!0)}_updateEngineObject(){if(!this._attached)return;if(!this.available)return void this._removeResourcesFromStage();const e=this._getWorldToScreenObjectScale(),i=Ia;if(this.autoScaleRenderObjects===!0){const r=this._getFocusedSize(this._radius,this.focused)*e;this._calculateObjectTransform(r,i)}else this._calculateObjectTransform(e,i);const{objectsByState:a}=this._ensureEngineResources(),s=(this.focused?x.Focused:x.Unfocused)|(this.selected?x.Selected:x.Unselected),n=this._noDisplayCount>0;for(const{stateMask:r,objects:o}of a){if(n){for(const _ of o)_.setVisible(!1);continue}const l=(r&x.All)!==x.None,p=(r&ae.All)!==ae.None,u=!l||(s&r)==(r&x.All),d=!p||(this.state&r)==(r&ae.All);if(u&&d)for(const _ of o)_.setVisible(!0),_.transformation=i;else for(const _ of o)_.setVisible(!1)}}_ensureEngineResources(){if(m(this._engineResources)){const e=C(this._engineLayer),i=[],a=new Set;this.renderObjects.forEach(({material:o})=>{a.has(o)||(i.push(o),a.add(o))});const s=(o,l)=>{const{geometry:p,material:u,transform:d}=l;Array.isArray(p)?p.forEach(_=>o.addGeometry(_,u,d)):o.addGeometry(p,u,d)},n=new Map;this._renderObjects.forEach(o=>{const l=new bs({castShadow:!1});s(l,o);const p=o.stateMask||0,u=n.get(p)||[];u.push(l),n.set(p,u)});const r=[];n.forEach((o,l)=>r.push({stateMask:l,objects:o})),this._engineResources={objectsByState:r,layer:e,materials:i}}return this._addResourcesToStage(),this._engineResources}_addResourcesToStage(){if(this._engineResourcesAddedToStage||m(this._engineResources))return;const{objectsByState:e,layer:i,materials:a}=this._engineResources;a.forEach(s=>{const n=C(this._materialIdReferences),r=n.get(s.id)||0;r===0&&this.view._stage.add(s),n.set(s.id,r+1)}),e.forEach(({objects:s})=>{i.addMany(s),this.view._stage.addMany(s)}),this._engineResourcesAddedToStage=!0}_removeResourcesFromStage(e=!1){if(!this._engineResourcesAddedToStage||m(this._engineResources)||!this.view._stage)return;const{objectsByState:i,layer:a,materials:s}=this._engineResources;i.forEach(({objects:n})=>{a.removeMany(n),this.view._stage.removeMany(n)}),s.forEach(n=>{const r=C(this._materialIdReferences),o=r.get(n.id);o===1?(this.view._stage.remove(n),r.delete(n.id)):r.set(n.id,o-1)}),e&&this.view._stage.remove(a),this._engineResourcesAddedToStage=!1}_getCollisionRadius(e){return this._getFocusedSize(this.radius,!0)*(e==="touch"?this.touchMultiplier:1)}_getFocusedSize(e,i){return e*(i?this.focusMultiplier:1)}_getWorldToScreenObjectScale(){return this._worldSized?1:this.screenLocation.pixelSize}_calculateModelTransformPosition(e){const i=this._getWorldToScreenObjectScale(),a=this._calculateObjectTransform(i,Od);return U(e,a[12],a[13],a[14])}_calculateModelTransformOffset(e){const i=this._calculateModelTransformPosition(e);return D(e,i,this.renderLocation)}_calculateObjectTransform(e,i){return bl(i,e,0,0,0,0,e,0,0,0,0,e,0,0,0,0,1),this._worldFrame&&Xe(i,i,this._worldFrame),Xe(i,i,this._modelTransform),i[12]+=this.renderLocation[0],i[13]+=this.renderLocation[1],i[14]+=this.renderLocation[2],i[15]=1,h(this._applyObjectTransform)&&this._applyObjectTransform(i),i}get test(){let e=!1;if(h(this._engineResources))for(const i in this._engineResources.objectsByState){const a=this._engineResources.objectsByState[i];for(const s of a.objects)if(s.isVisible){e=!0;break}if(e)break}return{areAnyResourcesVisible:e}}}function Hr(t){return t[12]!==0||t[13]!==0||t[14]!==0}function xd(t,e,i){switch(t.viewingMode){case"local":return os(i),!0;case"global":{const a=Ml(t.renderCoordsHelper.spatialReference);return Sl(e,0,Wi,0,a.radius),wl(tt(Wi[0]),tt(Wi[1]),i),!0}}}const Ed=Se(),kr=Pi(),Cs=fi(),jr=xl(),Od=_e(),Ia=_e(),Ga=Wt(),Wi=b(),Ur=b(),Br=b(),Xr=b(),Yr=b(),Ad=b(),Wr=new Pt({x:0,y:0,z:0,spatialReference:null});function Td(t){const e=new Di,{vertex:i,fragment:a}=e;return ms(i,t),e.include(Kn,t),e.attributes.add(O.POSITION,"vec3"),e.attributes.add(O.UV0,"vec2"),e.varyings.add("vpos","vec3"),t.hasMultipassTerrain&&e.varyings.add("depth","float"),i.uniforms.add(new It("textureCoordinateScaleFactor",s=>h(s.texture)&&h(s.texture.descriptor.textureCoordinateScaleFactor)?s.texture.descriptor.textureCoordinateScaleFactor:El)),i.code.add(R`
    void main(void) {
      vpos = position;
      ${t.hasMultipassTerrain?"depth = (view * vec4(vpos, 1.0)).z;":""}
      vTexCoord = uv0 * textureCoordinateScaleFactor;
      gl_Position = transformPosition(proj, view, vpos);
    }
  `),e.include(er,t),e.include(ir,t),a.uniforms.add([new gs("tex",s=>s.texture),new pe("opacity",s=>s.opacity)]),e.varyings.add("vTexCoord","vec2"),t.output===Y.Alpha?a.code.add(R`
    void main() {
      discardBySlice(vpos);
      ${t.hasMultipassTerrain?"terrainDepthTest(gl_FragCoord, depth);":""}

      float alpha = texture2D(tex, vTexCoord).a * opacity;
      if (alpha  < ${R.float(rr)}) {
        discard;
      }

      gl_FragColor = vec4(alpha);
    }
    `):(a.include(tr),a.code.add(R`
    void main() {
      discardBySlice(vpos);
      ${t.hasMultipassTerrain?"terrainDepthTest(gl_FragCoord, depth);":""}
      gl_FragColor = texture2D(tex, vTexCoord) * opacity;

      if (gl_FragColor.a < ${R.float(rr)}) {
        discard;
      }

      gl_FragColor = highlightSlice(gl_FragColor, vpos);
      ${t.transparencyPassType===We.Color?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
    }
    `)),e}const Pd=Object.freeze(Object.defineProperty({__proto__:null,build:Td},Symbol.toStringTag,{value:"Module"}));class Va extends Ci{initializeProgram(e){return new Li(e.rctx,Va.shader.get().build(this.configuration),_s)}_setPipelineState(e,i){const a=this.configuration,s=e===We.NONE,n=e===We.FrontFace;return Ii({blending:a.output!==Y.Color&&a.output!==Y.Alpha||!a.transparent?null:s?Rd:lr(e),culling:hr(a.cullFace),depthTest:{func:Bh(e)},depthWrite:s?a.writeDepth&&cr:dr(e),colorWrite:Gi,stencilWrite:a.hasOccludees?zh:null,stencilTest:a.hasOccludees?i?Nh:Fh:null,polygonOffset:s||n?null:Xh(a.enableOffset)})}initializePipeline(){return this._occludeePipelineState=this._setPipelineState(this.configuration.transparencyPassType,!0),this._setPipelineState(this.configuration.transparencyPassType,!1)}getPipelineState(e,i){return i?this._occludeePipelineState:super.getPipelineState(e,i)}}Va.shader=new $i(Pd,()=>import("./ImageMaterial.glsl.8a862cb7.js"));const Rd=vs(Ye.ONE,Ye.ONE_MINUS_SRC_ALPHA);class ze extends ar{constructor(){super(...arguments),this.output=Y.Color,this.cullFace=se.None,this.hasSlicePlane=!1,this.transparent=!1,this.enableOffset=!0,this.writeDepth=!0,this.hasOccludees=!1,this.transparencyPassType=We.NONE,this.hasMultipassTerrain=!1,this.cullAboveGround=!1}}c([k({count:Y.COUNT})],ze.prototype,"output",void 0),c([k({count:se.COUNT})],ze.prototype,"cullFace",void 0),c([k()],ze.prototype,"hasSlicePlane",void 0),c([k()],ze.prototype,"transparent",void 0),c([k()],ze.prototype,"enableOffset",void 0),c([k()],ze.prototype,"writeDepth",void 0),c([k()],ze.prototype,"hasOccludees",void 0),c([k({count:We.COUNT})],ze.prototype,"transparencyPassType",void 0),c([k()],ze.prototype,"hasMultipassTerrain",void 0),c([k()],ze.prototype,"cullAboveGround",void 0);class Dd extends sr{constructor(e){super(e,new Cd),this.supportsEdges=!0,this._configuration=new ze}getConfiguration(e,i){return this._configuration.output=e,this._configuration.cullFace=this.parameters.cullFace,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this.parameters.transparent,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.transparencyPassType=i.transparencyPassType,this._configuration.enableOffset=i.camera.relativeElevation<Yh,this._configuration.hasMultipassTerrain=i.multipassTerrain.enabled,this._configuration.cullAboveGround=i.multipassTerrain.cullAboveGround,this._configuration}intersect(e,i,a,s,n,r,o){fs(e,i,s,n,r,void 0,o)}requiresSlot(e,i){return i===Y.Color||i===Y.Alpha||i===Y.Highlight?e===Te.DRAPED_MATERIAL?!0:i===Y.Highlight?e===Te.OPAQUE_MATERIAL:e===(this.parameters.transparent?this.parameters.writeDepth?Te.TRANSPARENT_MATERIAL:Te.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL:Te.OPAQUE_MATERIAL):!1}createGLMaterial(e){return new $d(e)}createBufferWriter(){return new rc(oc)}}class $d extends Hh{constructor(e){super(L(L({},e),e.material.parameters))}_updateParameters(e){return this.updateTexture(this._material.parameters.textureId),this._material.setParameters(this.textureBindParameters),this.ensureTechnique(Va,e)}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&(this._material.setParameters({hasOccludees:e.hasOccludees}),this._updateParameters(e))}beginSlot(e){return this._output!==Y.Color&&this._output!==Y.Alpha||this._updateOccludeeState(e),this._updateParameters(e)}}class Cd extends nr{constructor(){super(...arguments),this.transparent=!1,this.writeDepth=!0,this.hasSlicePlane=!1,this.cullFace=se.None,this.hasOccludees=!1,this.opacity=1,this.textureId=null,this.initTextureTransparent=!0}}function ot(t,e=$.OccludeAndTransparent,i=!0){const a=Be(t[0],t[1],t[2],t.length>3?t[3]:1),s=t[3]<1;return i?new $s({color:a,transparent:s,writeDepth:!0,cullFace:se.Back,renderOccluded:e}):new Ze({color:a,transparent:s,writeDepth:!0,cullFace:se.Back,renderOccluded:e})}function Zi(t,e=$.OccludeAndTransparent){const i=Be(t[0],t[1],t[2],t.length===4?t[3]:1);return new Ze({color:i,transparent:!0,writeDepth:!0,cullFace:se.Front,renderOccluded:e})}const qi=Object.freeze({calloutLength:40,calloutWidth:1,discRadius:27,focusMultiplier:1.1,calloutColor:N(1,.5,0)});function Ld(t,e){const i=new ge({view:t,autoScaleRenderObjects:!1,collisionPriority:1,metadata:e.metadata});return Id(i,e),i}function Id(t,e){var v,M,E,w,A,F,ne,De;const i=(M=e.material)!=null?M:new Dd({transparent:!0,writeDepth:!1,textureId:(v=e.texture)==null?void 0:v.id,renderOccluded:$.Opaque}),a=(E=e.focusMultiplier)!=null?E:qi.focusMultiplier,s=(w=e.calloutLength)!=null?w:qi.calloutLength,n=qi.discRadius*((A=e.discScale)!=null?A:1),r=n*a,o=W=>{const ke=[0,1,2,2,3,0];return new Jn([[O.POSITION,{size:3,data:[s-W,-W,0,s+W,-W,0,s+W,W,0,s-W,W,0],exclusive:!0}],[O.UV0,{size:2,data:[0,0,1,0,1,1,0,1]}]],[[O.POSITION,ke],[O.UV0,ke]])},l=rt([[0,0,0],[s-n,0,0]]),p=rt([[0,0,0],[s-r,0,0]]),u=qi.calloutColor,d=(F=e.calloutWidth)!=null?F:qi.calloutWidth,_=new(d>1?Gt:ws)({width:d,color:Be(u[0],u[1],u[2],(ne=e.calloutOpacity)!=null?ne:1),renderOccluded:$.OccludeAndTransparent}),f=(De=e.customStateMask)!=null?De:ae.None;t.collisionType={type:"disc",direction:[0,0,1],offset:[s,0,0]},t.focusMultiplier=a,t.metadata=e.metadata,t.radius=n,t.renderObjects=[{geometry:o(n),material:i,stateMask:x.Unfocused|f},{geometry:l,material:_,stateMask:x.Unfocused|f},{geometry:o(r),material:i,stateMask:x.Focused|f},{geometry:p,material:_,stateMask:x.Focused|f}]}const Gd=Object.freeze({autoScaleRenderObjects:!1,worldSized:!0});function Zr(t,e,i,a){const s=D(S.get(),t,i),n=qr(s,we(S.get(),a,s),i,le.get());Ol(n,n);const r=me(S.get(),e,n);return Math.atan2(r[1],r[0])}function qr(t,e,i,a){const s=ie(S.get(),t),n=ie(S.get(),e),r=we(S.get(),s,n);return a[0]=s[0],a[1]=s[1],a[2]=s[2],a[3]=0,a[4]=n[0],a[5]=n[1],a[6]=n[2],a[7]=0,a[8]=r[0],a[9]=r[1],a[10]=r[2],a[11]=0,a[12]=i[0],a[13]=i[1],a[14]=i[2],a[15]=1,a}function za(t,e){const i=t.getViewForGraphic(e);return h(i)&&"computeAttachmentOrigin"in i?i.computeAttachmentOrigin(e,t.spatialReference):null}function Qr(t,e,i){const a=za(t,i);h(a)?e.elevationAlignedLocation=a:Vd(e,i.geometry)}function Vd(t,e){if(m(e))return;const i=e.type==="mesh"?e.anchor:lc(e);m(i)||(t.location=Al(i))}function Ht(t,e=J(t)){return e.mode!=="on-the-ground"&&!(m(t.geometry)||!t.geometry.hasZ)}var Ne;(function(t){t[t.NONE=0]="NONE",t[t.ANY=1]="ANY",t[t.Z=2]="Z",t[t.XY=4]="XY"})(Ne||(Ne={}));var V;(function(t){t[t.TRANSLATE_Z=0]="TRANSLATE_Z",t[t.TRANSLATE_XY=1]="TRANSLATE_XY",t[t.SCALE=2]="SCALE",t[t.ROTATE=3]="ROTATE",t[t.SCALE_ROTATE=4]="SCALE_ROTATE"})(V||(V={}));class Jr{constructor(){this.grabbingState=Ne.NONE,this.zManipulator=null,this.firstSelected=null,this.numSelected=0,this.firstGrabbedXY=null}update(e){this.grabbingState=Ne.NONE,this.zManipulator=null,this.numSelected=0,this.firstSelected=null,this.firstGrabbedXY=null,e.forEachManipulator((i,a)=>{if(a===V.TRANSLATE_Z&&(this.zManipulator=i),i instanceof ge&&(i.selected&&(this.numSelected===0&&(this.firstSelected=i),this.numSelected++),m(this.firstGrabbedXY)&&i.grabbing&&a===V.TRANSLATE_XY&&(this.firstGrabbedXY=i)),i.grabbing)switch(this.grabbingState|=Ne.ANY,a){case V.TRANSLATE_Z:this.grabbingState|=Ne.Z;break;case V.TRANSLATE_XY:this.grabbingState|=Ne.XY}})}}function zd(t){const{view:e,graphic:i}=t,a=new Ae({graphic:i}),s=Nd(t,a),n=[s,Fd(t,s.visualElement,a),e.maskOccludee(i),e.trackGraphicState(a)];return{visualElement:s.visualElement,remove:()=>ve(n).remove()}}function Nd(t,e){const{view:i,graphic:a}=t,s=new zt({view:i,geometry:Ls(a)?a.geometry:null,elevationInfo:J(a),attached:!1});y.visualElements.lineGraphics.shadowStyle.apply(s);const n=()=>{s.attached=e.displaying};y.visualElements.lineGraphics.outline.apply(s);const r=[I(()=>e.displaying,n),I(()=>e.isDraped,o=>{s.isDraped=o}),e.on("changed",()=>s.geometry=Ls(a)?a.geometry:null),xe(s)];return n(),{visualElement:s,remove:()=>ve(r).remove()}}function Fd(t,e,i){const{graphic:a,view:s}=t,n=[],r=J(a),o=r.mode==="on-the-ground"||!r.offset&&r.mode!=="absolute-height",l=new Jr,p=new Pa({view:s,extensionType:y.visualElements.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:$.OccludeAndTransparent});y.visualElements.pointGraphics.shadowStyle.apply(p);const u=tt(y.visualElements.heightPlaneAngleCutoff),d=new Ui({view:s,attached:!1,angleCutoff:u});y.visualElements.heightPlane.apply(d);let _=1,f=1;const v=()=>{if(l.update(t),!i.displaying||o&&(i.isDraped||!Ls(a)||!a.geometry.hasZ))return e.laserlineEnabled=!1,p.attached=!1,void(d.attached=!1);e.laserlineEnabled=!0;{const w=l.grabbingState&Ne.XY?y.visualElements.laserlineAlphaMultiplier:1;w!==_&&(_=w,y.visualElements.lineGraphics.shadowStyle.apply(e,w),y.visualElements.pointGraphics.shadowStyle.apply(p,w))}{const w=l.grabbingState&Ne.Z?y.visualElements.laserlineAlphaMultiplier:1;w!==f&&(f=w,y.visualElements.heightPlane.apply(d,w))}Hd(p,l),kd(t,e,d,l)};y.visualElements.zVerticalLine.apply(p),n.push(i.on("changed",v),I(()=>i.displaying,v),e.events.on("attachment-origin-changed",v),xe(p),xe(d));const M=[],E=()=>{ve(M).remove(),M.length=0,t.forEachManipulator(w=>M.push(w.events.on("grab-changed",v))),t.forEachManipulator(w=>M.push(w.events.on("select-changed",v))),v()};return E(),n.push(t.onManipulatorsChanged(E),_n(()=>ve(M))),ve(n)}function Hd(t,e){const i=e.numSelected===1?e.firstSelected:e.numSelected>1&&h(e.firstGrabbedXY)?e.firstGrabbedXY:null;h(i)?(t.setStartEndFromWorldDownAtLocation(i.renderLocation),t.attached=!0):t.attached=!1}function kd(t,e,i,a){if(a.numSelected>0){U(kt,0,0,0);let s=0;t.forEachManipulator((n,r)=>{r===V.TRANSLATE_XY&&n.selected&&n instanceof ge&&(H(kt,kt,n.renderLocation),s++)}),s>0?(i.heightManifoldTarget=Q(kt,kt,1/s),i.attached=!0):i.attached=!1}else{const s=e.attachmentOrigin;h(s)&&t.view.renderCoordsHelper.toRenderCoords(s,kt)?(i.heightManifoldTarget=kt,i.attached=!0):i.attached=!1}}function Ls(t){return h(t.geometry)&&(t.geometry.type==="polygon"||t.geometry.type==="polyline")}const kt=b();function jd(t){const{view:e,graphic:i}=t,a=new Ae({graphic:i}),s=[],n=Bd(t,a,s);return Ud(t,a,s,n),s.push(e.trackGraphicState(a)),{visualElement:n,remove(){ve(s).remove()}}}function Ud(t,e,i,a){const{view:s,graphic:n}=t,r=new Pa({view:s,extensionType:y.visualElements.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:$.OccludeAndTransparent});y.visualElements.zVerticalLine.apply(r);const o=new Ui({view:s,intersectsLineInfinite:!0,attached:!1});y.visualElements.pointGraphics.shadowStyle.apply(o);const l=tt(y.visualElements.heightPlaneAngleCutoff),p=new Ui({view:s,attached:!1,angleCutoff:l});y.visualElements.heightPlane.apply(p);const u=J(t.graphic),d=ei.fromElevationInfo(u),_=u.mode==="on-the-ground"||!u.offset&&u.mode!=="absolute-height",f=new Jr;let v=1,M=1;const E=()=>{f.update(t);const w=Is(n),A=_&&(e.isDraped||m(w)||!w.hasZ);let F=!0;if(!A&&h(w)){const Z=Sa(w,s.elevationProvider,d,s.renderCoordsHelper);U(Fe,w.x,w.y,Z),oa(Fe,w.spatialReference,Fe,s.renderCoordsHelper.spatialReference),r.setStartEndFromWorldDownAtLocation(Fe),o.intersectsWorldUpAtLocation=Fe}else F=!1;const ne=f.grabbingState&Ne.Z?y.visualElements.laserlineAlphaMultiplier:1;ne!==v&&(v=ne,y.visualElements.heightPlane.apply(p,ne));const De=rn(Zd);!A&&e.displaying&&a.calculateMapBounds(De)&&oa(Tl(De,Fe),s.spatialReference,Fe,s.renderCoordsHelper.spatialReference)?(p.heightManifoldTarget=Fe,p.attached=!0):p.attached=!1;const W=f.grabbingState&Ne.XY?y.visualElements.laserlineAlphaMultiplier:1;W!==M&&(M=W,y.visualElements.pointGraphics.shadowStyle.apply(o,W));const ke=F&&e.displaying&&!A;o.attached=ke,r.attached=ke};i.push(I(()=>[e.displaying,e.isDraped],E),e.on("changed",E)),t.forEachManipulator(w=>{i.push(w.events.on("grab-changed",E))}),i.push(xe(o)),i.push(xe(r)),i.push(xe(p)),E()}function Bd(t,e,i){const{view:a,graphic:s}=t,n=new Ps({view:a,geometry:Is(s),elevationInfo:J(s),attached:!1});return Xd(t,n,e,i),i.push(xe(n)),n}function Is(t){const e=t.geometry;return m(e)?null:e.type==="point"?e:e.type==="mesh"?e.anchor.clone():null}function Xd(t,e,i,a){const s=()=>e.attached=i.displaying;Yd(t,e,i,a),y.visualElements.pointGraphics.outline.apply(e),a.push(I(()=>i.displaying,s,Ue))}function Yd(t,e,i,a){const{view:s,graphic:n}=t;let r=null;const o=p=>{h(r)&&(r.remove(),r=null),i.isDraped&&h(p)&&(r=Wd(s,p,()=>{e.geometry=p}))},l=()=>{const p=Is(n);o(p),e.geometry=p};a.push(i.on("changed",l),_n(()=>r)),l()}function Wd(t,e,i){const a=t.elevationProvider.spatialReference;Pl(e,Fe,a);const s=Fe[0],n=Fe[1];return t.elevationProvider.on("elevation-change",r=>{mn(r.extent,s,n)&&i()})}const Fe=b(),Zd=nn();function Na(t){switch(C(t.graphic.geometry).type){case"point":case"mesh":return jd(t);case"polygon":case"polyline":return zd(t);default:return null}}const qd=[1,.5,0],Kr=128,Ke=70,Qd=80,eo=.02,Jd=54,Kd=100,to=Math.ceil(Ke/3*2),jt=160,Gs=.5,Vs=24,ci=9,ep=jt+30,io=jt+53,tp=60,ip=23,ap=5*Math.PI/12,sp=1*Math.PI/3,ao=10,so=.2,no=30,ro=53,oo=.2,lo=.3,np=200,rp=3,op=1e6;class Qi{constructor(){this._available=!0}set location(e){this._forEachManipulator3D(i=>i.location=e)}set elevationAlignedLocation(e){this._forEachManipulator3D(i=>i.elevationAlignedLocation=e)}set elevationInfo(e){this._forEachManipulator3D(i=>i.elevationInfo=e)}get renderLocation(){let e;return this._forEachManipulator3D(i=>{e||(e=i.renderLocation)}),e}get available(){return this._available}set available(e){this._available=e,this._forEachManipulator3D(i=>i.available=e)}get hovering(){return this.someManipulator(e=>e.hovering)}get grabbing(){return this.someManipulator(e=>e.grabbing)}get dragging(){return this.someManipulator(e=>e.dragging)}hasManipulator(e){return this.someManipulator(i=>i===e)}someManipulator(e){let i=!1;return this.forEachManipulator(a=>{!i&&e(a)&&(i=!0)}),i}_forEachManipulator3D(e){this.forEachManipulator((i,a)=>{i instanceof ge&&e(i,a)})}}function Fa(t,e){return ho(t,()=>e)}function lp(t){return ho(t,e=>e.plane)}function ho(t,e){const i=b(),a=b();let s=!1;return n=>{const r=e(n);if(n.action==="start"){const p=la(n.screenStart,fn(ft.get())),u=hi(t.state.camera,p,_o);h(u)&&(s=qt(r,u,i))}if(!s)return null;const o=la(n.screenEnd,fn(ft.get())),l=hi(t.state.camera,o,_o);return m(l)?null:qt(r,l,a)?z(L({},n),{renderStart:i,renderEnd:a,plane:r,ray:l}):null}}function hp(t,e,i,a=null,s=null){let n=null;return r=>{if(r.action==="start"&&(n=t.sceneIntersectionHelper.intersectElevationFromScreen(Se(r.screenStart.x,r.screenStart.y),e,i,s),h(n)&&h(a)&&!rs(n,n,a))||m(n))return null;const o=t.sceneIntersectionHelper.intersectElevationFromScreen(Se(r.screenEnd.x,r.screenEnd.y),e,i,s);return h(o)?h(a)&&!rs(o,o,a)?null:z(L({},r),{mapStart:n,mapEnd:o}):null}}function Ha(t,e,i,a=null,s=null){return hp(t,i,vn(e,t,i),a,s)}function co(t,e,i,a=null,s=null){return Ha(t,i,J(e),a,s)}function cp(t,e,i,a){const s=e.toMap(t.screenStart,{include:[i]});return h(s)?co(e,i,s,a):null}function dp(t,e){const i=up,a=gp,s=Wt();t.renderCoordsHelper.worldUpAtPosition(e,i);const n=we(s,i,D(a,e,t.state.camera.eye));return we(n,n,i),Tt(e,n,s)}function po(t,e,i){let a=null;const s=new ls;return s.next(Fa(t,dp(t,e))).next(pp(t,e)).next(uo(t,i)).next(n=>{n.mapEnd.x=n.mapStart.x,n.mapEnd.y=n.mapStart.y,a=n}),n=>(a=null,s.execute(n),a)}function pp(t,e){const i=b(),a=fe(e);t.renderCoordsHelper.worldUpAtPosition(e,i);const s=b(),n=b(),r=o=>(D(o,o,e),Rl(i,o,o),t.viewingMode==="global"&&fe(o)*Math.sign(Si(i,o))<.001-a&&D(o,Q(o,i,.001),e),H(o,o,e),o);return o=>(o.renderStart=r(B(s,o.renderStart)),o.renderEnd=r(B(n,o.renderEnd)),o)}function uo(t,e){const i=t.renderCoordsHelper;return a=>{const s=i.fromRenderCoords(a.renderStart,e),n=i.fromRenderCoords(a.renderEnd,e);return h(s)&&h(n)?z(L({},a),{mapStart:s,mapEnd:n}):null}}var go;(function(t){t[t.GROUND=0]="GROUND",t[t.OTHER=1]="OTHER"})(go||(go={}));const up=b(),gp=b(),_o=fi();function ka(t,e,i,a){const s=t.graphic,n=(r,o)=>e({action:r,graphic:s,dxScreen:o.screenDeltaX,dyScreen:o.screenDeltaY});return i((r,o,l)=>{const p=o.next(u=>(u.action==="start"&&n("start",u),u)).next(Dl(s,a)).next(u=>{switch(u.action){case"start":case"update":(u.translationX||u.translationY||u.translationZ)&&n("update",u);break;case"end":n("end",u)}return u});return l.next($l(s)).next(()=>{n("end",{screenDeltaX:0,screenDeltaY:0})}),p})}function mo(t){if(m(t)||t.type!=="polyline"&&t.type!=="polygon")return 0;const e=(t.type==="polyline"?t.paths:t.rings)[0];if(!e||e.length<2)return 0;const i=e[0],a=e[1];return Math.atan2(a[1]-i[1],a[0]-i[0])}function ja(t){if(m(t)||m(t.axis))return 1;const{mapStart:e,mapEnd:i,axis:a}=t,s=[i.x-e.x,i.y-e.y];return s[0]*a[0]+s[1]*a[1]>0?1:-1}class _p extends Qi{constructor(e){super(),this._handles=new it,this._arrowManipulatorInfos=new Array,this._opaqueMaterial=this._createMaterial(),this._transparentMaterial=this._createMaterial(.5),this._angle=0,this._scale=1,this._radius=Ke,this._updateAfterDrag=!1,this.events=new Le,this._tool=e.tool,this._view=e.view,e.radius!=null&&(this._radius=e.radius),this._createManipulators(),this.forEachManipulator(i=>this._tool.manipulators.add(i))}set orthogonalAvailable(e){this._arrowManipulatorInfos[1].manipulator.available=e,this._arrowManipulatorInfos[3].manipulator.available=e}destroy(){this.forEachManipulator(e=>{this._tool.manipulators.remove(e),e.destroy()}),this._handles=X(this._handles),this._tool=null,this._view=null,this._arrowManipulatorInfos.length=0}forEachManipulator(e){for(const{manipulator:i}of this._arrowManipulatorInfos)e(i,V.TRANSLATE_XY)}createGraphicDragPipeline(e,i,a){const s=i.graphic,n=J(s),r=C(s.geometry).spatialReference;return ka(i,a,o=>this.createDragPipeline((l,p,u,d,_)=>o(l,e(l,p,u,d,_),u),n,r,s),this._view.state.viewingMode)}createDragPipeline(e,i,a,s){return ve(this._arrowManipulatorInfos.map(({manipulator:n},r)=>Ie(n,(o,l,p,u,d)=>{const _=l.next(f=>z(L({},f),{manipulatorType:V.TRANSLATE_XY})).next(wi(this._view,o.elevationAlignedLocation)).next(Ha(this._view,o.elevationAlignedLocation,i,a,s)).next(Cl(o.location,this.angle+(r+1)*Math.PI*.5)).next(Qt());e(o,_,p,u,d)})))}get angle(){return this._angle}set angle(e){this._angle=e,this.dragging?this._updateAfterDrag=!0:this._updateManipulatorTransform()}get displayScale(){return this._scale}set displayScale(e){this._scale=e,this._updateManipulatorTransform()}get radius(){return this._radius}set radius(e){this._radius!==e&&(this._radius=e,this._updateManipulators())}_updateManipulators(){for(let e=0;e<this._arrowManipulatorInfos.length;e++)this._updateArrowManipulator(this._arrowManipulatorInfos[e],e);this._updateManipulatorTransform()}_updateArrowManipulator({manipulator:e,transform:i},a){const s=this._radius/Ke,n=Jd*s,r=n*Math.sqrt(3)/2,o=zi(r,n/2,n/2,eo);gr(o,is(le.get(),U(S.get(),0,-r/3,0))),e.renderObjects=[{geometry:o,material:this._opaqueMaterial,stateMask:x.Focused},{geometry:o,material:this._transparentMaterial,stateMask:x.Unfocused}],e.radius=r/3*2*1.2;const l=hs(le.get(),a*Math.PI/2),p=is(le.get(),U(S.get(),0,Kd*s,0));Xe(i,l,p)}_createManipulators(){for(let e=0;e<4;e++){const i=this._createArrowManipulator(e);this._arrowManipulatorInfos.push(i)}this._updateManipulatorTransform()}_updateManipulatorTransform(){const e=this.angle,i=yn(le.get(),e,N(0,0,1));if(m(i))return;const a=ha(le.get(),U(S.get(),this.displayScale,this.displayScale,this.displayScale)),s=Xe(le.get(),a,i);for(const n of this._arrowManipulatorInfos){const r=Xe(le.get(),s,n.transform);n.manipulator.modelTransform=r}}_createArrowManipulator(e){const i=new ge({view:this._view,autoScaleRenderObjects:!1,worldOriented:!0,focusMultiplier:1,touchMultiplier:1,collisionType:{type:"disc",direction:N(0,0,1)}}),a={manipulator:i,transform:_e()};return this._updateArrowManipulator(a,e),this._handles.add(i.events.on("drag",s=>{this._updateAfterDrag&&s.action==="end"&&!this.dragging&&(this._updateManipulatorTransform(),this._updateAfterDrag=!1)})),a}_createMaterial(e=1){const i=te.toUnitRGBA(T.main);return i[3]*=e,new Ze({color:i,transparent:e!==1,cullFace:se.Back,renderOccluded:$.Transparent})}get test(){return{arrowManipulators:this._arrowManipulatorInfos.map(({manipulator:e})=>e)}}}class mp{constructor(){this._view=null,this._elevationInfo=null,this._lastDragEvent=null,this.next=new ls,this._enabled=!1}get enabled(){return this._enabled}set enabled(e){if(this._enabled!==e&&h(this._lastDragEvent)){const i=this._lastDragEvent.mapEnd,a=this._snap(this._lastDragEvent.screenEnd);if(h(a)){const s={action:"update",mapStart:this._lastDragEvent.mapStart,mapEnd:e===!0?a:i,screenStart:this._lastDragEvent.screenEnd,screenEnd:this._lastDragEvent.screenEnd};this.next.execute(s)}}this._enabled=e}_snap(e){const i=h(this._view)?this._view.toMap(e,{exclude:[]}):null;return h(i)&&h(this._view)&&(i.z=vn(i,this._view,this._elevationInfo)),i}createDragEventPipelineStep(e,i){return this._view=e,this._elevationInfo=i,this._lastDragEvent=null,a=>{if(this._lastDragEvent=a.action!=="end"?L({},a):null,this._enabled){const s=this._snap(a.screenEnd);return h(s)?{action:a.action,mapStart:a.mapStart,mapEnd:s,screenStart:a.screenStart,screenEnd:a.screenEnd}:null}return{action:a.action,mapStart:a.mapStart,mapEnd:a.mapEnd,screenStart:a.screenStart,screenEnd:a.screenEnd}}}}class fp extends Qi{constructor(e){super(),this._snapToScene=new mp,this._discMaterial=this._createMaterial(),this._discMaterialTransparent=this._createMaterial(.5),this._scale=1,this._radius=Ke,this._view=e.view,this._tool=e.tool,e.snapToScene!=null&&(this.snapToScene=e.snapToScene),e.radius!=null&&(this._radius=e.radius),this._createManipulator(),this.forEachManipulator(i=>this._tool.manipulators.add(i))}destroy(){this.forEachManipulator(e=>{this._tool.manipulators.remove(e),e.destroy()}),this._tool=null,this._view=null,this._manipulator=null}forEachManipulator(e){e(this._manipulator,V.TRANSLATE_XY)}get displayScale(){return this._scale}set displayScale(e){this._scale=e,this._updateManipulatorTransform()}get snapToScene(){return this._snapToScene.enabled}set snapToScene(e){this._snapToScene.enabled=e}get radius(){return this._radius}set radius(e){e!==this._radius&&(this._radius=e,this._updateManipulator())}createGraphicDragPipeline(e,i,a){const s=i.graphic,n=J(s),r=C(s.geometry).spatialReference;return ka(i,a,o=>this.createDragPipeline((l,p,u,d,_)=>o(l,e(l,p,u,d,_),u),n,r,s),this._view.state.viewingMode)}createDragPipeline(e,i,a,s){const n=this._view;return Ie(this._manipulator,(r,o,l,p,u)=>{const d=o.next(wi(n,r.elevationAlignedLocation)).next(Ha(n,r.elevationAlignedLocation,i,a,s)).next(this._snapToScene.createDragEventPipelineStep(n,i),this._snapToScene.next).next(_=>z(L({},_),{manipulatorType:V.TRANSLATE_XY})).next(Qt());e(r,d,l,p,u)})}_updateManipulatorTransform(){const e=ha(le.get(),U(S.get(),this.displayScale,this.displayScale,this.displayScale));this._manipulator.modelTransform=e}_createManipulator(){const e=this._view;this._manipulator=new ge({view:e,worldSized:!1,autoScaleRenderObjects:!1,focusMultiplier:1,touchMultiplier:1,collisionType:{type:"disc",direction:N(0,0,1)},worldOriented:!0}),this._updateManipulator()}_updateManipulator(){const e=hc(eo,1,Kr,N(0,0,1),N(0,0,0)),i=ha(_e(),N(this._radius,this._radius,this._radius));this._manipulator.renderObjects=[{geometry:e,material:this._discMaterial,transform:i,stateMask:x.Focused},{geometry:e,material:this._discMaterialTransparent,transform:i,stateMask:x.Unfocused}],this._manipulator.radius=Qd*(this._radius/Ke)}_createMaterial(e=1){const i=te.toUnitRGBA(T.main);return i[3]*=e,new Ze({color:i,transparent:e!==1,cullFace:se.Back,renderOccluded:$.Transparent})}get test(){return{discManipulator:this._manipulator}}}class vp extends Qi{constructor(e){super(),this._radius=Ke,this.events=new Le,this._tool=e.tool,this._view=e.view,e.radius!=null&&(this._radius=e.radius),this._createManipulator(),this.forEachManipulator(i=>this._tool.manipulators.add(i))}destroy(){this.forEachManipulator(e=>{this._tool.manipulators.remove(e),e.destroy()})}forEachManipulator(e){e(this._manipulator,V.TRANSLATE_Z)}createGraphicDragPipeline(e,i,a){const s=C(i.graphic.geometry).spatialReference;return ka(i,a,n=>this.createDragPipeline((r,o,l,p,u)=>n(r,e(r,o,l,p,u),l),s),this._view.state.viewingMode)}createDragPipeline(e,i){const a=this._view;return Ie(this._manipulator,(s,n,r,o,l)=>{const p=n.next(u=>z(L({},u),{manipulatorType:V.TRANSLATE_Z})).next(po(a,s.renderLocation,i)).next(Qt());e(s,p,r,o,l)})}get radius(){return this._radius}set radius(e){e!==this._radius&&(this._radius=e,this._updateManipulator())}_updateManipulator(){const e=this._radius/Ke,i=y.zManipulator.height*e,a=y.zManipulator.coneHeight*e,s=y.zManipulator.coneWidth*e,n=y.zManipulator.width*e,r=[N(0,0,0),N(0,0,i)],o=cc(r,n/2,16,!1),l=xs(a,s/2,16,!1),p=[N(0,0,0),N(0,0,i+a)],u=w=>{const A=_e();if(aa(A,A,[0,0,i]),bn(A,A,Math.PI/2),w){const F=1+2*w/s;yi(A,A,[F,F,F])}return A},d=u(0),_=(w,A)=>{const F=Il(y.zManipulator.color,A);return[F.r/255,F.g/255,F.b/255,y.zManipulator.color.a*w]},f=ot(_(1,.25),$.Occlude),v=ot(_(1,0),$.Occlude),M=ot(_(.7,0),y.zManipulator.renderOccluded),E=ot(_(.85,0),y.zManipulator.renderOccluded);this._manipulator.renderObjects=[{geometry:l,transform:d,material:f,stateMask:x.Unfocused},{geometry:o,material:f,stateMask:x.Unfocused},{geometry:l,transform:d,material:v,stateMask:x.Focused},{geometry:o,material:v,stateMask:x.Focused},{geometry:l,transform:d,material:M,stateMask:x.Unfocused},{geometry:o,material:M,stateMask:x.Unfocused},{geometry:l,transform:d,material:E,stateMask:x.Focused},{geometry:o,material:E,stateMask:x.Focused}],this._manipulator.radius=n/2+2,this._manipulator.collisionType={type:"line",paths:[p]}}_createManipulator(){const e=new ge({view:this._view,autoScaleRenderObjects:!1,worldSized:!1,selectable:!1,cursor:"ns-resize",elevationInfo:this.elevationInfo,worldOriented:!0,collisionPriority:1.6});e.applyObjectTransform=i=>{const a=this._view.state.camera,s=fo;this._view.renderCoordsHelper.toRenderCoords(this._manipulator.elevationAlignedLocation,s);const n=Ll(a.eye,s),r=a.computeRenderPixelSizeAtDist(n),o=D(di,s,a.eye);ie(o,o);const l=yp;this._view.renderCoordsHelper.worldUpAtPosition(fo,l);const p=Math.abs(Si(o,l)),u=we(di,o,l),d=we(di,u,l),_=ra(p,.01,1),f=1-Math.sqrt(1-_*_)/_/a.fullWidth,v=this._radius/Ke,M=y.zManipulator.width*v;Q(d,ie(d,d),(1/f-1)*n+r*M),i[12]-=di[0],i[13]-=di[1],i[14]-=di[2]},this._manipulator=e,this._updateManipulator()}get test(){return{manipulator:this._manipulator}}}const fo=b(),di=b(),yp=b();class Ut extends Qi{constructor(e){super(),this._handles=new it,this._interactive=!0;const{tool:i,view:a,snapToScene:s,radius:n}=e;this._view=a,this.xyManipulation=new fp({tool:i,view:a,snapToScene:s,radius:n}),this.xyAxisManipulation=new _p({tool:i,view:a,radius:n}),this.zManipulation=new vp({tool:i,view:a,radius:n}),this.xyManipulation.available=e.xyAvailable,this.xyAxisManipulation.available=e.xyAxisAvailable,this.zManipulation.available=e.zAvailable,this._autoHideXYAxis(),this.forEachManipulator(r=>{this._handles.add(r.events.on("grab-changed",()=>this._updateManipulatorInteractivity()))})}destroy(){this._handles.destroy(),this.xyManipulation.destroy(),this.xyAxisManipulation.destroy(),this.zManipulation.destroy()}createGraphicDragPipeline(e,i,a){return ve([this.xyManipulation.createGraphicDragPipeline((s,n,r,o,l)=>e(P.XY,s,n,r,o,l),i,a),this.xyAxisManipulation.createGraphicDragPipeline((s,n,r,o,l)=>e(P.XY_AXIS,s,n,r,o,l),i,a),this.zManipulation.createGraphicDragPipeline((s,n,r,o,l)=>e(P.Z,s,n,r,o,l),i,a)])}createDragPipeline(e,i,a,s){return ve([this.xyManipulation.createDragPipeline((n,r,o,l,p)=>e(P.XY,n,r,o,l,p),i,a,s),this.xyAxisManipulation.createDragPipeline((n,r,o,l,p)=>e(P.XY_AXIS,n,r,o,l,p),i,a,s),this.zManipulation.createDragPipeline((n,r,o,l,p)=>e(P.Z,n,r,o,l,p),a)])}set snapToScene(e){this.xyManipulation.snapToScene=e}set angle(e){this.xyAxisManipulation.angle=e}set interactive(e){this._interactive!==e&&(this._interactive=e,this._updateManipulatorInteractivity())}set radius(e){this.xyAxisManipulation.radius=e,this.xyManipulation.radius=e,this.zManipulation.radius=e}set displayScale(e){this.xyManipulation.displayScale=e,this.xyAxisManipulation.displayScale=e}forEachManipulator(e){this.xyManipulation.forEachManipulator(i=>e(i,V.TRANSLATE_XY)),this.xyAxisManipulation.forEachManipulator(i=>e(i,V.TRANSLATE_XY)),this.zManipulation.forEachManipulator(i=>e(i,V.TRANSLATE_Z))}get _xyAxisVisible(){const e=this.xyManipulation.someManipulator(i=>i.focused)||this.xyAxisManipulation.someManipulator(i=>i.focused);return this._view.inputManager&&this._view.inputManager.latestPointerType==="touch"||e}_autoHideXYAxis(){const e=this.xyAxisManipulation,i=this.xyManipulation;if(Mn("esri-mobile"))return;const a=[];i.forEachManipulator(n=>a.push(n)),e.forEachManipulator(n=>a.push(n));const s=()=>{const n=[];this._xyAxisVisible||e.forEachManipulator(r=>n.push(r.disableDisplay())),this._handles.remove(vo),this._handles.add(n,vo)};for(const n of a)this._handles.add(n.events.on("focus-changed",s));this._view.inputManager&&this._handles.add(Jt(()=>{var n;return(n=this._view.inputManager)==null?void 0:n.latestPointerType},s)),s()}_updateManipulatorInteractivity(){const e=this.grabbing;this.forEachManipulator(i=>{i.interactive=!e&&this._interactive||i.grabbing})}static radiusForSymbol(e){const i=h(e)&&e.type==="point-3d"&&e.symbolLayers;return!!i&&i.length>0&&i.some(a=>a.type==="icon")?to:Ke}}const vo="disable-xy-axis-display";var P;(function(t){t[t.XY=0]="XY",t[t.XY_AXIS=1]="XY_AXIS",t[t.Z=2]="Z"})(P||(P={}));class zs extends Qi{constructor(e){super(),this._view=e.view,this._tool=e.tool,this._graphicState=e.graphicState,this._createManipulator(),this.forEachManipulator(i=>this._tool.manipulators.add(i))}destroy(){this.forEachManipulator(e=>{this._tool.manipulators.remove(e),e.destroy()}),this._tool=null,this._view=null,this._manipulator=null,this._graphicState=null}forEachManipulator(e){e(this._manipulator,V.TRANSLATE_XY)}createGraphicDragPipeline(e){return ka(this._graphicState,e,i=>this.createDragPipeline(i),this._view.state.viewingMode)}createDragPipeline(e){const i=this._view,a=this._graphicState.graphic,s=h(a.geometry)?a.geometry.spatialReference:null;return Ie(this._manipulator,(n,r,o,l,p)=>{const u=r.next(cp(p,i,a,s)).next(Kt()).next(Qt());e(n,u,o,l,p)})}_createManipulator(){const e=this._view,i=this._graphicState.graphic;this._manipulator=new mc({graphic:i,view:e,selectable:!0,cursor:"move"})}}class bp{constructor(e){this.allGraphics=e,this.type="graphic-move-start"}}class Mp{constructor(e,i,a){this.dx=e,this.dy=i,this.allGraphics=a,this.type="graphic-move"}}class yo{constructor(e){this.allGraphics=e,this.type="graphic-move-stop"}}let et=class extends Sn(Le.EventedMixin(ca)){constructor(t){super(t),this.graphics=new Gl,this.enableZ=!0,this.tooltipOptions=new vt,this.type="move-3d",this._snappingPipeline=new da,this._tooltip=null}initialize(){const{graphics:t,view:e}=this;this.addHandles([t.on("change",()=>this._refreshManipulators()),I(()=>this.tooltipOptions.enabled,i=>{this._tooltip=i?new Ai({view:e}):X(this._tooltip)},cs)]),this._refreshManipulators(),this.finishToolCreation()}destroy(){this._tooltip=X(this._tooltip),this._moveManipulation=X(this._moveManipulation),this.graphics.removeAll(),this._set("view",null)}get updating(){return this.updatingHandles.updating}reset(){}_refreshManipulators(){this.handles.removeAll(),this._moveManipulation&&this._moveManipulation.destroy(),this.manipulators.removeAll();const t=this.graphics.toArray().filter(e=>Vl(e)===wn.SUPPORTED).map(e=>new Sp(e));t.length&&(this._createManipulators(t),this._createVisualElements(t),this.handles.add(t.map(e=>this.view.trackGraphicState(e.state))),this._updateMoveManipulation(t))}_createManipulators(t){for(const e of t){const i=e.state;e.manipulationXY=new zs({tool:this,view:this.view,graphicState:i}),e.manipulationXY.forEachManipulator(a=>this.handles.add([a.events.on("immediate-click",s=>{this.emit("immediate-click",z(L({},s),{graphic:i.graphic})),s.stopPropagation()}),a.events.on("grab-changed",({action:s})=>{const{tooltipOptions:n,_tooltip:r}=this;m(r)||(s==="start"?r.info=new Fi({tooltipOptions:n}):r.clear())})])),this.handles.add(e.manipulationXY.createDragPipeline((a,s,n,r)=>this._buildDragEventPipeline(t,P.XY,a,s,n,r)))}this._createMoveManipulation(t)}_createMoveManipulation(t){const e=new Ut({tool:this,view:this.view,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:t.length===1?Ut.radiusForSymbol(t[0].graphic.symbol):Ke});this._moveManipulation=e,e.elevationInfo={mode:"absolute-height",offset:0},e.forEachManipulator(n=>{this.handles.add(n.events.on("immediate-click",r=>{e.zManipulation.hasManipulator(n)||this.graphics.length!==1||this.emit("immediate-click",z(L({},r),{graphic:this.graphics.getItemAt(0)})),r.stopPropagation()}))});const i=n=>r=>{this.handles.add(r.events.on("focus-changed",({action:o})=>{const l=this._tooltip;m(l)||(o==="focus"?this._updateMoveTooltip(t,n):l.clear())}))};this._moveManipulation.xyManipulation.forEachManipulator(i(P.XY)),this._moveManipulation.xyAxisManipulation.forEachManipulator(i(P.XY_AXIS)),this._moveManipulation.zManipulation.forEachManipulator(i(P.Z));const a=()=>this._updateMoveManipulation(t);for(const n of t)this.handles.add([n.state.on("changed",a),I(()=>n.state.displaying,a)]);const s=t[t.length-1];this.handles.add(s.state.on("changed",()=>this._updateMoveManipulationAngle(s))),this.handles.add(e.createDragPipeline((n,r,o,l,p)=>this._buildDragEventPipeline(t,n,r,o,l,p),J(s.graphic),C(s.graphic.geometry).spatialReference,s.graphic)),this._updateMoveManipulationAngle(s)}_createVisualElements(t){for(const e of t){const i=e.graphic,a=Na({view:this.view,graphic:i,forEachManipulator:s=>{e.manipulationXY.forEachManipulator(s),this._moveManipulation.forEachManipulator(s)},onManipulatorsChanged:()=>Ot()});m(a)||(e.geometryRepresentation=a.visualElement,e.geometryRepresentation instanceof zt&&this.handles.add([e.geometryRepresentation.events.on("attachment-origin-changed",()=>{e.state.isDraped||this._updateMoveManipulation(t)}),I(()=>e.state.isDraped,()=>this._updateMoveManipulation(t))]),this.handles.add(a))}}_updateMoveManipulationAngle(t){this._moveManipulation.angle=mo(t.graphic.geometry)}_updateMoveManipulation(t){const e=Mi(0,0,0,this.view.spatialReference);let i=0,a=!1;const s=this._moveManipulation;for(const n of t){if(!n.state.displaying)continue;const r=n.state.graphic;this.enableZ&&Ht(r)&&(a=!0);const o=n.geometryRepresentation instanceof zt&&!n.state.isDraped?n.geometryRepresentation.attachmentOrigin:za(this.view,r);h(o)&&(e.x+=o.x,e.y+=o.y,e.z+=o.z,i++)}i>0?(e.x/=i,e.y/=i,e.z/=i,s.location=e,s.xyManipulation.available=!0,s.xyAxisManipulation.available=!0,s.zManipulation.available=a):s.available=!1}_buildDragEventPipeline(t,e,i,a,s,n){const r=[],o=[];let l=null,p=null;const u=()=>{for(const d of r)d.dragging=!1;r.length=0,o.length=0,l=null,p=null,this._moveManipulation.interactive=!0};if(s=s.next(d=>p(d)).next(()=>{if(this.emit("graphic-move-stop",new yo(o)),this.destroyed)return null;u()}),t.length===1&&e===P.XY){const d=t[0].graphic;a=this._buildSnappingPipelineSteps(d,J(d),a,s,n)}return a.next(d=>{if(d.action==="start"){r.length=0,o.length=0;for(const _ of t)_.dragging||!_.manipulationXY.hasManipulator(i)&&_.manipulationXY.grabbing||(r.push(_),o.push(_.graphic),_.dragging=!0);if(o.length!==0&&(this._moveManipulation.interactive=!1,l=zl(o,this.view.state.viewingMode),p=Nl(o),this.emit("graphic-move-start",new bp(o)),this.destroyed))return null}return o.length!==0?d:null}).next(d=>l(d)).next(d=>(this._updateMoveTooltip(t,e,d),d)).next(d=>{switch(d.action){case"start":case"update":if(d.translationX||d.translationY||d.translationZ){const _=this.view.toScreen(d.mapStart),f=this.view.toScreen(d.mapEnd),v=f.x-_.x,M=f.y-_.y;if(this.emit("graphic-move",new Mp(v,M,o)),this.destroyed)return null}break;case"end":if(this.emit("graphic-move-stop",new yo(o)),this.destroyed)return null;u()}})}_updateMoveTooltip(t,e,i){const{tooltipOptions:a,_tooltip:s}=this;if(m(s))return;s.clear();const n=t.length===0?"absolute-height":t[0].state.isDraped?"on-the-ground":"absolute-height";switch(e){case P.XY:s.info=new Fi({tooltipOptions:a}),this._updateMoveTooltipDistance(s.info,i,(r,o)=>st(r,o,n));break;case P.XY_AXIS:s.info=new Es({tooltipOptions:a}),this._updateMoveTooltipDistance(s.info,i,(r,o)=>{const l=st(r,o,n);return ma(l,ja(i))});break;case P.Z:s.info=new wa({tooltipOptions:a}),this._updateMoveTooltipDistance(s.info,i,_a)}}_updateMoveTooltipDistance(t,e,i){if(h(e)&&e.action!=="end"){const{mapStart:a,mapEnd:s}=e,n=i(a,s);t.distance=h(n)?n:Oi}}_buildSnappingPipelineSteps(t,e,i,a,s){const n=t.geometry;if(m(n)||n.type!=="point"&&n.type!=="mesh")return i;const r=(n.type==="point"?n:n.anchor).clone(),o=new pa({elevationInfo:e,pointer:s,editGeometryOperations:ua.fromGeometry(r,this.view.state.viewingMode),visualizer:new Xi,excludeFeature:t}),l=this.snappingManager;return i.next(p=>(r.z=Fl(this.view,r,J(t),{mode:"absolute-height",offset:0}),z(L({},p),{snapOrigin:o.coordinateHelper.pointToVector(r)}))).next(this._snappingPipeline.createSnapDragEventPipelineStep({snappingContext:o,snappingManager:l,cancel:a,updatingHandles:this.updatingHandles}),this._snappingPipeline.next)}get test(){return{tooltip:this._tooltip}}};c([g({constructOnly:!0,nonNullable:!0})],et.prototype,"view",void 0),c([g()],et.prototype,"graphics",void 0),c([g({constructOnly:!0,nonNullable:!0})],et.prototype,"enableZ",void 0),c([g({constructOnly:!0,type:vt})],et.prototype,"tooltipOptions",void 0),c([g({constructOnly:!0})],et.prototype,"snappingManager",void 0),c([g()],et.prototype,"type",void 0),c([g()],et.prototype,"updating",null),et=c([q("esri.views.3d.interactive.editingTools.graphicMove3D.GraphicMoveTool")],et);class Sp{constructor(e){this.state=null,this.geometryRepresentation=null,this.manipulationXY=null,this.dragging=!1,this.state=new Ae({graphic:e})}get graphic(){return this.state.graphic}}function bo(t,e,i){const a=i.mode==="on-the-ground"?xn.XY:xn.XYZ;return new Hl(t,a,e,0)}function Mo(t,e,i){const a=b();if(!t.renderCoordsHelper.toRenderCoords(e,a))return null;const s=So(t,e,xi(i.plane)),n=So(t,e,i.edgeDirection);if(m(s)||m(n))return null;const r=we(b(),s,n);return Tt(a,r,Wt())}function So(t,e,i){const a=Mi(e.x+i[0],e.y+i[1],e.z+i[2],e.spatialReference),s=b(),n=b();return t.renderCoordsHelper.toRenderCoords(e,s)&&t.renderCoordsHelper.toRenderCoords(a,n)?En(n,s,n):null}function wp(t,e,i){const a=xi(t),s=En(b(),e,i),n=we(b(),s,a),r=we(b(),s,n);return kl(s[0],s[1],s[2],0,n[0],n[1],n[2],0,r[0],r[1],r[2],0,0,0,0,1)}function xp(t,e,i){const a=i.projectToRenderScreen(t,ns()),s=i.projectToRenderScreen(e,ns());return h(a)&&h(s)?jl(D(a,a,s)):0}let St=class extends fa{constructor(t){super(t),this.type="reshape-edge-offset",this.distance=Oi,this.area=null,this.totalLength=null}};c([g()],St.prototype,"type",void 0),c([g()],St.prototype,"distance",void 0),c([g()],St.prototype,"area",void 0),c([g()],St.prototype,"totalLength",void 0),St=c([q("esri.views.interactive.tooltip.ReshapeEdgeOffsetTooltipInfo")],St);let ee=class extends Le.EventedMixin(ds){constructor(t){super(t),this._vertexManipulatorMaterial=ot(y.colorToVec4(y.reshapeManipulators.vertex.color),y.reshapeManipulators.vertex.renderOccluded),this._vertexManipulatorOutlineMaterial=Zi(y.colorToVec4(y.reshapeManipulators.vertex.outlineColor),y.reshapeManipulators.vertex.renderOccluded),this._vertexManipulatorHoverOutlineMaterial=Zi(y.colorToVec4(y.reshapeManipulators.vertex.hoverOutlineColor),y.reshapeManipulators.vertex.renderOccluded),this._edgeManipulatorMaterial=ot(y.colorToVec4(y.reshapeManipulators.edge.color),y.reshapeManipulators.edge.renderOccluded),this._edgeManipulatorOutlineMaterial=Zi(y.colorToVec4(y.reshapeManipulators.edge.outlineColor),y.reshapeManipulators.edge.renderOccluded),this._edgeOffsetManipulatorMaterial=ot(y.colorToVec4(y.reshapeManipulators.edgeOffset.color),y.reshapeManipulators.edgeOffset.renderOccluded,!1),this._edgeOffsetManipulatorHoverMaterial=ot(y.colorToVec4(y.reshapeManipulators.edgeOffset.hoverColor),y.reshapeManipulators.edgeOffset.renderOccluded,!1),this._selectedManipulatorMaterial=ot(y.colorToVec4(y.reshapeManipulators.selected.color),y.reshapeManipulators.selected.renderOccluded),this._selectedManipulatorOutlineMaterial=Zi(y.colorToVec4(y.reshapeManipulators.selected.outlineColor),y.reshapeManipulators.selected.renderOccluded),this._selectedManipulatorHoverOutlineMaterial=Zi(y.colorToVec4(y.reshapeManipulators.selected.hoverOutlineColor),y.reshapeManipulators.selected.renderOccluded),this._selectedIndex=0,this._vertexManipulatorGeometry=null,this._vertexManipulatorOutlineGeometry=null,this._edgeManipulatorGeometry=null,this._edgeManipulatorOutlineGeometry=null,this._edgeOffsetManipulatorGeometryInside=null,this._edgeOffsetManipulatorGeometryOutside=null,this._manipulatorHandles=new it,this._manipulatorInfos=[],this._editGeometryOperations=null,this._numGrabbing=0,this._numDragging=0,this._reshapeEventState=j.NONE,this._outlineVisualElement=null,this._segmentLabels=null,this.outputGeometry=null,this._snappingPipeline=new da,this._snappingPipelineHandle=new da,this._vertexLaserLineVisualElement=null}initialize(){const{graphic:t,view:e}=this,i=this._graphicState=new Ae({graphic:t});this._tooltip=new Ai({view:e}),this.addHandles([I(()=>i.displaying,a=>{for(const s of this._manipulatorInfos)s.manipulator.available=a}),I(()=>({labels:this._segmentLabels,enabled:this._labelOptions.enabled,edgeOffsetEnabled:this.enableEdgeOffset}),({labels:a,enabled:s,edgeOffsetEnabled:n})=>{h(a)&&(a.visible=s,a.edgeDistance=n?"far":"default")},Ue),Jt(()=>!this._tooltipOptions.enabled,()=>this._tooltip.clear(),Ue),this.view.trackGraphicState(i)])}destroy(){this._segmentLabels=X(this._segmentLabels),this._tooltip=X(this._tooltip),this._removeManipulators()}get inputGeometry(){return h(this._editGeometryOperations)?this._editGeometryOperations.data.geometry:null}set inputGeometry(t){this._recreateEditGeometryAndManipulators(t)}get updating(){return this.updatingHandles.updating}get manipulators(){return this.tool.manipulators}get view(){return this.tool.view}get graphic(){return this.tool.graphic}get enableZShape(){return this.tool.enableZShape}get enableZVertex(){return this.tool.enableZVertex}get enableMoveGraphic(){return this.tool.enableMoveGraphic}get enableMidpoints(){return this.tool.enableMidpoints}get enableEdgeOffset(){return this.tool.enableEdgeOffset}get _labelOptions(){return this.tool.labelOptions}get _tooltipOptions(){return this.tool.tooltipOptions}removeSelectedVertices(){const t=this._manipulatorInfos.filter(e=>e.manipulator.selected&&e.type==="vertex");this._removeVertices(t)}onManipulatorSelectionChanged(){this.emit("manipulators-changed")}_removeManipulators(){this._manipulatorHandles.removeAll(),this._moveManipulation=X(this._moveManipulation),this._graphicMoveManipulation=X(this._graphicMoveManipulation),this.manipulators.removeAll(),this._manipulatorInfos=[],this._numGrabbing=0,this._numDragging=0}_createManipulators(){if(m(this._editGeometryOperations))return;const t=J(this.graphic);for(const e of this._editGeometryOperations.data.components){for(const i of e.vertices)this._createVertexOrEdgeManipulator(i,t);for(const i of e.edges)this._createVertexOrEdgeManipulator(i,t)}this._createGraphicMoveManipulation(),this._createMoveManipulation(t),this._createVisualElements()}get canRedo(){return h(this._editGeometryOperations)&&this._editGeometryOperations.canRedo}get canUndo(){return h(this._editGeometryOperations)&&this._editGeometryOperations.canUndo}redo(){if(m(this._editGeometryOperations))return null;const t=this._editGeometryOperations.redo();return h(t)&&(this.outputGeometry=this._editGeometryOperations.data.geometry,this._recreateManipulators()),t}undo(){if(m(this._editGeometryOperations))return null;this.emit("undo");const t=this._editGeometryOperations.undo();return h(t)&&(this.outputGeometry=this._editGeometryOperations.data.geometry,this._recreateManipulators()),t}_recreateManipulators(){this._removeManipulators(),this._tooltip.clear(),this._createManipulators()}_recreateEditGeometryAndManipulators(t=this.inputGeometry){this._removeManipulators(),this._tooltip.clear(),m(t)||(X(this._editGeometryOperations),this._editGeometryOperations=ua.fromGeometry(t,this.view.state.viewingMode),this._createManipulators(),X(this._segmentLabels),this._segmentLabels=new xa({context:{view:this.view,editGeometryOperations:this._editGeometryOperations,elevationInfo:J(this.graphic),labelOptions:this._labelOptions,graphic:this.graphic,graphicState:this._graphicState},visible:this._labelOptions.enabled}))}_perGraphicManipulatorDragAction(t,e){if(e.action==="end")return e;let i=0;const a=[],s=this._manipulatorInfos.some(r=>r.type==="vertex"&&r.manipulator.selected),n=t===pi.SELECTED_OR_ALL&&s;for(const r of this._manipulatorInfos)r.type==="vertex"&&(r.manipulator.grabbing||n&&!r.manipulator.selected||a.push(r),i++);if(a.length===0)return e;if(this._moveVertices(a,e),a.length===i){if(this._updateEventState(j.MOVING),this.destroyed)return e;this.emit("move",{type:"move",dx:e.screenDeltaX,dy:e.screenDeltaY,mover:this.graphic})}else{if(this._updateEventState(j.RESHAPING),this.destroyed)return e;this.emit("reshape",{type:"reshape",mover:this.graphic})}return e}_isMultiVertexSelection(){let t=0;for(const e of this._manipulatorInfos)e.type==="vertex"&&e.manipulator.selected&&t++;return t>1}_perVertexManipulatorDragAction(t){if(this._updateEventState(j.RESHAPING),this.destroyed)return;const{mapDeltaX:e,mapDeltaY:i,mapDeltaZ:a}=t;if(!e&&!i&&!a)return;const s=[];for(const n of this._manipulatorInfos)n.type==="vertex"&&(n.manipulator.selected&&!n.manipulator.grabbing||n===t.info)&&s.push(n);this._moveVertices(s,t,at.ACCUMULATE_STEPS),this.emit("reshape",{type:"reshape",mover:this.graphic})}_updateEventState(t){if(t===this._reshapeEventState)return!1;switch(t){case j.NONE:if(this._numGrabbing!==0||this._numDragging!==0)return!1;switch(this._reshapeEventState){case j.MOVING:this.emit("move",{type:"move-stop",dx:0,dy:0,mover:this.graphic});break;case j.RESHAPING:this.emit("reshape",{type:"reshape-stop",mover:this.graphic})}break;case j.MOVING:switch(this._reshapeEventState){case j.NONE:this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic});break;case j.RESHAPING:this.emit("reshape",{type:"reshape-stop",mover:this.graphic}),this.destroyed||this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic})}break;case j.RESHAPING:switch(this._reshapeEventState){case j.NONE:this.emit("reshape",{type:"reshape-start",mover:this.graphic});break;case j.MOVING:this.emit("move",{type:"move-stop",dx:0,dy:0,mover:this.graphic}),this.destroyed||this.emit("reshape",{type:"reshape-start",mover:this.graphic})}}if(this.destroyed)return!1;const e=this._reshapeEventState!==t;return this._reshapeEventState=t,e}_createGraphicMoveManipulation(){const{tool:t,view:e}=this,i=this._graphicState;if(this._graphicMoveManipulation=new zs({tool:t,view:e,graphicState:i}),this.enableMoveGraphic){let a=null;this._manipulatorHandles.add(this._graphicMoveManipulation.createDragPipeline((s,n,r)=>{n.next(o=>this._trackNumDragging(o)).next(o=>(o.action==="start"&&(a=C(this._editGeometryOperations).createUndoGroup()),o)).next(o=>this._perGraphicManipulatorDragAction(pi.ALL,o)).next(o=>(this._updateTranslateGraphicTooltip(P.XY,o),o)).next(o=>{o.action==="end"&&(this._tooltip.clear(),a=Dt(a))}),r.next(()=>this._onDragCancel(!0,()=>a=Dt(a)))})),this._graphicMoveManipulation.forEachManipulator(s=>this._manipulatorHandles.add(this._watchAndUpdateGrabState(s,!1)))}else this._graphicMoveManipulation.forEachManipulator(a=>{a.grabbable=!1,a.cursor=null});this._graphicMoveManipulation.forEachManipulator(a=>this._manipulatorHandles.add(a.events.on("immediate-click",s=>{this._manipulatorInfos.some(n=>n.manipulator.selected)?this._clearSelection():this.emit("immediate-click",z(L({},s),{graphic:this.graphic})),s.stopPropagation()})))}_createMoveManipulation(t){const{graphic:e,handles:i,tool:a,view:s}=this,n=this._graphicState;this._moveManipulation=new Ut({tool:a,view:s,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZShape&&Ht(e),snapToScene:!1,radius:Ut.radiusForSymbol(e.symbol)}),this._moveManipulation.forEachManipulator(l=>i.add([l.events.on("immediate-click",p=>{this._moveManipulation.zManipulation.hasManipulator(l)||this._manipulatorInfos.some(u=>u.manipulator.selected)||this.emit("immediate-click",z(L({},p),{graphic:e})),p.stopPropagation()}),this._watchAndUpdateGrabState(l,!1)]));const r=l=>p=>{i.add(p.events.on("focus-changed",({action:u})=>{u==="focus"&&this._tooltipOptions.enabled?this._updateTranslateTooltip(l):this._tooltip.clear()}))};this._moveManipulation.xyManipulation.forEachManipulator(r(P.XY)),this._moveManipulation.xyAxisManipulation.forEachManipulator(r(P.XY_AXIS)),this._moveManipulation.zManipulation.forEachManipulator(r(P.Z)),this._moveManipulation.elevationInfo={mode:"absolute-height",offset:0};const o=C(e.geometry).spatialReference;i.add([this._moveManipulation.createDragPipeline((l,p,u,d,_)=>(d=d.next(f=>(this._onDragCancel(),f)),u.next(f=>this._trackNumDragging(f)).next(f=>{const v=this._manipulatorInfos.filter(M=>M.type==="vertex"&&M.manipulator.selected);return f.manipulatorType===V.TRANSLATE_XY&&v.length===1?z(L({},f),{info:v[0],snapOrigin:v[0].handle.pos}):f}).next(On(this.view,t,e)).next(this._snappingPipelineHandle.createSnapDragEventPipelineStep({predicate:f=>!!f.info,cancel:d,snappingManager:a.snappingManager,snappingContext:new pa({editGeometryOperations:C(this._editGeometryOperations),elevationInfo:t,pointer:_,excludeFeature:e,visualizer:new Xi}),updatingHandles:this.updatingHandles,useZ:!1}),this._snappingPipelineHandle.next).next(Kt()).next(f=>this._perGraphicManipulatorDragAction(pi.SELECTED_OR_ALL,f)).next(f=>(this._updateTranslateTooltip(l,f),f))),t,o,e),I(()=>n.displaying,()=>{this._updateMoveManipulationPosition()},Ue),n.on("changed",()=>this._updateMoveManipulationPosition()),I(()=>n.isDraped,l=>{this._updateMoveManipulationPosition();const p="align-move-manipulation";l?i.add(this.view.elevationProvider.on("elevation-change",()=>this._updateMoveManipulationPosition()),p):i.remove(p)},Ue)])}_createVisualElements(){const{graphic:t,view:e}=this,i=Na({view:e,graphic:t,forEachManipulator:a=>{if(!this.destroyed){this._graphicMoveManipulation.forEachManipulator(a),this._moveManipulation.forEachManipulator(a);for(const s of this._manipulatorInfos)a(s.manipulator,V.TRANSLATE_XY)}},onManipulatorsChanged:a=>this.on("manipulators-changed",a)});h(i)&&(this._outlineVisualElement=i.visualElement instanceof zt?i.visualElement:null),h(this._outlineVisualElement)&&this._manipulatorHandles.add(this._outlineVisualElement.events.on("attachment-origin-changed",()=>{this._graphicState.isDraped||this._updateMoveManipulationPosition()})),this._manipulatorHandles.add(i)}_createEdgeOffsetManipulator(t,e=J(this.graphic)){const i=y.reshapeManipulators.edgeOffset,a=i.size/2,s=a+i.collisionPadding;if(m(this._edgeOffsetManipulatorGeometryInside)||m(this._edgeOffsetManipulatorGeometryOutside)){const d=a/s,_=d*Math.sqrt(3)/2;this._edgeOffsetManipulatorGeometryInside=zi(_,d/2,d/2,i.height,i.offset),this._edgeOffsetManipulatorGeometryOutside=zi(-_,d/2,d/2,i.height,-i.offset)}const n=[{geometry:this._edgeOffsetManipulatorGeometryInside,material:this._edgeOffsetManipulatorMaterial,stateMask:x.Unfocused},{geometry:this._edgeOffsetManipulatorGeometryInside,material:this._edgeOffsetManipulatorHoverMaterial,stateMask:x.Focused},{geometry:this._edgeOffsetManipulatorGeometryOutside,material:this._edgeOffsetManipulatorMaterial,stateMask:x.Unfocused},{geometry:this._edgeOffsetManipulatorGeometryOutside,material:this._edgeOffsetManipulatorHoverMaterial,stateMask:x.Focused}],r=new ge({view:this.view,renderObjects:n,elevationInfo:e.mode!=="on-the-ground"||An(this.graphic.symbol)?{mode:"absolute-height",offset:0}:e,worldOriented:!1,focusMultiplier:1,radius:s,available:!(!this.graphic.visible||!this.graphic.layer.visible),collisionType:{type:"disc",direction:N(0,0,1)},collisionPriority:1,metadata:{deleting:!1}}),o=new ge({view:this.view,renderObjects:[],worldSized:!0,worldOriented:!1,available:!(!this.graphic.visible||!this.graphic.layer.visible),collisionPriority:-10,cursor:this.enableMoveGraphic?"move":"default",metadata:{deleting:!1}}),l={manipulator:r,handle:t,locationUpdateHandle:null,type:"edge",selectedIndex:0,edgeManipulator:o,elevationInfo:e,visibilityHandle:null};this._autoHideEdgeOffsetManipulator(l,i.minSquaredEdgeLength),this._updateEdgeOffsetManipulator(l);const p=[];for(const d of[l.handle.leftVertex,l.handle.rightVertex]){const _=this._getManipulatorInfoFromHandle(d);h(_)&&p.push(_.manipulator.events.on("location-update",()=>this._updateEdgeOffsetManipulator(l)))}l.locationUpdateHandle=ve(p),this._manipulatorHandles.add(l.locationUpdateHandle,r),this._manipulatorHandles.add([this._watchAndUpdateGrabState(r,!0),this._watchAndUpdateGrabState(o,!0)],r),this._manipulatorHandles.add(Ie(r,this._createEdgeOffsetPipeline(l,e)),r),this._manipulatorHandles.add(Ie(o,(d,_,f,v)=>{if(v==="touch")this._createEdgeOffsetPipeline(l,e)(d,_,f);else if(this.enableMoveGraphic){const M=this.graphic,E=h(M.geometry)?M.geometry.spatialReference:null;_.next(w=>this._trackNumDragging(w)).next(wi(this.view,d.elevationAlignedLocation)).next(Ha(this.view,d.elevationAlignedLocation,e,E,M)).next(Qt()).next(Kt()).next(w=>this._perGraphicManipulatorDragAction(pi.ALL,w)).next(w=>(this._updateTranslateGraphicTooltip(P.XY,w),w)).next(w=>{w.action==="end"&&this._tooltip.clear()}),f.next(()=>this._onDragCancel(!d.metadata.deleting))}}),r);const u=d=>{this._manipulatorInfos.some(_=>_.manipulator.selected)?this._clearSelection():this.emit("immediate-click",z(L({},d),{graphic:this.graphic})),d.stopPropagation()};return this._manipulatorHandles.add([r.events.on("immediate-click",u),o.events.on("immediate-click",u),r.events.on("focus-changed",({action:d})=>{const _=this._tooltipOptions;if(d==="focus"&&_.enabled){const f=this._tooltip.info=new St({tooltipOptions:_});this._updateTooltipAreaOrTotalLength(f)}else this._tooltip.clear()})],r),this._manipulatorInfos.push(l),this.manipulators.add(r),this.manipulators.add(o),this.emit("manipulators-changed"),l}_autoHideEdgeOffsetManipulator(t,e){const i=t.manipulator,a=t.edgeManipulator,s=()=>{t.visibilityHandle=Dt(t.visibilityHandle);const n=this._getManipulatorInfoFromHandle(t.handle.leftVertex),r=this._getManipulatorInfoFromHandle(t.handle.rightVertex),o=h(n)&&h(r)&&xp(n.manipulator.renderLocation,r.manipulator.renderLocation,this.view.state.camera)<e;(!i.focused&&!a.focused||o)&&(i.grabbable=!o,a.grabbable=!o,t.visibilityHandle=ve([i.disableDisplay(),{remove:()=>{i.grabbable=!0,a.grabbable=this.enableMoveGraphic}}]))};this._manipulatorHandles.add([i.events.on("focus-changed",s),a.events.on("focus-changed",s),{remove:()=>{Dt(t.visibilityHandle),a.metadata.deleting=!0,this.manipulators.remove(a)}}],i),s()}_updateEdgeOffsetManipulator(t){this._updateManipulatorPosition(t);const{coordinateHelper:e}=C(this._editGeometryOperations).data,i=Mo(this.view,t.manipulator.elevationAlignedLocation,bo(e,t.handle,C(t.manipulator.elevationInfo))),a=this._getManipulatorInfoFromHandle(t.handle.leftVertex),s=this._getManipulatorInfoFromHandle(t.handle.rightVertex);if(m(a)||m(s))return;const n=a.manipulator.renderLocation,r=s.manipulator.renderLocation,o=h(i)?wp(i,n,r):Ul;t.manipulator.modelTransform=o,t.edgeManipulator.elevationAlignedLocation=t.manipulator.elevationAlignedLocation,t.edgeManipulator.modelTransform=o;const l=fe(D(Ua,n,r))/2;t.edgeManipulator.collisionType={type:"line",paths:[[[-l,0,0],[l,0,0]]]}}_createEdgeOffsetPipeline(t,e){return(i,a,s)=>{this._clearSelection();const{step:n,cleanup:r}=this._initializeEdgeOffset(t,e);a.next(o=>this._trackNumDragging(o)).next(wi(this.view,i.elevationAlignedLocation)).next(n).next(lp(this.view)).next(uo(this.view,C(this._editGeometryOperations).data.spatialReference)).next(Kt()).next(this._applyComputeEdgeOffsetDistanceStep()).next(this._applyEdgeOffsetStep(t)).next(this._showEdgeOffsetTooltip()).next(o=>{o.action==="end"&&r()}),s.next(()=>{i.metadata.deleting||(r(),this._onDragCancel())})}}_initializeEdgeOffset(t,e){const i=C(this._editGeometryOperations),a=bo(i.data.coordinateHelper,t.handle,e),s=i.createUndoGroup(),n=Mo(this.view,t.manipulator.elevationAlignedLocation,a);if(a.requiresSplitEdgeLeft){const d=this._getManipulatorInfoFromHandle(t.handle.leftVertex.leftEdge);h(d)&&this._splitEdgeManipulator(d,1)}if(a.requiresSplitEdgeRight){const d=this._getManipulatorInfoFromHandle(t.handle.rightVertex.rightEdge);h(d)&&this._splitEdgeManipulator(d,0)}const r=()=>new Bl({paths:[[t.handle.leftVertex.pos,t.handle.rightVertex.pos]],spatialReference:i.data.spatialReference}),o=new zt({view:this.view,isDraped:this._graphicState.isDraped,geometry:r(),elevationInfo:t.elevationInfo,width:y.visualElements.lineGraphics.outline.width,color:y.colorToVec4(T.main),attached:!0});let l;const p=()=>{this._cleanEdgeOffsetCollapsedEdges(t),l=Dt(l)},u=this.on("undo",p);return l=ve([xe(o),I(()=>this._graphicState.isDraped,d=>o.isDraped=d),this._graphicState.on("changed",()=>o.geometry=r()),s,u]),{step:d=>m(a)||m(n)?(p(),null):z(L({},d),{operation:a,plane:n}),cleanup:p}}_applyEdgeOffsetStep(t){return e=>{if(this.destroyed||m(e.operation))return e;this._updateEventState(j.RESHAPING);const{mapDeltaX:i,mapDeltaY:a,mapDeltaZ:s}=e;return(i||a||s)&&(this._offsetEdge(t,e),this.emit("reshape",{type:"reshape",mover:this.graphic})),e}}_applyComputeEdgeOffsetDistanceStep(){return t=>{const{operation:e,mapEnd:i}=t;return m(e)||m(i)?t:(t.action==="start"&&e.selectArrowFromStartPoint(i),z(L({},t),{signedDistance:e.signedDistanceToPoint(i)}))}}_showEdgeOffsetTooltip(){return t=>{const{mapEnd:e,signedDistance:i,operation:a}=t,s=this._tooltip,n=this._tooltipOptions;if(!n.enabled||m(i))return s.clear(),t;let r=s.info;(m(r)||r.type!=="reshape-edge-offset")&&(r=s.info=new St({tooltipOptions:n}));const{coordinateHelper:o}=C(this._editGeometryOperations).data;return r.distance=t.action==="end"?Oi:Ep(this._graphicState.isDraped,i*a.selectedArrow,e,a.plane,o),this._updateTooltipAreaOrTotalLength(r),t}}_cleanEdgeOffsetCollapsedEdges(t){var o,l;const e=(o=t.handle.leftVertex.leftEdge)==null?void 0:o.leftVertex,i=t.handle.leftVertex,a=(l=t.handle.rightVertex.rightEdge)==null?void 0:l.rightVertex,s=t.handle.rightVertex,n=C(this._editGeometryOperations).data.coordinateHelper,r=[];if(e&&n.distance(e.pos,i.pos)<Ns){const p=this._getManipulatorInfoFromHandle(i);h(p)&&r.push(p)}if(n.distance(i.pos,s.pos)<Ns||a&&n.distance(a.pos,s.pos)<Ns){const p=this._getManipulatorInfoFromHandle(s);h(p)&&r.push(p)}r.length&&this._removeVertices(r)}_computeVertexManipulatorSizeAndOutline(t){const e=t.size/2,i=e+t.collisionPadding;return{size:e/i,outlineSize:(e+t.outlineSize)/i}}_createVertexOrEdgeManipulator(t,e=J(this.graphic)){if(t.type==="edge"){if(this.enableEdgeOffset)return this._createEdgeOffsetManipulator(t,e);if(!this.enableMidpoints)return null}if(m(this._vertexManipulatorGeometry)||m(this._vertexManipulatorOutlineGeometry)){const{size:r,outlineSize:o}=this._computeVertexManipulatorSizeAndOutline(y.reshapeManipulators.vertex);this._vertexManipulatorGeometry=Vi(r,16,16),this._vertexManipulatorOutlineGeometry=Vi(o,16,16)}if(m(this._edgeManipulatorGeometry)||m(this._edgeManipulatorOutlineGeometry)){const{size:r,outlineSize:o}=this._computeVertexManipulatorSizeAndOutline(y.reshapeManipulators.edge);this._edgeManipulatorGeometry=Vi(r,16,16),this._edgeManipulatorOutlineGeometry=Vi(o,16,16)}const i=h(this.graphic.geometry)&&this.graphic.geometry.type==="point"?[]:[{geometry:this._vertexManipulatorGeometry,material:this._vertexManipulatorMaterial,stateMask:He.Vertex|x.Unselected},{geometry:this._vertexManipulatorOutlineGeometry,material:this._vertexManipulatorOutlineMaterial,stateMask:He.Vertex|x.Unfocused|x.Unselected},{geometry:this._vertexManipulatorOutlineGeometry,material:this._vertexManipulatorHoverOutlineMaterial,stateMask:He.Vertex|x.Focused|x.Unselected},{geometry:this._vertexManipulatorGeometry,material:this._selectedManipulatorMaterial,stateMask:x.Selected},{geometry:this._vertexManipulatorOutlineGeometry,material:this._selectedManipulatorOutlineMaterial,stateMask:x.Selected|x.Unfocused},{geometry:this._vertexManipulatorOutlineGeometry,material:this._selectedManipulatorHoverOutlineMaterial,stateMask:x.Selected|x.Focused}];this.enableMidpoints&&i.push({geometry:this._edgeManipulatorGeometry,material:this._vertexManipulatorMaterial,stateMask:He.Edge|x.Focused|x.Unselected},{geometry:this._edgeManipulatorOutlineGeometry,material:this._vertexManipulatorHoverOutlineMaterial,stateMask:He.Edge|x.Focused|x.Unselected},{geometry:this._edgeManipulatorGeometry,material:this._edgeManipulatorMaterial,stateMask:He.Edge|x.Unfocused|x.Unselected},{geometry:this._edgeManipulatorOutlineGeometry,material:this._edgeManipulatorOutlineMaterial,stateMask:He.Edge|x.Unfocused|x.Unselected});const a=new ge({view:this.view,renderObjects:i,elevationInfo:e,focusMultiplier:1,touchMultiplier:1,available:!(!this.graphic.visible||!this.graphic.layer.visible),metadata:{deleting:!1}});this._setTypeSpecificManipulatorSettings(a,t,e);const s=t.type==="edge"?{manipulator:a,handle:t,locationUpdateHandle:null,type:"edge",selectedIndex:0}:{manipulator:a,handle:t,type:"vertex",selectedIndex:0};if(this._manipulatorInfos.push(s),this.manipulators.add(a),this._updateManipulatorPosition(s),s.type==="edge"){const r=[];for(const o of[s.handle.leftVertex,s.handle.rightVertex]){const l=this._getManipulatorInfoFromHandle(o);h(l)&&r.push(l.manipulator.events.on("location-update",()=>this._updateManipulatorPosition(s)))}s.locationUpdateHandle=ve(r),this._manipulatorHandles.add(s.locationUpdateHandle,a)}this._manipulatorHandles.add(this._watchAndUpdateGrabState(a,!0),a);const n=Ie(a,(r,o,l,p)=>{let u=null;l=l.next(d=>(this._onDragCancel(!r.metadata.deleting,()=>u=Dt(u)),d)),o.next(d=>this._trackNumDragging(d)).next(d=>{if(d.action==="start"&&(u=C(this._editGeometryOperations).createUndoGroup()),s.type==="edge"){const _=this._splitEdgeManipulator(s);return z(L({},d),{info:_,snapOrigin:_.handle.pos})}return z(L({},d),{info:s,snapOrigin:s.handle.pos})}).next(wi(this.view,r.elevationAlignedLocation)).next(co(this.view,this.graphic,r.elevationAlignedLocation,r.location.spatialReference,this.graphic)).next(On(this.view,e,this.graphic)).next(this._snappingPipeline.createSnapDragEventPipelineStep({predicate:()=>!this._isMultiVertexSelection(),cancel:l,snappingManager:this.tool.snappingManager,snappingContext:new pa({editGeometryOperations:C(this._editGeometryOperations),elevationInfo:e,pointer:p,excludeFeature:this.graphic,visualizer:new Xi}),updatingHandles:this.updatingHandles,useZ:!1}),this._snappingPipeline.next).next(Kt()).next(d=>{this._perVertexManipulatorDragAction(d),d.action==="end"&&(u=Dt(u)),this._updateTranslateVertexTooltip(r,P.XY,d)})});return this._manipulatorHandles.add([n,a.events.on("immediate-click",r=>this._manipulatorClickCallback(r,s)),a.events.on("select-changed",()=>{s.selectedIndex=++this._selectedIndex,this._updateMoveManipulationPosition()}),a.events.on("focus-changed",({action:r})=>{r==="focus"&&s.type!=="edge"?this._updateTranslateVertexTooltip(a,P.XY):this._tooltip.clear()})],a),this.emit("manipulators-changed"),s}_trackNumDragging(t){switch(t.action){case"start":this._numDragging++;break;case"end":this._numDragging--}return t}_onDragCancel(t=!0,e){switch(this._numDragging--,t&&(this.undo(),this.outputGeometry=h(this._editGeometryOperations)?this._editGeometryOperations.data.geometry:null),h(this.tool.snappingManager)&&this.tool.snappingManager.doneSnapping(),this._tooltip.clear(),this._reshapeEventState){case j.NONE:break;case j.MOVING:this.emit("move",{type:"move",dx:0,dy:0,mover:this.graphic});break;case j.RESHAPING:this.emit("reshape",{type:"reshape",mover:this.graphic})}e&&e(),this.destroyed||this._updateEventState(j.NONE)}_setTypeSpecificManipulatorSettings(t,e,i){switch(e.type){case"vertex":t.state=He.Vertex,t.selectable=!0,t.cursor="move",t.collisionPriority=2,t.radius=y.reshapeManipulators.vertex.size/2+y.reshapeManipulators.vertex.collisionPadding,t.elevationInfo=i,t.interactive=h(this.graphic.geometry)&&this.graphic.geometry.type!=="point";break;case"edge":t.state=He.Edge,t.selectable=!1,t.cursor="copy",t.collisionPriority=-1,t.radius=y.reshapeManipulators.edge.size/2+y.reshapeManipulators.edge.collisionPadding,t.elevationInfo=i.mode!=="on-the-ground"||An(this.graphic.symbol)?{mode:"absolute-height",offset:0}:i}}_watchAndUpdateGrabState(t,e){return t.events.on("grab-changed",i=>this._onGrabStateChanged(t,e,i.action,i.pointerType))}_onGrabStateChanged(t,e,i,a="mouse"){if(i==="start")e&&this._updateSelection(t),this._numGrabbing++;else if(this._numGrabbing--,this._updateEventState(j.NONE),this.destroyed)return;this._moveManipulation.interactive=!this._numGrabbing,(a!=="touch"||this.enableEdgeOffset)&&(this._manipulatorInfos.forEach(s=>{s.manipulator.interactive=s.manipulator.grabbing||!this._numGrabbing&&h(this.graphic.geometry)&&this.graphic.geometry.type!=="point","edgeManipulator"in s&&(s.edgeManipulator.interactive=s.edgeManipulator.grabbing||!this._numGrabbing)}),this._graphicMoveManipulation.forEachManipulator(s=>{s.interactive=s.grabbing||!this._numGrabbing}))}_clearSelection(){for(const t of this._manipulatorInfos)t.manipulator.grabbing||(t.manipulator.selected=!1)}_updateSelection(t){t.grabbing&&!t.selected&&t.selectable&&(this._clearSelection(),t.selected=!0,this.emit("manipulators-changed"))}_removeManipulator(t){m(t)||(t.manipulator.metadata.deleting=!0,this.manipulators.remove(t.manipulator),this._manipulatorHandles.remove(t.manipulator),Xl(this._manipulatorInfos,t),this.emit("manipulators-changed"))}_getManipulatorInfoFromHandle(t){if(t){for(const e of this._manipulatorInfos)if(t===e.handle)return e}return null}_updateManipulatorPosition(t){if(m(t))return;const e=C(this._editGeometryOperations);if(t.type==="vertex")t.manipulator.location=e.data.coordinateHelper.vectorToDehydratedPoint(t.handle.pos,Ji),t.manipulator.grabbing&&h(this._vertexLaserLineVisualElement)&&(this._vertexLaserLineVisualElement.visualElement.intersectsWorldUpAtLocation=t.manipulator.renderLocation);else if(t.type==="edge"){const i=this._getManipulatorInfoFromHandle(t.handle.leftVertex),a=this._getManipulatorInfoFromHandle(t.handle.rightVertex);if(m(i)||m(a))return;const s=i.manipulator,n=a.manipulator;if(h(t.manipulator.elevationInfo)&&t.manipulator.elevationInfo.mode==="on-the-ground"){const r=s.location,o=n.location,l=.5,p=r.x+l*(o.x-r.x),u=r.y+l*(o.y-r.y),d=r.hasZ&&o.hasZ?0:void 0;t.manipulator.location=Mi(p,u,d,e.data.spatialReference)}else mt(Ua,s.renderLocation,n.renderLocation,.5),t.manipulator.renderLocation=Ua}}_splitEdgeManipulator(t,e=.5){const i=C(this._editGeometryOperations),a=C(i.splitEdge(t.handle,e).createdVertex);t.locationUpdateHandle.remove(),t.locationUpdateHandle=void 0;const s=J(this.graphic);let n;this.enableEdgeOffset?(this._removeManipulator(t),n=this._createVertexOrEdgeManipulator(a)):(n=t,n.handle=a,n.type="vertex",this._setTypeSpecificManipulatorSettings(t.manipulator,t.handle,s)),a.leftEdge&&this._createVertexOrEdgeManipulator(a.leftEdge),a.rightEdge&&this._createVertexOrEdgeManipulator(a.rightEdge),this.outputGeometry=i.data.geometry,this._updateManipulatorPosition(n),this.enableEdgeOffset||this._updateTranslateVertexTooltip(n.manipulator,P.XY),this._updateSelection(t.manipulator);const r=this._updateEventState(j.RESHAPING),o=i.data.coordinateHelper.vectorToArray(n.handle.pos),l=i.data.components.indexOf(a.component);return this.emit("vertex-add",{type:"vertex-add",vertices:[{coordinates:o,componentIndex:l,vertexIndex:C(a.index)}],added:o}),r&&this._updateEventState(j.NONE),n}_updateMoveManipulationPosition(){const t=U(Ua,0,0,0);let e=0,i=!1,a=null,s=null;for(const n of this._manipulatorInfos)n.type==="vertex"&&(n.manipulator.selected?(e++,H(t,t,n.manipulator.renderLocation),m(a)||n.selectedIndex>a.selectedIndex?(s=a,a=n):(m(s)||n.selectedIndex>s.selectedIndex)&&(s=n)):i=!0);if(e!==0){const n=this._graphicState.displaying;this._moveManipulation.xyManipulation.available=n,this._moveManipulation.xyAxisManipulation.available=n,this._moveManipulation.zManipulation.available=n&&this.enableZVertex&&Ht(this.graphic),this._moveManipulation.xyAxisManipulation.orthogonalAvailable=n&&e!==1}else{const n=this._graphicState.displaying&&this.enableMoveGraphic;this._moveManipulation.xyManipulation.available=n,this._moveManipulation.xyAxisManipulation.available=n,this._moveManipulation.xyAxisManipulation.orthogonalAvailable=n,this._moveManipulation.zManipulation.available=n&&this.enableZShape&&Ht(this.graphic)}if(e!==0){let n=0;if(h(a)){const r=a.handle.pos,o=h(s)?s.handle.pos:a.handle.leftEdge&&a.handle.leftEdge.leftVertex?a.handle.leftEdge.leftVertex.pos:null,l=m(s)&&a.handle.rightEdge&&a.handle.rightEdge.rightVertex?a.handle.rightEdge.rightVertex.pos:null;o&&l?this._moveManipulation.xyAxisManipulation.available=!1:o?n=wo(o,r):l&&(n=wo(r,l))}this._moveManipulation.angle=n,this._moveManipulation.radius=to}else this._moveManipulation.angle=mo(C(this.graphic.geometry)),this._moveManipulation.radius=Ut.radiusForSymbol(this.graphic.symbol);e!==0&&i?(Q(t,t,1/e),Ji.spatialReference=C(this._editGeometryOperations).data.spatialReference,Ji.hasZ=!0,this.view.renderCoordsHelper.fromRenderCoords(t,Ji),this._moveManipulation.elevationAlignedLocation=Ji):h(this._outlineVisualElement)&&!this._graphicState.isDraped&&h(this._outlineVisualElement.attachmentOrigin)?this._moveManipulation.elevationAlignedLocation=this._outlineVisualElement.attachmentOrigin:Qr(this.view,this._moveManipulation,this.graphic)}_removeVertices(t){const e=[],i=C(this._editGeometryOperations);for(const a of t)if(a.type==="vertex"&&i.canRemoveVertex()){e.push(a.handle),this._removeManipulator(a),this._removeManipulator(this._getManipulatorInfoFromHandle(a.handle.leftEdge)),this._removeManipulator(this._getManipulatorInfoFromHandle(a.handle.rightEdge));const s=C(i.removeVertices([a.handle]).removedVertices[0].createdEdge);s&&this._createVertexOrEdgeManipulator(s)}if(e.length>0){const a=e.map(n=>{const r=i.data.components.indexOf(n.component);return{coordinates:i.data.coordinateHelper.vectorToArray(n.pos),componentIndex:r,vertexIndex:C(n.index)}});this.outputGeometry=i.data.geometry;const s=this._updateEventState(j.RESHAPING);if(this.destroyed||(this.emit("vertex-remove",{type:"vertex-remove",removed:a.map(n=>n.coordinates),vertices:a}),this.destroyed)||s&&(this._updateEventState(j.NONE),this.destroyed))return;this._updateMoveManipulationPosition()}}_moveVertices(t,e,i=e.action==="start"?at.NEW_STEP:at.ACCUMULATE_STEPS){const a=C(this._editGeometryOperations);a.moveVertices(t.map(s=>s.handle),e.mapDeltaX,e.mapDeltaY,e.mapDeltaZ,i),this.outputGeometry=a.data.geometry;for(const s of t)this._updateManipulatorPosition(s)}_offsetEdge(t,e){if(m(e.operation)||m(e.signedDistance))return;const i=C(this._editGeometryOperations),a=e.operation.clone();a.distance=e.signedDistance,i.updateVertices([t.handle.leftVertex,t.handle.rightVertex],a),this.outputGeometry=i.data.geometry,this._updateManipulatorPosition(this._getManipulatorInfoFromHandle(t.handle.leftVertex)),this._updateManipulatorPosition(this._getManipulatorInfoFromHandle(t.handle.rightVertex))}_manipulatorClickCallback(t,e){t.shiftKey||this._clearSelection(),e.type==="vertex"&&(e.manipulator.selected=!e.manipulator.selected,t.button===Tn.Right&&this._removeVertices([e])),e.type==="edge"&&t.button===Tn.Left&&this._splitEdgeManipulator(e),t.stopPropagation()}_updateTranslateTooltip(t,e){const i=this._manipulatorInfos.filter(a=>a.type==="vertex"&&a.manipulator.selected);i.length===1?this._updateTranslateVertexTooltip(i[0].manipulator,t,e):this._updateTranslateGraphicTooltip(t,e)}_updateTranslateGraphicTooltip(t,e){const i=this._tooltipOptions;if(!i.enabled)return;const a=this._graphicState.isDraped?"on-the-ground":"absolute-height";switch(t){case P.XY:this._tooltip.info=new Fi({tooltipOptions:i}),this._updateTranslateTooltipDistance(this._tooltip.info,e,(s,n)=>st(s,n,a));break;case P.XY_AXIS:this._tooltip.info=new Es({tooltipOptions:i}),this._updateTranslateTooltipDistance(this._tooltip.info,e,(s,n)=>{const r=st(s,n,a);return ma(r,ja(e))});break;case P.Z:this._tooltip.info=new wa({tooltipOptions:i}),this._updateTranslateTooltipDistance(this._tooltip.info,e,_a)}}_updateTranslateVertexTooltip(t,e,i){const a=this._tooltipOptions;if(!a.enabled)return;let s;const n=this._graphicState.isDraped?"on-the-ground":"absolute-height";switch(e){case P.XY:s=new yc({tooltipOptions:a}),this._updateTranslateTooltipDistance(s,i,(o,l)=>st(o,l,n)),this._updateTooltipAreaOrTotalLength(s);break;case P.XY_AXIS:s=new vc({tooltipOptions:a}),this._updateTranslateTooltipDistance(s,i,(o,l)=>{const p=st(o,l,n);return ma(p,ja(i))}),this._updateTooltipAreaOrTotalLength(s);break;case P.Z:s=new fc({tooltipOptions:a}),this._updateTranslateTooltipDistance(s,i,_a)}const r=uh(t.elevationAlignedLocation);h(r)&&(s.elevation=L({mode:"absolute-height"},r)),this._tooltip.info=s}_updateTranslateTooltipDistance(t,e,i){if(h(e)&&e.action!=="end"){const{mapStart:a,mapEnd:s}=e,n=i(a,s);t.distance=h(n)?n:Oi}}_updateTooltipAreaOrTotalLength(t){const{geometry:e}=this.graphic;if(m(e))return;const i=this._graphicState.isDraped?"on-the-ground":"absolute-height";t.area=e.type==="polygon"?bc(e,i):null,t.totalLength=e.type==="polyline"?gh(e,i):null}get test(){return{segmentLabels:this._segmentLabels,tooltip:this._tooltip}}};function wo(t,e){return Math.atan2(e[1]-t[1],e[0]-t[0])+Math.PI/2}function Ep(t,e,i,a,s){if(t){const n=s.toXYZ(s.pointToVector(i)),r=Yl(a,n,S.get()),o=_h(r,n,s.spatialReference);if(h(o))return Ti(o.value*Math.sign(e),o.unit)}return Ti(e*ps(i.spatialReference),"meters")}c([g()],ee.prototype,"_segmentLabels",void 0),c([g({constructOnly:!0})],ee.prototype,"tool",void 0),c([g()],ee.prototype,"_tooltip",void 0),c([g()],ee.prototype,"inputGeometry",null),c([g()],ee.prototype,"outputGeometry",void 0),c([g({readOnly:!0})],ee.prototype,"updating",null),c([g()],ee.prototype,"manipulators",null),c([g()],ee.prototype,"view",null),c([g()],ee.prototype,"graphic",null),c([g()],ee.prototype,"enableZShape",null),c([g()],ee.prototype,"enableZVertex",null),c([g()],ee.prototype,"enableMoveGraphic",null),c([g()],ee.prototype,"enableMidpoints",null),c([g()],ee.prototype,"enableEdgeOffset",null),c([g()],ee.prototype,"_labelOptions",null),c([g()],ee.prototype,"_tooltipOptions",null),ee=c([q("esri.views.3d.interactive.editingTools.reshapeGraphic.ReshapeOperation")],ee);const Ji=Mi(0,0,null,null),Ua=b(),Ns=1e-6;var He,j,pi;(function(t){t.Vertex=ae.Custom1,t.Edge=ae.Custom2})(He||(He={})),function(t){t[t.NONE=0]="NONE",t[t.MOVING=1]="MOVING",t[t.RESHAPING=2]="RESHAPING"}(j||(j={})),function(t){t[t.ALL=0]="ALL",t[t.SELECTED_OR_ALL=1]="SELECTED_OR_ALL"}(pi||(pi={}));let ce=class extends Le.EventedMixin(ca){constructor(t){super(t),this._handles=new it,this._internalGeometryUpdate=!1,this.enableZShape=!0,this.enableZVertex=!0,this.enableMoveGraphic=!0,this.enableMidpoints=!0,this.enableEdgeOffset=!1,this.type="reshape-3d",this.labelOptions=new Pn,this.tooltipOptions=new vt,this.snappingManager=null,this.automaticManipulatorSelection=!1}initialize(){const t=this._reshapeOperation=new ee({tool:this});this.addHandles([t.on("reshape",e=>{e.type==="reshape"&&this._onReshapeGeometryChanged(),this.emit("reshape",e)}),t.on("move",e=>{e.type==="move"&&this._onReshapeGeometryChanged(),this.emit("move",e)}),t.on("vertex-add",e=>{this._onReshapeGeometryChanged(),this.emit("vertex-add",e)}),t.on("vertex-remove",e=>{this._onReshapeGeometryChanged(),this.emit("vertex-remove",e)}),t.on("immediate-click",e=>this.emit("immediate-click",e)),this.view.on("pointer-down",["Shift"],e=>{e.stopPropagation()}),I(()=>this.graphic,()=>this._updateGraphic(),cs)]),this.finishToolCreation()}destroy(){this._handles=X(this._handles),this._reshapeOperation=X(this._reshapeOperation)}get updating(){var t,e;return(e=(t=this._reshapeOperation)==null?void 0:t.updating)!=null?e:!1}_updateGeometry(){const t=Wl(this.graphic);this._reshapeOperation.inputGeometry=h(t)?t.clone():null}_updateGraphic(){if(this._handles.remove("onGraphicGeometryChange"),this._updateGeometry(),Zl(this.graphic)!==wn.SUPPORTED)return;const t=I(()=>{var e;return(e=this.graphic)==null?void 0:e.geometry},()=>{this._internalGeometryUpdate===!1&&this._updateGeometry()},ga);this._handles.add(t,"onGraphicGeometryChange")}onManipulatorSelectionChanged(){this._reshapeOperation&&this._reshapeOperation.onManipulatorSelectionChanged()}_updateGeometryInternally(t){this._internalGeometryUpdate=!0,this.graphic.geometry=t,this._internalGeometryUpdate=!1}_onReshapeGeometryChanged(){m(this.graphic)||this._updateGeometryInternally(this._reshapeOperation.outputGeometry.clone())}get canUndo(){var t;return(t=this._reshapeOperation.canUndo)!=null?t:!1}undo(){h(this.snappingManager)&&this.snappingManager.doneSnapping(),h(this._reshapeOperation.undo())&&this._updateGeometryInternally(this._reshapeOperation.outputGeometry.clone())}get canRedo(){var t;return(t=this._reshapeOperation.canRedo)!=null?t:!1}redo(){h(this.snappingManager)&&this.snappingManager.doneSnapping(),h(this._reshapeOperation.redo())&&this._updateGeometryInternally(this._reshapeOperation.outputGeometry.clone())}onInputEvent(t){t.type!=="key-down"||t.key!=="Delete"&&t.key!=="Backspace"||this._reshapeOperation.removeSelectedVertices()}reset(){}get test(){return{snappingManager:this.snappingManager,reshapeOperation:this._reshapeOperation}}};c([g()],ce.prototype,"_reshapeOperation",void 0),c([g({constructOnly:!0,nonNullable:!0})],ce.prototype,"view",void 0),c([g({constructOnly:!0})],ce.prototype,"graphic",void 0),c([g({constructOnly:!0,nonNullable:!0})],ce.prototype,"enableZShape",void 0),c([g({constructOnly:!0,nonNullable:!0})],ce.prototype,"enableZVertex",void 0),c([g({constructOnly:!0,nonNullable:!0})],ce.prototype,"enableMoveGraphic",void 0),c([g({constructOnly:!0,nonNullable:!0})],ce.prototype,"enableMidpoints",void 0),c([g({constructOnly:!0,nonNullable:!0})],ce.prototype,"enableEdgeOffset",void 0),c([g()],ce.prototype,"type",void 0),c([g({constructOnly:!0,type:Pn})],ce.prototype,"labelOptions",void 0),c([g({constructOnly:!0,type:vt})],ce.prototype,"tooltipOptions",void 0),c([g({constructOnly:!0})],ce.prototype,"snappingManager",void 0),c([g()],ce.prototype,"updating",null),c([g()],ce.prototype,"automaticManipulatorSelection",void 0),ce=c([q("esri.views.3d.interactive.editingTools.graphicReshape3D.GraphicReshapeTool")],ce);let lt=class extends fa{constructor(t){super(t),this.type="transform-rotate",this.rotationType="geographic"}};c([g()],lt.prototype,"type",void 0),c([g()],lt.prototype,"rotation",void 0),c([g()],lt.prototype,"rotationPrecision",void 0),c([g()],lt.prototype,"orientation",void 0),c([g()],lt.prototype,"orientationPrecision",void 0),c([g()],lt.prototype,"rotationType",void 0),lt=c([q("esri.views.interactive.tooltip.TransformRotateTooltipInfo")],lt);let wt=class extends fa{constructor(t){super(t),this.type="transform-scale",this.sizeUnit=null,this.sizePrecision=null}};c([g()],wt.prototype,"type",void 0),c([g()],wt.prototype,"scale",void 0),c([g()],wt.prototype,"size",void 0),c([g()],wt.prototype,"sizeUnit",void 0),c([g()],wt.prototype,"sizePrecision",void 0),wt=c([q("esri.views.interactive.tooltip.TransformScaleTooltipInfo")],wt);let Re=class extends fa{constructor(t){super(t),this.type="transform-absolute",this.orientationEnabled=!0,this.orientationPrecision=null,this.rotationType="geographic",this.sizeUnit=null,this.sizeEnabled=!0,this.sizePrecision=null}};c([g()],Re.prototype,"type",void 0),c([g()],Re.prototype,"orientation",void 0),c([g()],Re.prototype,"orientationEnabled",void 0),c([g()],Re.prototype,"orientationPrecision",void 0),c([g()],Re.prototype,"rotationType",void 0),c([g()],Re.prototype,"size",void 0),c([g()],Re.prototype,"sizeUnit",void 0),c([g()],Re.prototype,"sizeEnabled",void 0),c([g()],Re.prototype,"sizePrecision",void 0),Re=c([q("esri.views.interactive.tooltip.TransformAbsoluteTooltipInfo")],Re);var G,ui;(function(t){t.ScaleIn=ae.Custom2,t.ScaleOut=ae.Custom3,t.RotateLeft=ae.Custom4,t.RotateRight=ae.Custom5,t.Unlocked=ae.Custom7,t.DelayedFocused=ae.Custom8,t.TouchInput=ae.Custom12})(G||(G={}));class Op{constructor({adapter:e,tooltipOptions:i,mode:a,tool:s}){this._mode=null,this._handles=new it,this._scaleRotateDragData=null,this._activeAnimation=null,this.events=new Le,this.getFocused=()=>this._ringManipulator.focused,this.getScale=()=>h(this._scaleRotateDragData)&&this._scaleRotateDragData.mode==="scale"?this._adapter.scale:1,this.tool=s,this._mode=a,this._adapter=e,this._tooltipOptions=i,this._tooltip=new Ai({view:s.view}),this._createManipulator(),this._updateDragState(),this._updateManipulatorTransform(),this._handles.add(Jt(()=>!this._tooltipOptions.enabled,()=>this._tooltip.clear(),Ue))}get angle(){return this._adapter.angle}get scale(){return this._adapter.scale}set location(e){this._ringManipulator.location=e}set elevationAlignedLocation(e){this._ringManipulator.elevationAlignedLocation=e}get grabbing(){return this._ringManipulator.grabbing}set interactive(e){this._ringManipulator.interactive=e}destroy(){h(this._activeAnimation)&&(this._activeAnimation.frameTask.remove(),this._activeAnimation=null),this._handles=X(this._handles),this.tool.manipulators.remove(this._ringManipulator),this._ringManipulator=null,this._tooltip=X(this._tooltip)}startAnimation(e){this.cancelActiveAnimation(),e.start();const i=ql({update:({deltaTime:a})=>{e.update(a)&&this.cancelActiveAnimation()}});this._activeAnimation=z(L({},e),{frameTask:i})}cancelActiveAnimation(){h(this._activeAnimation)&&(this._activeAnimation.frameTask.remove(),this._activeAnimation=X(this._activeAnimation))}forEachManipulator(e){e(this._ringManipulator,V.SCALE_ROTATE)}_createManipulator(){const e=this._createRingManipulator();this._ringManipulator=e,this.tool.manipulators.add(e);const i=this.tool.graphicState.graphic,a=Ie(e,(s,n,r)=>{this._scaleRotateDragData=null;const o=this._adapter.startInteraction(),l={mode:"none",origin:na(s.renderLocation),initialAngle:this._adapter.angle,angle:0,angleDir:0,scaleDir:0};this._scaleRotateDragData=l,this._updateDragState();const p=S.get();this.tool.view.renderCoordsHelper.worldUpAtPosition(s.renderLocation,p),n.next(Fa(this.tool.view,Tt(s.renderLocation,p,Wt()))).next(u=>{const d=xi(u.plane),_=Zr(u.renderStart,u.renderEnd,l.origin,d),f=Ql.shortestSignedDiff(l.angle,_);l.angleDir=ra(l.angleDir+f,-lo,lo),l.angle=_;const v=Ap(l,u),M=v-this._adapter.scale;if(l.scaleDir=ra(l.scaleDir+M,-oo,oo),this._onScaleChanged(),l.mode==="none"){const E=this._mode||Tp(u,u.plane,l.origin,this.tool.view.state.camera);if(h(E)){switch(E){case"rotate":this.tool.emit("graphic-rotate-start",{graphic:i,angle:0}),this.tool.emit("record-undo",{record:this._adapter.createUndoRecord()});break;case"scale":this.tool.emit("graphic-scale-start",{graphic:i,xScale:1,yScale:1}),this.tool.emit("record-undo",{record:this._adapter.createUndoRecord()})}l.mode=E}}switch(l.mode){case"rotate":o.state.angle=l.initialAngle+_;break;case"scale":o.state.scale=v,this._onScaleChanged()}switch(this._updateDragState(),this._updateManipulatorTransform(),u.action){case"start":case"update":switch(l.mode){case"rotate":this.tool.emit("graphic-rotate",{graphic:i,angle:Ei(l.angle)});break;case"scale":this.tool.emit("graphic-scale",{graphic:i,xScale:v,yScale:v})}break;case"end":switch(l.mode){case"rotate":this.tool.emit("graphic-rotate-stop",{graphic:i,angle:Ei(l.angle)});break;case"scale":this.tool.emit("graphic-scale-stop",{graphic:i,xScale:v,yScale:v})}}return u.action==="end"&&(this.startAnimation(xo(this,()=>this._onScaleChanged())),this._scaleRotateDragData=null,this._updateDragState(),o.done()),u}).next(this._updateTooltipPipelineStep(l)),r.next(()=>{if(o.cancel(),h(this._scaleRotateDragData)){switch(this._scaleRotateDragData.mode){case"none":break;case"rotate":this.tool.emit("graphic-rotate-stop",{graphic:i,angle:0});break;case"scale":this.tool.emit("graphic-scale-stop",{graphic:i,xScale:1,yScale:1})}this.startAnimation(xo(this,()=>this._onScaleChanged())),this._scaleRotateDragData=null,this._updateDragState()}this._updateFocusTooltip()})});this._handles.add([a,e.events.on("focus-changed",s=>{s.action==="focus"?this.startAnimation(Pp(this,()=>this._updateDelayedFocusedState())):this._updateDelayedFocusedState()}),e.events.on("immediate-click",s=>{s.stopPropagation()}),I(()=>{var s;return(s=this.tool.graphicState)==null?void 0:s.displaying},s=>this._ringManipulator.available=s,Ue)])}_updateTooltipPipelineStep(e){return i=>{const a=this._tooltipOptions;if(!a.enabled)return i;if(i.action==="end")return this._updateFocusTooltip(),i;const s=this._tooltip,n=this._tooltipOptions.visualVariables,r=h(n)?n.size:null,o=h(n)?n.rotation:null;switch(e.mode){case"scale":s.info=new wt({tooltipOptions:a,scale:{value:this._adapter.scale},size:Ti(K(this._adapter.size,-1),"meters"),sizeUnit:h(r)?r.unit:null,sizePrecision:h(r)?Xa(r.valueType):null});break;case"rotate":{const l=h(o)?Xa(o.valueType):null,p=h(o)?o.rotationType:"geographic";s.info=new lt({tooltipOptions:a,rotation:us(K(-this._adapter.relativeAngle,0),"radians","geographic"),rotationPrecision:l,orientation:us(-this._adapter.angle,"radians","geographic"),orientationPrecision:l,rotationType:p})}}return i}}_updateFocusTooltip(){if(!!this._tooltipOptions.enabled)if(this.getFocused()){const e=this._tooltipOptions.visualVariables,i=h(e)?e.rotation:null,a=h(e)?e.size:null;this._tooltip.info=new Re({tooltipOptions:this._tooltipOptions,orientation:us(-this._adapter.angle,"radians","geographic"),orientationEnabled:this._mode==null||this._mode==="rotate",orientationPrecision:h(i)?Xa(i.valueType):null,rotationType:h(i)?i.rotationType:"geographic",size:Ti(K(this._adapter.size,-1),"meters"),sizeUnit:h(a)?a.unit:null,sizeEnabled:this._mode==null||this._mode==="scale",sizePrecision:h(a)?Xa(a.valueType):null})}else this._tooltip.clear()}_onScaleChanged(){this.events.emit("scale-changed"),this._updateManipulatorTransform()}_updateDelayedFocusedState(){this._ringManipulator.updateStateEnabled(G.DelayedFocused,this.getFocused()),this._updateFocusTooltip()}_updateDragState(){if(this._ringManipulator.updateStateEnabled(G.Unlocked,!(h(this._scaleRotateDragData)&&this._scaleRotateDragData.mode!=="none")),h(this._scaleRotateDragData))switch(this._scaleRotateDragData.mode){case"rotate":this._ringManipulator.updateStateEnabled(G.ScaleIn|G.ScaleOut,!1),this._ringManipulator.updateStateEnabled(G.RotateLeft,this._scaleRotateDragData.angleDir<0),this._ringManipulator.updateStateEnabled(G.RotateRight,this._scaleRotateDragData.angleDir>=0);break;case"scale":this._ringManipulator.updateStateEnabled(G.RotateLeft|G.RotateRight,!1),this._ringManipulator.updateStateEnabled(G.ScaleIn,this._scaleRotateDragData.scaleDir<0),this._ringManipulator.updateStateEnabled(G.ScaleOut,this._scaleRotateDragData.scaleDir>=0)}else this._ringManipulator.updateStateEnabled(G.ScaleIn|G.ScaleOut|G.RotateLeft|G.RotateRight,!1)}_updateManipulatorTransform(){const e=yn(le.get(),this._adapter.angle,N(0,0,1));if(m(e))return;const i=this.getScale(),a=ha(le.get(),U(S.get(),i,i,i));this._ringManipulator.modelTransform=Xe(le.get(),a,e)}_createRingManipulator(){const e=(Z,je,pt)=>{const ut=[],gt=Math.ceil(Kr*(je-Z)/(2*Math.PI));for(let de=0;de<gt+1;de++){const gi=Z+de*(je-Z)/gt;ut.push(N(pt*Math.cos(gi),pt*Math.sin(gi),0))}return ut},i=Z=>e(0,2*Math.PI,Z),a=Z=>[[-Z/2,0],[Z/2,0],[Z/2,Gs/2],[-Z/2,Gs/2]],s=(Z,je)=>_r(a(je),Z,[],[],!1),n=i(jt),r=s(n,Vs),o={left:[],right:[]},l=[];for(let Z=0;Z<2;Z++){const je=Z*Math.PI-Math.PI/4,pt=Math.PI/2-ap,ut=je+pt,gt=je+Math.PI/2-pt,de=e(ut,gt,ep),gi=s(de,ci);l.push(de),l.push(e(ut,gt,io-Vs/2)),o.left.push(gi),o.right.push(gi);for(let qa=0;qa<2;qa++){const Ys=qa===0,Me=_e();if(Ys){yi(Me,Me,[1,-1,1]),Rn(Me,Me,-ut,[0,0,1]);const Et=Math.round(so*(de.length-1));Me[12]=de[Et][0],Me[13]=de[Et][1],Me[14]=de[Et][2]}else{Rn(Me,Me,gt,[0,0,1]);const Et=Math.round((1-so)*(de.length-1));Me[12]=de[Et][0],Me[13]=de[Et][1],Me[14]=de[Et][2]}const Ws=zi(tp,0,ip,Gs);gr(Ws,Me),(Ys?o.left:o.right).push(Ws)}}const p=[];for(let Z=0;Z<2;Z++){const je=Z*Math.PI-Math.PI/4,pt=Math.PI/2-sp,ut=je+pt,gt=je+Math.PI/2-pt,de=e(ut,gt,io);p.push(s(de,ci))}const u=i(jt+no),d=i(jt+ro),_=s(u,ci),f=s(d,ci),v=i(jt-no),M=i(jt-ro),E=s(v,ci),w=s(M,ci),A=this._createMaterial(),F=this._createMaterial(.66),ne=this._createMaterial(.5),De=this._createMaterial(.33);let W=[{geometry:r,material:A,stateMask:G.DelayedFocused},{geometry:r,material:ne,stateMask:x.None}];this._mode&&this._mode!=="scale"||(W=W.concat([{geometry:p,material:A,stateMask:G.DelayedFocused|G.Unlocked},{geometry:_,material:F,stateMask:G.DelayedFocused|G.ScaleIn},{geometry:f,material:De,stateMask:G.DelayedFocused|G.ScaleIn},{geometry:E,material:F,stateMask:G.DelayedFocused|G.ScaleOut},{geometry:w,material:De,stateMask:G.DelayedFocused|G.ScaleOut}])),this._mode&&this._mode!=="rotate"||(W=W.concat([{geometry:o.right,material:A,stateMask:G.DelayedFocused|G.Unlocked},{geometry:o.left,material:A,stateMask:G.DelayedFocused|G.RotateLeft},{geometry:o.right,material:A,stateMask:G.DelayedFocused|G.RotateRight}]));const ke=[n,...l];return new ge({view:this.tool.view,renderObjects:W,autoScaleRenderObjects:!1,worldOriented:!0,radius:Vs,focusMultiplier:1,touchMultiplier:1.5,elevationInfo:J(this.tool.graphicState.graphic),collisionType:{type:"ribbon",paths:ke,direction:N(0,0,1)}})}_createMaterial(e=1){const i=Rt([...qd,e]);return new Ze({color:i,transparent:e!==1,cullFace:se.Back,renderOccluded:$.Transparent})}get test(){return{ringManipulator:this._ringManipulator,tooltip:this._tooltip}}}function Ap(t,e){const i=D(S.get(),e.renderStart,t.origin),a=D(S.get(),e.renderEnd,t.origin),s=fe(i),n=fe(a);return s===0?0:n/s}function Tp(t,e,i,a){const{renderStart:s,renderEnd:n}=t,r=Ba(s,a,S.get()),o=Ba(n,a,S.get());if(gn(r,o)<ao*ao)return null;const l=D(S.get(),s,i),p=we(S.get(),l,xi(e)),u=s,d=H(S.get(),u,p),_=Ba(i,a,S.get()),f=r,v=Ba(d,a,S.get()),M=D(S.get(),v,f),E=D(S.get(),r,_),w=Ja(f,M),A=Ja(_,E);return Dn(w,o)<Dn(A,o)?"rotate":"scale"}function Ba(t,e,i){return e.projectToScreen(t,Fs),U(i,Fs[0],Fs[1],0)}function xo(t,e){let i=null,a=1;const s=()=>a;return{start:()=>{a=t.getScale(),i=t.getScale,t.getScale=s,e()},update:n=>(a+=((a+1)/2-a)*Math.min(n*rp,1),e(),Math.abs(a-1)<.01?ui.STOP:ui.CONTINUE),destroy:()=>{t.getScale=i,e()}}}function Pp(t,e){let i=0,a=null;const s=()=>!1;return{start:()=>{a=t.getFocused,t.getFocused=s,i=0,e()},update:n=>(i+=n,!a()||i>np?ui.STOP:ui.CONTINUE),destroy:()=>{t.getFocused=a,e()}}}function Xa(t){switch(t){case"integer":case"long":return 0;default:return null}}(function(t){t[t.CONTINUE=0]="CONTINUE",t[t.STOP=1]="STOP"})(ui||(ui={}));const Fs=Se();function Eo(t){return h(t.geometry)&&t.geometry.type==="mesh"?Rp(t.geometry):Dp(t)}function Rp(t){return h(t.transform)?$p(t,t.transform):Cp(t)}function Dp(t){let e=t.geometry,i=Jl;return{undo(a){i=a.geometry,a.geometry=e},redo(a){e=a.geometry,a.geometry=i}}}function $p(t,e){let i=e.clone(),a=null;return{undo:s=>{a=h(t.transform)?t.transform.clone():null,t.transform=i,s.notifyGeometryChanged()},redo:s=>{i=h(t.transform)?t.transform.clone():null,t.transform=a,s.notifyGeometryChanged()}}}function Cp(t){let e,i=t.vertexAttributes.clonePositional();return{undo:a=>{e=t.vertexAttributes.clonePositional(),t.vertexAttributes=i,a.notifyGeometryChanged()},redo:a=>{i=t.vertexAttributes.clonePositional(),t.vertexAttributes=e,a.notifyGeometryChanged()}}}let ht=class extends ds{constructor(t){super(t),this._interactionState=null}initialize(){this.addHandles([Jt(()=>h(this._interactionState)&&this._interactionState.angle!==this._interactionState.previousAngle?{interactionState:this._interactionState,angle:this._interactionState.state.angle}:null,({interactionState:t})=>{this._updateMeshRotation(t)},ga),Jt(()=>h(this._interactionState)&&this._interactionState.scale!==this._interactionState.previousScale?{interactionState:this._interactionState,scale:this._interactionState.state.scale}:null,({interactionState:t})=>{this._updateMeshSize(t)},ga)])}get angle(){const t=this.geometry.transform;if(m(t))return 0;const e=Mc(t.rotation)[2];return Math.abs(e)>.999999?tt(Sc(t.rotation))*Math.sign(e):0}get scale(){return h(this._interactionState)?this._interactionState.scale:1}startInteraction(){const t=new ct({angle:this.angle});this._interactionState=t;const e=()=>this._interactionState=null;return{state:t,done:e,cancel:()=>{t.cancel(),e()}}}createUndoRecord(){return Eo(this.graphic)}_updateMeshRotation(t){const e=this.geometry.anchor,i=this.viewingMode===mi.Global,{angle:a,previousAngle:s}=t;this.geometry.rotate(0,0,Ei(a-s),{origin:e,geographic:i}),t.previousAngle=a,h(this.geometry.transform)&&this.graphic.notifyMeshTransformChanged(),this.graphic.notifyGeometryChanged()}_updateMeshSize(t){const e=this.geometry.anchor,i=this.viewingMode===mi.Global,{scale:a,previousScale:s}=t;this.geometry.scale(a/s,{origin:e,geographic:i}),t.previousScale=a,h(this.geometry.transform)&&this.graphic.notifyMeshTransformChanged(),this.graphic.notifyGeometryChanged()}};c([g({constructOnly:!0})],ht.prototype,"graphic",void 0),c([g({constructOnly:!0})],ht.prototype,"geometry",void 0),c([g({constructOnly:!0})],ht.prototype,"viewingMode",void 0),c([g()],ht.prototype,"angle",null),c([g()],ht.prototype,"scale",null),c([g()],ht.prototype,"_interactionState",void 0),ht=c([q("esri.views.3d.interactive.editingTools.transformGraphic.ScaleRotateMeshAdapter")],ht);let ct=class extends _i{constructor(t){super(t),this.angle=0,this.initialAngle=0,this.previousAngle=0,this.previousScale=1,this.scale=1,this.initialAngle=t.angle,this.previousAngle=t.angle}get state(){const{angle:t,scale:e}=this;return{angle:t,scale:e}}cancel(){this.angle=this.initialAngle,this.scale=1}};c([g()],ct.prototype,"angle",void 0),c([g()],ct.prototype,"initialAngle",void 0),c([g()],ct.prototype,"previousAngle",void 0),c([g()],ct.prototype,"previousScale",void 0),c([g()],ct.prototype,"scale",void 0),c([g()],ct.prototype,"state",null),ct=c([q("InteractionState")],ct);let ue=class extends ds{constructor(t){super(t),this.sizeAxis=null,this._interactionState=null}initialize(){this.addHandles(Jt(()=>h(this._interactionState)?this._interactionState.state:null,t=>{this._updateSymbol(t)},ga))}get angle(){return h(this._interactionState)?this._interactionState.angle:h(this._orientationReferenceSymbolLayer)?Lp(this._orientationReferenceSymbolLayer.heading):0}get scale(){return h(this._interactionState)?this._interactionState.scale:1}get relativeAngle(){return this.angle-this.initialAngle}get initialAngle(){return h(this._interactionState)?this._interactionState.initialAngle:0}get size(){const t=this._sizeReferenceSymbolLayer;if(m(t))return null;const e=this.findLayerView(),i=this._graphicSymbol;if(m(e)||m(i)||i.type!=="point-3d")return null;const a=e.getSymbolLayerSize(i,t);if("size"in a&&h(a.size))return a.size;const s=this.sizeAxis;return"width"in a&&h(a.width)&&(m(s)||s==="width"||s==="all"||s==="width-and-depth")?a.width:"depth"in a&&h(t.depth)&&(m(s)||s==="depth"||s==="all"||s==="width-and-depth")?a.depth:"height"in a&&h(t.height)&&(m(s)||s==="height"||s==="all")?a.height:null}get _sizeReferenceSymbolLayer(){const t=this._graphicSymbol;return m(t)||t.symbolLayers.length===0?null:t.symbolLayers.find(e=>e.type==="object")}get _orientationReferenceSymbolLayer(){const t=this._graphicSymbol;return m(t)||t.symbolLayers.length===0?null:t.symbolLayers.find(e=>e.type==="object"&&h(e.heading))}get _graphicSymbol(){return h(this.graphic)&&h(this.graphic.symbol)&&this.graphic.symbol.type==="point-3d"?this.graphic.symbol:null}set _graphicSymbol(t){this.graphic.symbol=t}startInteraction(){const t=this._graphicSymbol,e=this.findLayerView();if(h(this._interactionState)||m(t)||m(e))return Ip;const i=t.symbolLayers.map(o=>o.type==="object"?e.getSymbolLayerSize(t,o):null).toArray(),a=t.clone(),s=this.angle,n=new dt({originalSymbol:a,angle:s,initialSizes:i});this._interactionState=n;const r=()=>this._interactionState=null;return{state:n,done:r,cancel:()=>{this._graphicSymbol=a,r()}}}createUndoRecord(){let t=this.graphic.symbol,e=null;return{undo:i=>{e=i.symbol,i.symbol=t},redo:i=>{t=i.symbol,i.symbol=e}}}_updateSymbol({scale:t,angle:e,originalSymbol:i,initialSizes:a}){const s=this._graphicSymbol;if(m(s)||s.type!=="point-3d")return;const n=s.clone(),r=-Ei(e-this.initialAngle);let o=!1;this._forEachObjectSymbolLayerPair(i,n,(l,p,u)=>{const d=K(l.heading,0)+r;p.heading!==d&&(p.heading=d,o=!0);const _=a[u];if(h(_)&&"width"in _){_.width=this.sizeFilter(_.width),_.height=this.sizeFilter(_.height),_.depth=this.sizeFilter(_.depth);const f=_.width*t;p.width!==f&&(p.width=f,o=!0);const v=_.depth*t;p.depth!==v&&(p.depth=v,o=!0);const M=_.height*t;p.height!==M&&(p.height=M,o=!0)}}),o&&(this._graphicSymbol=n)}_forEachObjectSymbolLayerPair(t,e,i){t.symbolLayers.forEach((a,s)=>{const n=e.symbolLayers.getItemAt(s);a.type==="object"&&n.type==="object"&&i(a,n,s)})}};function Lp(t){return-tt(t)}c([g()],ue.prototype,"angle",null),c([g()],ue.prototype,"scale",null),c([g()],ue.prototype,"relativeAngle",null),c([g()],ue.prototype,"initialAngle",null),c([g()],ue.prototype,"size",null),c([g()],ue.prototype,"sizeAxis",void 0),c([g({constructOnly:!0})],ue.prototype,"graphic",void 0),c([g()],ue.prototype,"_interactionState",void 0),c([g({constructOnly:!0})],ue.prototype,"findLayerView",void 0),c([g({constructOnly:!0})],ue.prototype,"sizeFilter",void 0),c([g()],ue.prototype,"_sizeReferenceSymbolLayer",null),c([g()],ue.prototype,"_orientationReferenceSymbolLayer",null),c([g()],ue.prototype,"_graphicSymbol",null),ue=c([q("esri.views.3d.interactive.editingTools.transformGraphic.ScaleRotateObjectSymbol3DAdapter")],ue);const Ip={state:{angle:0,scale:0},done:()=>{},cancel:()=>{}};let dt=class extends _i{constructor(t){super(t),this.angle=0,this.initialAngle=0,this.scale=1,this.initialAngle=t.angle}get state(){const{originalSymbol:t,angle:e,initialAngle:i,scale:a,initialSizes:s}=this;return{originalSymbol:t,angle:e,initialAngle:i,scale:a,initialSizes:s}}};c([g()],dt.prototype,"originalSymbol",void 0),c([g()],dt.prototype,"angle",void 0),c([g()],dt.prototype,"initialAngle",void 0),c([g()],dt.prototype,"initialSizes",void 0),c([g()],dt.prototype,"scale",void 0),c([g()],dt.prototype,"state",null),dt=c([q("InteractionState")],dt);let ye=class extends Sn(Le.EventedMixin(ca)){constructor(t){super(t),this.enableZ=!0,this.enableRotation=!0,this.enableScaling=!0,this.tooltipOptions=new vt,this.type="transform-3d",this._scaleRotate=null,this._snappingPipeline=new da,this._tooltip=null}initialize(){const{graphic:t,view:e}=this;this.graphicState=new Ae({graphic:t}),this.addHandles(I(()=>this.tooltipOptions.enabled,s=>{this._tooltip=s?new Ai({view:e}):X(this._tooltip)},cs)),this._moveManipulation=new Ut({tool:this,view:e,snapToScene:this.snapToScene,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZ&&Ht(t),radius:Ut.radiusForSymbol(t.symbol)}),this._moveManipulation.forEachManipulator(s=>this.handles.add(s.events.on("immediate-click",n=>{this.emit("immediate-click",z(L({},n),{graphic:t})),n.stopPropagation()})));const i=s=>n=>{this.handles.add(n.events.on("focus-changed",({action:r})=>{const o=this._tooltip;m(o)||(r==="focus"?this._updateMoveTooltip(s):o.clear())}))};this._moveManipulation.xyManipulation.forEachManipulator(i(P.XY)),this._moveManipulation.xyAxisManipulation.forEachManipulator(i(P.XY_AXIS)),this._moveManipulation.zManipulation.forEachManipulator(i(P.Z)),this._moveManipulation.elevationInfo=J(t);const a=t.geometry;if(this._moveManipulation.createGraphicDragPipeline((s,n,r,o,l)=>(h(a)&&s===P.XY&&(r=r.next(this._snappingPipeline.createSnapDragEventPipelineStep({snappingContext:new pa({elevationInfo:J(t),pointer:l,editGeometryOperations:ua.fromGeometry(new Pt({spatialReference:a.spatialReference}),e.state.viewingMode),visualizer:new Xi,excludeFeature:t}),snappingManager:this.snappingManager,updatingHandles:this.updatingHandles,cancel:o,useZ:!1}),this._snappingPipeline.next)),r=r.next(p=>(this._updateMoveTooltip(s,p),p))),this.graphicState,s=>{const{action:n,graphic:r,dxScreen:o,dyScreen:l}=s,p={graphic:r,dxScreen:o,dyScreen:l};switch(n){case"start":this.emit("graphic-translate-start",p),this.emit("record-undo",{record:this._createGeometryUndoRecord()});break;case"update":this.emit("graphic-translate",p);break;case"end":this.emit("graphic-translate-stop",p)}}),this._moveManipulation.angle=h(this._scaleRotate)?this._scaleRotate.angle:0,this._scaleRotateAdapter=this._createScaleRotateAdapter(),this.handles.add(I(()=>this._scaleRotateAdapter.angle,()=>this._updateMoveAngle())),this.enableScaling||this.enableRotation){const s=this.enableScaling&&this.enableRotation?null:this.enableScaling?"scale":"rotate";this._scaleRotate=new Op({tool:this,mode:s,adapter:this._scaleRotateAdapter,tooltipOptions:this.tooltipOptions}),this.handles.add(this._scaleRotate.events.on("scale-changed",()=>this._onScaleChanged()))}this.handles.add([Na({view:this.view,graphic:this.graphic,forEachManipulator:s=>this._forEachManipulator(s),onManipulatorsChanged:()=>Ot()}),this.graphicState.on("changed",()=>this._onGeometryChanged()),this._hideManipulatorsForGraphicState(),I(()=>e.scale,()=>this._updateMoveAngle())]),this.handles.add(this.view.trackGraphicState(this.graphicState)),this._onGeometryChanged(),this._updateMoveAngle(),this._forEachManipulator(s=>{s instanceof ge&&this.handles.add(s.events.on("grab-changed",()=>this._updateManipulatorsInteractive()))}),this.finishToolCreation()}destroy(){this._tooltip=X(this._tooltip),this._moveManipulation.destroy(),this._scaleRotate=X(this._scaleRotate),this._scaleRotateAdapter=X(this._scaleRotateAdapter),this._set("view",null),this._set("graphic",null)}_updateManipulatorsInteractive(){m(this._scaleRotate)||(this._scaleRotate.interactive=!this._moveManipulation.grabbing,this._moveManipulation.interactive=!this._scaleRotate.grabbing)}_createScaleRotateAdapter(){return h(this.graphic.geometry)&&this.graphic.geometry.type==="mesh"?new ht({graphic:this.graphic,geometry:this.graphic.geometry,viewingMode:this.view.state.viewingMode}):new ue({graphic:this.graphic,sizeFilter:t=>this._enforceNonZeroSize(t),findLayerView:()=>this.view.allLayerViews.find(t=>t.layer===this.graphic.layer),sizeAxis:h(this.tooltipOptions.visualVariables)&&h(this.tooltipOptions.visualVariables.size)?this.tooltipOptions.visualVariables.size.axis:null})}_forEachManipulator(t){this._moveManipulation.forEachManipulator(t),h(this._scaleRotate)&&this._scaleRotate.forEachManipulator(t)}_hideManipulatorsForGraphicState(){return I(()=>this.graphicState.displaying,t=>{this._forEachManipulator(e=>e.available=t),this._moveManipulation.zManipulation.available=t&&this.enableZ&&Ht(this.graphic)})}_createGeometryUndoRecord(){return Eo(this.graphic)}set snapToScene(t){this._moveManipulation&&(this._moveManipulation.snapToScene=t),this._set("snapToScene",t)}get updating(){return this.updatingHandles.updating}set location(t){this._moveManipulation.location=t,h(this._scaleRotate)&&(this._scaleRotate.location=t)}set elevationAlignedLocation(t){this._moveManipulation.elevationAlignedLocation=t,h(this._scaleRotate)&&(this._scaleRotate.elevationAlignedLocation=t)}reset(){}onHide(){h(this._scaleRotate)&&this._scaleRotate.cancelActiveAnimation()}_onScaleChanged(){if(m(this._scaleRotate))return;const t=this._scaleRotate.getScale();this._moveManipulation.displayScale=t}_updateMoveAngle(){this.view.state.viewingMode===mi.Local||this.view.scale<op?this._moveManipulation.angle=this._scaleRotateAdapter.angle:this._moveManipulation.angle=0}_onGeometryChanged(){Qr(this.view,this,this.graphic)}_enforceNonZeroSize(t){return t||this.view.state.camera.computeRenderPixelSizeAt(this._moveManipulation.renderLocation)}_updateMoveTooltip(t,e){const{tooltipOptions:i,_tooltip:a}=this;if(m(a))return;a.clear();const s=this.graphicState.isDraped?"on-the-ground":"absolute-height";switch(t){case P.XY:a.info=new Fi({tooltipOptions:i}),this._updateMoveTooltipDistance(a.info,e,(n,r)=>st(n,r,s));break;case P.XY_AXIS:a.info=new Es({tooltipOptions:i}),this._updateMoveTooltipDistance(a.info,e,(n,r)=>{const o=st(n,r,s);return ma(o,ja(e))});break;case P.Z:a.info=new wa({tooltipOptions:i}),this._updateMoveTooltipDistance(a.info,e,_a)}}_updateMoveTooltipDistance(t,e,i){if(h(e)&&e.action!=="end"){const{mapStart:a,mapEnd:s}=e,n=i(a,s);t.distance=h(n)?n:Oi}}get test(){return{discManipulator:this._moveManipulation.xyManipulation.test.discManipulator,zManipulator:this._moveManipulation.zManipulation.test.manipulator,ringManipulator:h(this._scaleRotate)?this._scaleRotate.test.ringManipulator:null,arrowManipulators:this._moveManipulation.xyAxisManipulation.test.arrowManipulators,scaleRotateAdapter:this._scaleRotateAdapter,scaleRotateTransform:this._scaleRotate,tooltip:this._tooltip}}};c([g({constructOnly:!0,nonNullable:!0})],ye.prototype,"view",void 0),c([g({constructOnly:!0,nonNullable:!0})],ye.prototype,"graphic",void 0),c([g({constructOnly:!0,nonNullable:!0})],ye.prototype,"enableZ",void 0),c([g()],ye.prototype,"enableRotation",void 0),c([g()],ye.prototype,"enableScaling",void 0),c([g({constructOnly:!0,type:vt})],ye.prototype,"tooltipOptions",void 0),c([g()],ye.prototype,"graphicState",void 0),c([g({value:!1})],ye.prototype,"snapToScene",null),c([g({constructOnly:!0})],ye.prototype,"snappingManager",void 0),c([g({readOnly:!0})],ye.prototype,"type",void 0),c([g({readOnly:!0})],ye.prototype,"updating",null),ye=c([q("esri.views.3d.interactive.editingTools.graphicTransform3D.GraphicTransformTool")],ye);let xt=class extends Kl(th){constructor(t){super(t),this.type="plane",this.position=null,this.heading=0,this.tilt=0,this.width=10,this.height=10}equals(t){return this.heading===t.heading&&this.tilt===t.tilt&&eh(this.position,t.position)&&this.width===t.width&&this.height===t.height}};c([g({readOnly:!0,json:{read:!1,write:!0}})],xt.prototype,"type",void 0),c([g({type:Pt}),Hi()],xt.prototype,"position",void 0),c([g({type:Number,nonNullable:!0,range:{min:0,max:360}}),Hi(),$n(t=>Cn.normalize(Ln(t),0,!0))],xt.prototype,"heading",void 0),c([g({type:Number,nonNullable:!0,range:{min:0,max:360}}),Hi(),$n(t=>Cn.normalize(Ln(t),0,!0))],xt.prototype,"tilt",void 0),c([g({type:Number,nonNullable:!0}),Hi()],xt.prototype,"width",void 0),c([g({type:Number,nonNullable:!0}),Hi()],xt.prototype,"height",void 0),xt=c([q("esri.analysis.SlicePlane")],xt);Mn("mac");const Gp=2,Vp=1.15,zp=1.15,Np=.7,Ki=N(1,.5,0);Rt([...Ki,Np]);Rt([...Ki,.5]);const Fp=Be(1,1,1,1),Hp=Be(1,.8,.6,1),kp=Be(1,.93,.86,1),jp=Rt([...Ki,1]),Up=Rt([...Ki,1]),Bp=3,Oo=11,Hs=22.5,ks=40,Ao=48,Xp=2.25,Yp=Rt([...Ki,1]),Wp=4,To=1,Zp=.3,qp=6,Qp=4;function Jp(t){const e=new Di;e.extensions.add("GL_OES_standard_derivatives");const{vertex:i,fragment:a,attributes:s,varyings:n}=e;return ms(i,t),s.add(O.POSITION,"vec3"),s.add(O.UV0,"vec2"),n.add("vUV","vec2"),i.code.add(R`void main(void) {
vUV = uv0;
gl_Position = proj * view * vec4(position, 1.0);
}`),a.uniforms.add([new yt("backgroundColor",r=>r.backgroundColor),new yt("gridColor",r=>r.gridColor),new pe("gridWidth",r=>r.gridWidth)]),a.code.add(R`void main() {
const float LINE_WIDTH = 1.0;
vec2 uvScaled = vUV * gridWidth;
vec2 gridUV = (fract(uvScaled + 0.5) - 0.5) / (LINE_WIDTH * fwidth(uvScaled));
vec2 grid = (1.0 - step(0.5, gridUV)) * step(-0.5, gridUV);
grid.x *= step(0.5, uvScaled.x) * step(uvScaled.x, gridWidth - 0.5);
grid.y *= step(0.5, uvScaled.y) * step(uvScaled.y, gridWidth - 0.5);
float gridFade = max(grid.x, grid.y);
float gridAlpha = gridColor.a * gridFade;
gl_FragColor =
vec4(backgroundColor.rgb * backgroundColor.a, backgroundColor.a) * (1.0 - gridAlpha) +
vec4(gridColor.rgb, 1.0) * gridAlpha;
}`),e}const Kp=Object.freeze(Object.defineProperty({__proto__:null,build:Jp},Symbol.toStringTag,{value:"Module"}));class js extends Ci{initializeProgram(e){return new Li(e.rctx,js.shader.get().build(this.configuration),_s)}initializePipeline(){return Ii({blending:Wh(Ye.ONE,Ye.ONE,Ye.ONE_MINUS_SRC_ALPHA,Ye.ONE_MINUS_SRC_ALPHA),depthTest:{func:ba.LESS},colorWrite:Gi})}}js.shader=new $i(Kp,()=>import("./SlicePlaneMaterial.glsl.43fa4dbf.js"));function eu(t,e){return qr(t.basis1,t.basis2,t.origin,e)}function tu(t,e,i,a){const s=e.worldUpAtPosition(t.origin,S.get()),n=S.get();switch(i){case ea.HEADING:B(n,s);break;case ea.TILT:B(n,t.basis1)}return Tt(t.origin,n,a)}function iu(t,e,i,a){const s=fe(a.basis1),n=fe(a.basis2),r=Po(a),o=Us(a),l=U(S.get(),0,0,0);H(l,Q(S.get(),a.basis1,e.direction[0]),Q(S.get(),a.basis2,e.direction[1])),H(l,a.origin,l);let p=0,u=1;if(Ya(e))e.direction[0]===1&&e.direction[1]===-1?p=Xs:e.direction[0]===1&&e.direction[1]===1?p=Math.PI:e.direction[0]===-1&&e.direction[1]===1&&(p=3*Math.PI/2),u=o;else{const _=e.direction[0]!==0?1:2;p=_===1?Xs:0,u=(_===1?n:s)-r}const d=hs(le.get(),p);yi(d,d,U(S.get(),u,u,u)),Xe(d,i,d),d[12]=0,d[13]=0,d[14]=0,t.modelTransform=d,t.renderLocation=l}function au(t,e,i,a){const s=a.worldUpAtPosition(i.origin,S.get()),n=su(i,Bt.POSITIVE_X),r=hs(le.get(),n.edge*Math.PI/2);bn(r,r,-cu(i,s)),Xe(r,e,r),r[12]=0,r[13]=0,r[14]=0,t.modelTransform=r,t.renderLocation=n.position}var Bt;function su(t,e){switch(e){case Bt.POSITIVE_X:return{basis:t.basis1,direction:1,position:H(S.get(),t.origin,t.basis1),edge:e};case Bt.POSITIVE_Y:return{basis:t.basis2,direction:1,position:H(S.get(),t.origin,t.basis2),edge:e};case Bt.NEGATIVE_X:return{basis:t.basis1,direction:-1,position:D(S.get(),t.origin,t.basis1),edge:e};case Bt.NEGATIVE_Y:return{basis:t.basis2,direction:-1,position:D(S.get(),t.origin,t.basis2),edge:e}}}function Po(t){const e=fe(t.basis1),i=fe(t.basis2);return Zp*Math.min(e,i)}function Us(t){return Po(t)}function Ya(t){return t.direction[0]!==0&&t.direction[1]!==0}function nu(t,e=ta.CENTER_ON_ARROW){const i=e===ta.CENTER_ON_CALLOUT?ks:0,a=[N(i,0,-Ao/2),N(i,0,Ao/2)],s=hu(a,!0),n=(M,E)=>ou(a,a,{tubeRadius:Bp,tipRadius:Oo,tipLength:Hs,tubeFocusMultiplier:Vp,tipFocusMultiplier:zp,padding:M,bothEnds:!0,flat:null,focusTipLength:!0,addCap:E}),r=n(0,!1),o=n(Xp,!0),l=new Ze({color:Fp,cullFace:se.Back,renderOccluded:$.Opaque}),p=new Ze({color:Hp,cullFace:se.Back,renderOccluded:$.Opaque}),u=new Ze({color:kp,cullFace:se.Back,renderOccluded:$.Opaque}),d=new Ze({color:Up,transparent:!0,writeDepth:!1,cullFace:se.Front,renderOccluded:$.Transparent}),_=rt([[i,0,0],[i-ks,0,0]]),f=rt([[i,0,0],[i-ks,0,0]]),v=new ws({color:jp,renderOccluded:$.OccludeAndTransparent});return new ge({view:t,renderObjects:[...r.normal.map(({part:M,geometry:E,transform:w})=>({geometry:E,material:M==="tip"?l:M==="cap"?p:u,transform:w,stateMask:x.Unfocused|Xt})),...o.normal.map(({geometry:M,transform:E})=>({geometry:M,material:d,transform:E,stateMask:x.Unfocused|Xt})),{geometry:_,material:v,stateMask:x.Unfocused|Xt|Bs},...r.focused.map(({part:M,geometry:E,transform:w})=>({geometry:E,material:M==="tip"?l:M==="cap"?p:u,transform:w,stateMask:x.Focused|Xt})),...o.focused.map(({geometry:M,transform:E})=>({geometry:M,material:d,transform:E,stateMask:x.Focused|Xt})),{geometry:f,material:v,stateMask:x.Focused|Xt|Bs}],autoScaleRenderObjects:!1,collisionType:{type:"line",paths:[s]},collisionPriority:1,radius:Oo,state:Xt})}function ru(t,e){const i=Ya(e),a=i?[N(1,0,0),N(0,0,0),N(0,1,0)]:[N(1,0,0),N(-1,0,0)],s=rt(a),n=Yp,r=v=>new Gt({color:n,width:v,renderOccluded:$.OccludeAndTransparent}),o=()=>new ws({color:n,renderOccluded:$.OccludeAndTransparent}),l=i?Wp:To,p=l*Gp,u=To,d=v=>v>1?r(v):o(),_=[{geometry:s,material:d(l),stateMask:x.Unfocused|Wa},{geometry:s,material:d(p),stateMask:x.Focused|Wa},{geometry:s,material:d(u),stateMask:Do}],f=new ge(L({view:t,renderObjects:_,collisionType:{type:"line",paths:[a]},radius:i?qp:Qp},Gd));return f.state=Wa,f}function ou(t,e,i){const a=s=>{const n=(s?e:t).slice(0),r=D(S.get(),n[0],n[1]);ie(r,r);const o=D(S.get(),n[n.length-1],n[n.length-2]);if(ie(o,o),i.padding>0){const A=Q(b(),o,-i.padding);if(n[n.length-1]=H(A,A,n[n.length-1]),i.bothEnds){const F=Q(b(),r,-i.padding);n[0]=H(F,F,n[0])}}const l=s?i.tipFocusMultiplier:1,p=i.tipLength*(i.focusTipLength?l:1),u=i.tipRadius*l,d=os(le.get());if(i.padding>0){const A=p/4,F=U(S.get(),0,A,0),ne=1+i.padding/A;aa(d,d,F),yi(d,d,U(S.get(),ne,ne,ne)),aa(d,d,Q(F,F,-1/ne))}const _=os(_e()),f=N(0,1,0),v=In(_e(),Gn(Vn.get(),f,o));v[12]=n[n.length-1][0],v[13]=n[n.length-1][1],v[14]=n[n.length-1][2],Xe(v,v,d);const M=[{part:"tube",geometry:lu(i.tubeRadius*(s?i.tubeFocusMultiplier:1)+i.padding,i.flat,n),transform:_}];let E,w;if(h(i.flat)?E=zi(p,u,u,i.flat.thickness):(E=xs(p,u,24,!1,!1,!0),w=xs(p,u,24,!1,!0,!1)),M.push({part:"tip",geometry:E,transform:v}),w&&M.push({part:"cap",geometry:w,transform:v}),i.bothEnds){const A=In(_e(),Gn(Vn.get(),f,r));A[12]=n[0][0],A[13]=n[0][1],A[14]=n[0][2],Xe(A,A,d),M.push({part:"tip",geometry:E,transform:A}),w&&M.push({part:"cap",geometry:w,transform:A})}return M};return{normal:a(!1),focused:a(!0)}}function lu(t,e,i){const a=[];if(h(e))a.push([t,e.thickness/2],[-t,e.thickness/2],[-t,-e.thickness/2],[t,-e.thickness/2]);else{const s=12;for(let n=0;n<s;n++){const r=n/s*2*Math.PI;a.push([Math.cos(r)*t,Math.sin(r)*t])}}return _r(a,i,[],[],!1)}function hu(t,e){const i=D(b(),t[t.length-1],t[t.length-2]);if(ie(i,i),Q(i,i,Hs),H(i,i,t[t.length-1]),e){const a=D(b(),t[0],t[1]);return ie(a,a),Q(a,a,Hs),H(a,a,t[0]),[a,...t,i]}return[...t,i]}function cu(t,e){return ih(e,t.basis2,t.basis1)+Xs}(function(t){t[t.POSITIVE_X=0]="POSITIVE_X",t[t.POSITIVE_Y=1]="POSITIVE_Y",t[t.NEGATIVE_X=2]="NEGATIVE_X",t[t.NEGATIVE_Y=3]="NEGATIVE_Y"})(Bt||(Bt={}));const Xt=ae.Custom1;var ea,Ro;(function(t){t[t.HEADING=1]="HEADING",t[t.TILT=2]="TILT"})(ea||(ea={})),function(t){t[t.HORIZONTAL_OR_VERTICAL=0]="HORIZONTAL_OR_VERTICAL",t[t.HORIZONTAL=1]="HORIZONTAL",t[t.VERTICAL=2]="VERTICAL",t[t.TILTED=3]="TILTED"}(Ro||(Ro={}));const Bs=ae.Custom2;fi();const Xs=Math.PI/2,Wa=ae.Custom1,Do=ae.Custom2;var ta;(function(t){t[t.CENTER_ON_CALLOUT=0]="CENTER_ON_CALLOUT",t[t.CENTER_ON_ARROW=1]="CENTER_ON_ARROW"})(ta||(ta={}));const $o="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAMAAACdt4HsAAAAnFBMVEUAAAD/gAD/gAD/cAD/gAD/eAD/gAD/eQD/gAD/egD/gAD/ewD/gAD/fAD/gAD/fAD/gAD/fAD/fQD/fQD/fQD/fQD/fQD/fgD/jR7/mjn/mjf/p1H/plH/smf/sWb/vHr/u3n/xYz/xIv/zZz/zJv/zJr/1Kv/1Kr/06r/06n/27n/27f/4cX/4cT/59D/7dr/8uX/9u7/+/f////u2EN0AAAAM3RSTlMACBAQICAoKDAwODhAQEhIUFBYYGhweICIkJCXmJ+gp6ivsLe4uL+/wMDHx8/P19/n7/cWvjXwAAACeUlEQVR42tWX3XqiMBCGY2pbtbrUnzhhdak/lHWliJD7v7fdJ+KG5AMhh30P8zCTmS+TycDaeBoHi5Wgf4jVYvbKmRfPgSAHMX9mPRnM1tSIGHM/c2QddLp4c8wxCvYIvqROBPfbHlm/sRYC6smMNTKn3sxZAyvyYNW1v38MM/IkcPQnZHPMLtciz9P9hhqwzoLD+cnfpTIUaYinyZlBkE2YKZcMXCyN/YhsPkuFlMfWJLiwo89VMxfpJDForMCwuG+Zx7ttGO2S/w4LJ42ZURDty5M0a4dqsZAQAihQfXqWdlhnpcmdEPAI0tv2EbnsbsKmdgi6/1GN7T1XJLx5sF0P9SWABMC+co5JBE4Ge/1NTM3EGIJgjFONXCdAbeQYwhN7pRrRV20LJNIhWOczdu+xPFzIBiQ62iIsyIOTvlZUY+HXySLQaMUEeSC1CPYxENIlwk+q8e0clFAIfiKG+qpaIvod4wfU8sqvkDLda+xCCqgDaAk7uyeNqD+feFlfGCcg3Hzsk+xS7Nz1Aq4CcauhhMc0uxaqIgcFsF0J+1WQyoCN7Y9ezeCVH5LhSxmyRvsihKbK1m7LafpSpkpj6yJgtsiVBh6AX5UyCVmMbrNpcwj5/h6DPN79JjAiQAhXVeN6SZI0q5bQnn4wBiHEqpUybp1ZJzWxStVCHhKhAhVLp/Emh6trHpGLaB6yZHk7wu3Z+ChOxhwUNEmYYjpUvqJDksSHraQmJm2DdqQK6sGUObybYtpSN+8Phm3pN2xjDH33R6b0CKxAZNLvl8foD3BBnSw5e8RI+G2P8GD9wHw6YN3wkfA0R4Zz8CGCIfOCv8zM738walXuLw6nXBvPr8wvAAAAAElFTkSuQmCC",du={mipmap:!0,preMultiplyAlpha:!0,width:64,height:64};function pu(t){return t.fromData($o,()=>new Qn($o,du))}class uu{constructor(){this._lastDragEvent=null,this.next=new ls,this._enabled=!1}get enabled(){return this._enabled}set enabled(e){if(this._enabled!==e&&h(this._lastDragEvent)){const i=z(L({},this._lastDragEvent),{action:"update"});e&&this._adjustScaleFactors(i),this.next.execute(i)}this._enabled=e}createDragEventPipelineStep(){return this._lastDragEvent=null,e=>(this._lastDragEvent=e.action!=="end"?L({},e):null,this._enabled&&this._adjustScaleFactors(e),e)}_adjustScaleFactors(e){const i=Ya(e.handle)?Math.max(Math.abs(e.factor1),Math.abs(e.factor2)):e.handle.direction[0]===0?Math.abs(e.factor2):Math.abs(e.factor1);e.factor1=e.factor1<0?-i:i,e.factor2=e.factor2<0?-i:i}get test(){return{_adjustScaleFactors:e=>this._adjustScaleFactors(e)}}}function Za(t,e){return Lo(t,e,!1)}function Co(t,e){return Lo(t,e,!0)}function Lo(t,e,i){if(t instanceof ah){if(t.operation instanceof sh)return gu(t.operation,e,i),!0;if(t.operation instanceof nh)return _u(t.operation,e,i),!0;if(t.operation instanceof rh)return mu(t.operation,e,i),!0}return!1}function gu(t,e,i=!1){const a=i?-1:1,s=N(a*t.dx,a*t.dy,a*t.dz);H(e.origin,e.origin,s)}function _u(t,e,i=!1){const a=i?-t.angle:t.angle;zn(e.basis1,e.basis1,vi,a),zn(e.basis2,e.basis2,vi,a)}function mu(t,e,i=!1){const a=i?1/t.factor1:t.factor1,s=i?1/t.factor2:t.factor2;Q(e.basis1,e.basis1,a),Q(e.basis2,e.basis2,s),Nn(e.origin,e.origin,t.origin,t.axis1,a),Nn(e.origin,e.origin,t.origin,t.axis2,s)}function fu(t,e,i,a){a||(a=ti());const s=re(ft.get(),t[1],-t[0]),n=re(ft.get(),Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),r=re(ft.get(),Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY),o=ft.get();e.components.forEach(u=>u.vertices.forEach(d=>{const _=d.pos;re(o,Fn(t,_),Fn(s,_)),oh(n,n,o),lh(r,r,o)}));const l=1e-6,p=re(ft.get(),r[0]-n[0]<l?i/2:0,r[1]-n[1]<l?i/2:0);return es(n,n,p),_t(r,r,p),Yt(a.basis1,t,(r[0]-n[0])/2),Yt(a.basis2,s,(r[1]-n[1])/2),re(a.origin,n[0]*t[0]+n[1]*s[0],n[0]*t[1]+n[1]*s[1]),_t(a.origin,a.origin,a.basis1),_t(a.origin,a.origin,a.basis2),a}function vu(t,e,i,a=0,s){s||(s=ti()),e.toRenderCoords(t.origin,i,s.origin);const n=S.get();H(n,t.origin,t.basis1),H(n,n,t.basis2),e.toRenderCoords(n,i,n);const r=S.get();H(r,t.origin,t.basis1),D(r,r,t.basis2),e.toRenderCoords(r,i,r);const o=S.get();D(o,t.origin,t.basis1),D(o,o,t.basis2),e.toRenderCoords(o,i,o);const l=S.get();D(l,t.origin,t.basis1),H(l,l,t.basis2),e.toRenderCoords(l,i,l);const p=mt(S.get(),n,r,.5);D(p,p,s.origin);const u=mt(S.get(),o,l,.5);D(u,s.origin,u),mt(s.basis1,p,u,.5);const d=mt(S.get(),l,n,.5);D(d,d,s.origin);const _=mt(S.get(),r,o,.5);D(_,s.origin,_),mt(s.basis2,d,_,.5);const f=we(S.get(),s.basis1,s.basis2),v=we(f,f,s.basis1);return ie(v,v),Q(s.basis2,v,Si(s.basis2,v)),Q(s.basis1,s.basis1,1+a/fe(s.basis1)),Q(s.basis2,s.basis2,1+a/fe(s.basis2)),_c(s),s}function Io(t,e,i,a){const s=S.get();D(s,D(s,t.origin,t.basis1),t.basis2);const n=S.get();$t(n,s,t.basis1,2);const r=S.get();$t(r,n,t.basis2,2);const o=S.get();$t(o,s,t.basis2,2),s[2]=n[2]=r[2]=o[2]=e;const l=a?"on-the-ground":"absolute-height",p=kn(va(s,n,i,l),va(o,r,i,l)),u=kn(va(n,r,i,l),va(s,o,i,l));return m(u)||m(p)?null:[p,u]}let be=class extends Le.EventedMixin(ca){constructor(t){super(t),this.enableZ=!0,this.enableRotation=!0,this.enableScaling=!0,this.tooltipOptions=new vt,this._preserveAspectRatio=new uu,this.grabbing=!1,this.inputState=null,this.type="transform-3d",this._handles=new it,this._moveZManipulator=null,this._resizeManipulators=null,this._rotateManipulator=null,this._attachmentOrigin=null,this._outlineVisualElement=null,this._mapBounds=ti(),this._mapBoundsStart=ti(),this._zmax=0,this._sizeStart=null,this._displayBounds=ti(),this._displayBoundsStart=ti(),this._displayBoundsMarginStart=0,this._resizeHandles=[{direction:[1,0]},{direction:[1,1]},{direction:[0,1]},{direction:[-1,1]},{direction:[-1,0]},{direction:[-1,-1]},{direction:[0,-1]},{direction:[1,-1]}],this._moveXYTooltipInfo=null,this._moveZTooltipInfo=null,this._rotateTooltipInfo=null,this._scaleTooltipInfo=null,this._startAngle=0,this._endAngle=0,this._startScale=At(),this._endScale=At()}initialize(){const{view:t,graphic:e,manipulators:i,_handles:a}=this,s=this._graphicState=new Ae({graphic:e}),n=e.geometry;this._editGeometryOperations=ua.fromGeometry(n,t.state.viewingMode),this._graphicMoveManipulation=new zs({tool:this,view:t,graphicState:s}),this._moveZManipulator=nu(t,ta.CENTER_ON_CALLOUT),this._moveZManipulator.state|=Bs,a.add([this._createMoveXYGraphicDragPipeline(),I(()=>this.enableZ,()=>this._updateManipulatorAvailability(this._moveZManipulator,V.TRANSLATE_Z)),this._createMoveZDragPipeline()]),i.add(this._moveZManipulator),this._resizeManipulators=this._resizeHandles.map(u=>{const d=ru(t,u);return a.add([I(()=>this.enableScaling,()=>this._updateManipulatorAvailability(d,V.SCALE)),d.events.on("grab-changed",_=>this._onResizeGrab(_)),this._createResizeDragPipeline(d,u)]),d}),i.addMany(this._resizeManipulators),this._rotateManipulatorTexture=pu(t.toolViewManager.textures),this._rotateManipulator=Ld(t,{texture:this._rotateManipulatorTexture.texture}),a.add([I(()=>this.enableRotation,()=>this._updateManipulatorAvailability(this._rotateManipulator,V.ROTATE)),this._rotateManipulator.events.on("grab-changed",u=>{this._onRotateGrab(u)}),this._createRotateDragPipeline(this._rotateManipulator)]),i.add(this._rotateManipulator),this._calculateMapBounds(),this._updateDisplayBounds();const r=Na({view:t,graphic:e,forEachManipulator:u=>this._forEachManipulator(u),onManipulatorsChanged:()=>Ot()});h(r)&&(this._outlineVisualElement=r.visualElement instanceof zt?r.visualElement:null),h(this._outlineVisualElement)&&a.add(this._outlineVisualElement.events.on("attachment-origin-changed",()=>this._updateDisplayBounds())),a.add(r),a.add([s.on("changed",()=>this._onGeometryChanged()),I(()=>s.displaying,()=>this._updateAllManipulatorAvailability()),I(()=>s.isDraped,()=>this._graphicDrapedChanged(),Ue),t.trackGraphicState(s)]);const o=t.pointsOfInterest;o&&a.add(I(()=>o.centerOnSurfaceFrequent.location,()=>this._updateDisplayBounds()));const l=u=>{a.add(u.events.on("grab-changed",()=>{this.grabbing=u.grabbing,this._updateAllManipulatorAvailability()}))};this._forEachManipulator(l);const p=(u,d)=>{a.add(u.events.on("immediate-click",_=>{d===V.TRANSLATE_XY&&this.emit("immediate-click",z(L({},_),{graphic:e})),_.stopPropagation()}))};this._forEachManipulator(p),this._onGeometryChanged(),this._updateAllManipulatorAvailability(),this._initializeTooltip(),this.finishToolCreation()}destroy(){this._mapBounds=null,this._displayBounds=null,this._rotateManipulatorTexture.release(),this._handles.destroy(),this._graphicMoveManipulation.destroy(),this._editGeometryOperations.destroy(),this._tooltip.destroy(),this._set("view",null),this._set("graphic",null)}_initializeTooltip(){const{_handles:t,view:e}=this,i=this._tooltip=new Ai({view:e}),a=()=>{i.info=this._getUpdatedTooltipInfo()};t.add([this.on("graphic-translate-start",a),this.on("graphic-translate",a),this.on("graphic-translate-stop",()=>{this._moveXYTooltipInfo=null,this._moveZTooltipInfo=null,this._tooltip.clear()}),this.on("graphic-rotate-start",s=>{this._startAngle=s.angle,a()}),this.on("graphic-rotate",s=>{this._endAngle=s.angle,a()}),this.on("graphic-rotate-stop",()=>{this._startAngle=0,this._endAngle=0,a()}),this.on("graphic-scale-start",s=>{re(this._startScale,s.xScale,s.yScale),re(this._endScale,s.xScale,s.yScale),a()}),this.on("graphic-scale",s=>{re(this._endScale,s.xScale,s.yScale),a()}),this.on("graphic-scale-stop",()=>{re(this._startScale,0,0),re(this._endScale,0,0),a()})]),this._forEachManipulator(s=>{t.add([s.events.on("focus-changed",a),s.events.on("grab-changed",a),s.events.on("drag",n=>{n.action==="cancel"?this._tooltip.clear():a()})])})}_getUpdatedTooltipInfo(){return this.tooltipOptions.enabled?this._graphicMoveManipulation.grabbing||this._graphicMoveManipulation.dragging?this._computeMoveXYTooltipInfo():this._moveZManipulator.focused?this._computeMoveZTooltipInfo():this._rotateManipulator.focused?this._computeRotateTooltipInfo():this._resizeManipulators.some(t=>t.focused)?this._computeScaleTooltipInfo():null:null}_computeMoveXYTooltipInfo(){return this._moveXYTooltipInfo=K(this._moveXYTooltipInfo,()=>new Fi({tooltipOptions:this.tooltipOptions}))}_computeMoveZTooltipInfo(){const t=this._moveZTooltipInfo=K(this._moveZTooltipInfo,()=>new wa({tooltipOptions:this.tooltipOptions})),e=this._moveUnit;if(this._moveZManipulator.dragging){const i=this._mapBoundsStart.origin,a=this._mapBounds.origin,s=mh(i,a,this.view.spatialReference);if(m(s))return null;t.distance=s}else t.distance=Ti(0,e);return t}_computeRotateTooltipInfo(){const t=this._rotateTooltipInfo=K(this._rotateTooltipInfo,()=>new wc({tooltipOptions:this.tooltipOptions}));return t.angle=this._startAngle-this._endAngle,t}_computeScaleTooltipInfo(){const t=this.graphic.geometry;if(m(t))return null;const e=this._scaleTooltipInfo=K(this._scaleTooltipInfo,()=>new xc({tooltipOptions:this.tooltipOptions})),i=Io(this._mapBounds,this._zmax,t.spatialReference,this._graphicState.isDraped);return m(i)?null:(e.xSize=i[0],e.ySize=i[1],h(this._sizeStart)&&this._resizeManipulators.some(a=>a.dragging)?(e.xScale=i[0].value/this._sizeStart[0].value,e.yScale=i[1].value/this._sizeStart[1].value):(e.xScale=1,e.yScale=1),e)}_graphicDrapedChanged(){this._handles.remove(Go),this._updateDisplayBounds(),this._graphicState.isDraped&&this._handles.add(this.view.elevationProvider.on("elevation-change",t=>{h(this._attachmentOrigin)&&mn(t.extent,this._attachmentOrigin.x,this._attachmentOrigin.y)&&this._updateDisplayBounds()}),Go)}_updateAllManipulatorAvailability(){this._forEachManipulator((t,e)=>this._updateManipulatorAvailability(t,e))}_updateManipulatorAvailability(t,e){const i=this.grabbing&&!t.grabbing;if(t.interactive=!i,t instanceof ge){const a=this._graphicState.displaying,s=this.enableZ&&Ht(this.graphic);switch(e){case V.ROTATE:t.available=a&&this.enableRotation;break;case V.SCALE:t.available=a&&(this.enableScaling||this.enableRotation||s),t.interactive=!i&&this.enableScaling,t.state=this.enableScaling?Wa:Do;break;case V.TRANSLATE_Z:t.available=a&&s;break;default:t.available=a}}}_forEachManipulator(t){this._graphicMoveManipulation.forEachManipulator(t),this._resizeManipulators.forEach(e=>t(e,V.SCALE)),t(this._rotateManipulator,V.ROTATE),t(this._moveZManipulator,V.TRANSLATE_Z)}get preserveAspectRatio(){return this._preserveAspectRatio.enabled}set preserveAspectRatio(t){this._preserveAspectRatio.enabled=t,this._set("preserveAspectRatio",t)}get _moveUnit(){return K(hh(this.view.spatialReference),"meters")}reset(){}_onGeometryChanged(){this._updateDisplayBounds()}_calculateMapBounds(){const t=this.graphic.geometry,e=this._editGeometryOperations.data,i=e.components[0].edges[0],a=es(ft.get(),i.leftVertex.pos,i.rightVertex.pos);ia(a,a);const s=K(za(this.view,this.graphic),()=>t.extent.center);let n=bu*this.view.pixelSizeAt(s);const r=this.view.spatialReference,o=t.spatialReference;r.equals(o)||(n*=ps(r)/ps(o)),fu(a,e,n,this._mapBounds),this._updateZMax()}_updateZMax(){const t=this._editGeometryOperations.data;if(!t.geometry.hasZ)return void(this._zmax=0);const e=t.coordinateHelper;let i=Number.NEGATIVE_INFINITY;for(const a of t.components)for(const s of a.vertices){const n=e.getZ(s.pos);i=Math.max(n,i)}this._zmax=i}_updateDisplayBounds(){const t=this.graphic.geometry;if(m(t))return;const e=h(this._outlineVisualElement)&&!this._graphicState.isDraped&&h(this._outlineVisualElement.attachmentOrigin)?this._outlineVisualElement.attachmentOrigin:za(this.view,this.graphic);this._attachmentOrigin=K(e,t.extent.center);const i=h(e)?e.z:Sa(this._mapBounds.origin,this.view.elevationProvider,ei.fromElevationInfo(J(this.graphic)),this.view.renderCoordsHelper),a=Ni(this._mapBounds);a.origin[2]=i,vu(a,this.view.renderCoordsHelper,t.spatialReference,this._displayBoundsMargin,this._displayBounds),this._updateManipulators()}get _displayBoundsMargin(){const t=this.view.pointsOfInterest,e=t?t.centerOnSurfaceFrequent.location:this._editGeometryOperations.data.geometry.extent.center;return yu*this.view.pixelSizeAt(e)}_createMoveXYGraphicDragPipeline(){return this._graphicMoveManipulation.createDragPipeline((t,e,i)=>this._applyGraphicMoveSteps(e,i,P.XY))}_createMoveZDragPipeline(){const t=this.view,e=this._editGeometryOperations.data.spatialReference;return Ie(this._moveZManipulator,(i,a,s)=>{const n=na(i.renderLocation),r=a.next(po(t,n,e)).next(Qt());this._applyGraphicMoveSteps(r,s,P.Z)})}_applyGraphicMoveSteps(t,e,i){const a=t.next(s=>(s.action==="start"&&(this.inputState={type:"move"},this._updateOperationStartProperties(),this.emit("graphic-translate-start",{graphic:this.graphic,dxScreen:s.screenDeltaX,dyScreen:s.screenDeltaY})),s)).next(Kt()).next(this._moveDragUpdateGeometry()).next(s=>{const n={graphic:this.graphic,dxScreen:s.screenDeltaX,dyScreen:s.screenDeltaY};switch(s.action){case"start":case"update":(s.mapEnd.x-s.mapStart.x||s.mapEnd.y-s.mapStart.y||s.mapEnd.z-s.mapStart.z)&&this.emit("graphic-translate",n);break;case"end":this.inputState=null,this.emit("graphic-translate-stop",n)}return s}).next(s=>this._updateMoveTooltip(s,i));return e.next(()=>{h(this.inputState)&&this.emit("graphic-translate-stop",{graphic:this.graphic,dxScreen:0,dyScreen:0}),this._cancel()}),a}_updateOperationStartProperties(){Ni(this._displayBounds,this._displayBoundsStart),Ni(this._mapBounds,this._mapBoundsStart),m(this.graphic.geometry)?this._sizeStart=null:this._sizeStart=Io(this._mapBoundsStart,this._zmax,this.graphic.geometry.spatialReference,this._graphicState.isDraped)}_moveDragUpdateGeometry(){return t=>{if(m(this.inputState)||this.inputState.type!=="move")return t;const e=[];for(const s of this._editGeometryOperations.data.components)e.push(...s.vertices);const i=t.action==="start"?at.NEW_STEP:at.ACCUMULATE_STEPS,a=this._editGeometryOperations.moveVertices(e,t.mapDeltaX,t.mapDeltaY,t.mapDeltaZ,i);return Za(a,this._mapBounds),this.graphic.geometry=this._editGeometryOperations.data.geometry,t}}_updateMoveTooltip(t,e){if(e===P.XY||e===P.XY_AXIS){const i=st(t.mapStart,t.mapEnd,this._graphicState.isDraped?"on-the-ground":"absolute-height");h(i)&&h(this._moveXYTooltipInfo)&&(this._moveXYTooltipInfo.distance=i)}return t}_onResizeGrab(t){if(t.action!=="start")return;const e=this._calculatePickRay(t.screenPoint);qt(this._displayBounds.plane,e,S.get())&&(this._updateOperationStartProperties(),this._displayBoundsMarginStart=this._displayBoundsMargin,this.inputState={type:"resize"})}_createResizeDragPipeline(t,e){return Ie(t,(i,a,s)=>{m(this.inputState)||(a.next(n=>(n.action==="start"&&this.emit("graphic-scale-start",{graphic:this.graphic,xScale:1,yScale:1}),n)).next(Fa(this.view,this._displayBoundsStart.plane)).next(n=>z(L({},n),{handle:e})).next(this._resizeDragRenderPlaneToFactors()).next(this._preserveAspectRatio.createDragEventPipelineStep(),this._preserveAspectRatio.next).next(this._resizeDragUpdateGeometry()).next(n=>{const r={graphic:this.graphic,xScale:n.factor1,yScale:n.factor2};switch(n.action){case"start":case"update":this.emit("graphic-scale",r);break;case"end":this.inputState=null,this.emit("graphic-scale-stop",r)}return n}),s.next(()=>{h(this.inputState)&&this.emit("graphic-scale-stop",{graphic:this.graphic,xScale:1,yScale:1}),this._cancel()}))})}_resizeDragRenderPlaneToFactors(){return t=>{const e=this._displayBoundsStart,i=t.handle.direction,a=this._displayBoundsMargin,s=this._displayBoundsMarginStart,n=B(S.get(),e.origin);$t(n,n,e.basis1,-i[0]),$t(n,n,e.basis2,-i[1]);const r=D(S.get(),t.renderEnd,n),o=D(S.get(),t.renderStart,n),l=Ya(t.handle),p=Us(e),u=Us(this._displayBounds)/p,d=(_,f)=>{if(_===0)return 1;let v=fe(f),M=.5*_*Si(f,r)/v;const E=M<0?-1:1;l&&(M+=(v-.5*_*Si(f,o)/v)*E*u);const w=v<1.5*s?1:Vo;return v=Math.max(v-s,Vo),E>0&&(M-=a),E*Math.max(E*(M/v),w)};return z(L({},t),{factor1:d(i[0],e.basis1),factor2:d(i[1],e.basis2)})}}_resizeDragUpdateGeometry(){return t=>{const e=B(b(),this._mapBoundsStart.origin);$t(e,e,this._mapBoundsStart.basis1,-t.handle.direction[0]),$t(e,e,this._mapBoundsStart.basis2,-t.handle.direction[1]);const i=re(At(),this._mapBoundsStart.basis1[0],this._mapBoundsStart.basis1[1]);ia(i,i);const a=[];for(const r of this._editGeometryOperations.data.components)a.push(...r.vertices);const s=t.action==="start"?at.NEW_STEP:at.ACCUMULATE_STEPS,n=this._editGeometryOperations.scaleVertices(a,e,i,t.factor1,t.factor2,s,Hn.REPLACE);return Ni(this._mapBoundsStart,this._mapBounds),Za(n,this._mapBounds),this.graphic.geometry=this._editGeometryOperations.data.geometry,t}}_onRotateGrab(t){if(t.action!=="start")return;const e=tu(this._displayBounds,this.view.renderCoordsHelper,ea.HEADING,Wt()),i=this._calculatePickRay(t.screenPoint);qt(e,i,S.get())&&(this._updateOperationStartProperties(),this.inputState={type:"rotate",rotatePlane:e})}_createRotateDragPipeline(t){return Ie(t,(e,i,a)=>{const s=this.inputState;m(s)||(i.next(n=>(n.action==="start"&&this.emit("graphic-rotate-start",{graphic:this.graphic,angle:0}),n)).next(Fa(this.view,s.rotatePlane)).next(this._rotateDragRenderPlaneToRotate(s)).next(this._rotateDragUpdateGeometry()).next(n=>{const r={graphic:this.graphic,angle:Ei(n.rotateAngle)};switch(n.action){case"start":case"update":this.emit("graphic-rotate",r);break;case"end":this.inputState=null,this.emit("graphic-rotate-stop",r)}return n}),a.next(()=>{h(this.inputState)&&this.emit("graphic-rotate-stop",{graphic:this.graphic,angle:0}),this._cancel()}))})}_rotateDragRenderPlaneToRotate(t){return e=>{const i=xi(t.rotatePlane),a=Zr(e.renderStart,e.renderEnd,this._displayBounds.origin,i);return z(L({},e),{rotateAxis:i,rotateAngle:a})}}_rotateDragUpdateGeometry(){return t=>{const e=B(b(),this._mapBoundsStart.origin),i=[];for(const n of this._editGeometryOperations.data.components)i.push(...n.vertices);const a=t.action==="start"?at.NEW_STEP:at.ACCUMULATE_STEPS,s=this._editGeometryOperations.rotateVertices(i,e,t.rotateAngle,a,Hn.REPLACE);return Ni(this._mapBoundsStart,this._mapBounds),Za(s,this._mapBounds),this.graphic.geometry=this._editGeometryOperations.data.geometry,t}}_calculatePickRay(t){const e=fi(),i=la(t);return hi(this.view.state.camera,i,e),ie(e.direction,e.direction),e}_updateManipulators(){if(!this.visible)return;const t=eu(this._displayBounds,le.get());au(this._rotateManipulator,t,this._displayBounds,this.view.renderCoordsHelper),this._updateZMoveHandle(this._moveZManipulator,t),this._resizeManipulators.forEach((e,i)=>{iu(e,this._resizeHandles[i],t,this._displayBounds)})}_updateZMoveHandle(t,e){const i=this._displayBounds,a={basis:i.basis1,direction:-1,position:D(S.get(),i.origin,i.basis1),edge:2},s=le.get();ch(s,e,a.edge*Math.PI/2),s[12]=0,s[13]=0,s[14]=0,t.modelTransform=s,t.renderLocation=a.position}_cancel(){const t=this._editGeometryOperations.lastOperation;m(t)||(this._editGeometryOperations.undo(),this.graphic.geometry=this._editGeometryOperations.data.geometry,Co(t,this._mapBounds),this._updateDisplayBounds(),this.inputState=null)}get canUndo(){return this._editGeometryOperations.canUndo}undo(){if(h(this.inputState))this.view.activeTool=null;else if(this.canUndo){const t=this._editGeometryOperations.undo();this.graphic.geometry=this._editGeometryOperations.data.geometry,Co(C(t),this._mapBounds),this._updateDisplayBounds()}}get canRedo(){return this._editGeometryOperations.canRedo}redo(){if(this.canRedo){const t=this._editGeometryOperations.redo();this.graphic.geometry=this._editGeometryOperations.data.geometry,Za(C(t),this._mapBounds),this._updateDisplayBounds()}}get test(){return{resizeManipulators:this._resizeManipulators,rotateManipulator:this._rotateManipulator,moveZManipulator:this._moveZManipulator,tooltip:this._tooltip}}};c([g({constructOnly:!0,nonNullable:!0})],be.prototype,"view",void 0),c([g({constructOnly:!0,nonNullable:!0})],be.prototype,"graphic",void 0),c([g({constructOnly:!0,nonNullable:!0})],be.prototype,"enableZ",void 0),c([g()],be.prototype,"enableRotation",void 0),c([g()],be.prototype,"enableScaling",void 0),c([g({constructOnly:!0,type:vt})],be.prototype,"tooltipOptions",void 0),c([g()],be.prototype,"preserveAspectRatio",null),c([g()],be.prototype,"grabbing",void 0),c([g()],be.prototype,"inputState",void 0),c([g({readOnly:!0})],be.prototype,"type",void 0),c([g()],be.prototype,"_moveUnit",null),be=c([q("esri.views.3d.interactive.editingTools.graphicTransform3D.ExtentTransformTool")],be);const Go="draped-elevation-changes",yu=10,bu=80,Vo=1e-6;var Bu=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",get DrawGraphicTool3D(){return Ft},get GraphicMoveTool(){return et},get GraphicReshapeTool(){return ce},get GraphicTransformTool(){return ye},get ExtentTransformTool(){return be}});export{zc as A,Er as C,Bu as e,Td as f,Jp as t,Cc as v,_d as w};
