import{aq as m,ar as u,as as k,ao as ne,E as _,m2 as H,M as oe,mV as le,aR as he,A as R,ds as N,bo as U,mW as F,h8 as T,a5 as de,gY as ce,kC as me,a3 as ue,aG as pe,ag as J,ah as I,az as fe,af as ye,x as K,J as _e,K as V,Z as ve,au as ge,a4 as we,b3 as Re,bn as Me,a9 as be,bp as xe,a7 as $e,a8 as je,aP as Ce,mK as Ee,hA as Te,fV as Ve,m6 as Se,m7 as Ae,mX as qe,X as De,eg as Pe,lJ as Ue,aQ as Ie}from"./vendor.150443b7.js";import{a as Oe}from"./normalizeUtilsSync.424adbeb.js";import{r as ze}from"./utils.9098e95e.js";import{E as Y,a as Le}from"./VertexArrayObject.b8066877.js";import{P as We,G as Ge,L as Qe,D as Be,F as X}from"./enums.2d9e6f64.js";import{n as Z,E as ke}from"./Texture.0551b3c6.js";import{r as He}from"./vec3f32.1121a836.js";import{o as Ne,c as Fe}from"./WGLContainer.8ea5db01.js";import{I as Je}from"./Utils.eb4237a0.js";import{y as Ke}from"./LayerView2D.494015a0.js";import{u as Ye}from"./LayerView.2481493a.js";import"./MaterialKey.420ab2c9.js";import"./alignmentUtils.6849a0a8.js";import"./definitions.d3c1cadf.js";import"./pixelUtils.e6b9584d.js";import"./VertexElementDescriptor.1fdca6da.js";import"./vec4f32.f3b49d2e.js";import"./ProgramTemplate.30b3a6f7.js";import"./number.30628ef2.js";import"./StyleDefinition.5e257d9e.js";import"./config.82550349.js";import"./GeometryUtils.51c4032a.js";import"./earcut.afc1d357.js";let p=class extends ne{constructor(r){super(r)}get bounds(){const r=this.coords;return _(r)||_(r.extent)?null:H(r.extent)}get coords(){var e;const r=(e=oe(this.element.georeference))==null?void 0:e.coords;return le(r,this.spatialReference).geometry}get normalizedCoords(){return he.fromJSON(Oe(this.coords))}get normalizedBounds(){const r=R(this.normalizedCoords)?this.normalizedCoords.extent:null;return R(r)?H(r):null}};m([u()],p.prototype,"spatialReference",void 0),m([u()],p.prototype,"element",void 0),m([u()],p.prototype,"bounds",null),m([u()],p.prototype,"coords",null),m([u()],p.prototype,"normalizedCoords",null),m([u()],p.prototype,"normalizedBounds",null),p=m([k("esri.layers.support.media.MediaElementView")],p);const O=ue(),M=T(),z=T(),ee=T();function Xe(r,e,t){return te(z,e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7]),te(ee,t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7]),U(r,F(z,z),ee)}function te(r,e,t,s,a,i,n,h,f){N(r,e,s,i,t,a,n,1,1,1),de(O,h,f,1),F(M,r);const[o,l,d]=ce(O,O,me(M,M));return N(M,o,0,0,0,l,0,0,0,d),U(r,M,r)}const b=T();class Ze extends ze{constructor(e){super(),this.elementView=e,this.isWrapAround=!1,this.perspectiveTransform=pe(),this._vertices=new Float32Array(20),this._handles=[],this._handles.push(J(()=>this.elementView.element.opacity,t=>this.opacity=t,I),J(()=>[this.elementView.coords],()=>{this.requestRender()},I),fe(()=>this.elementView.element.loaded,()=>{const t=this.elementView.element;this.ready(),t.type==="video"&&R(t.content)&&this._handles.push(ye(t.content,"play",()=>this.requestRender()))},I)),e.element.load().catch(t=>{K.getLogger("esri.views.2d.layers.MediaLayerView2D").error(new _e("element-load-error","Element cannot be displayed",{element:e,error:t}))})}destroy(){var e;this._handles.forEach(t=>t.remove()),(e=this.texture)==null||e.dispose(),this.texture=null}get dvsMat3(){return this.parent.dvsMat3}beforeRender(e){const{context:t}=e,s=this.elementView.element.content;if(R(s)){const a=s instanceof HTMLImageElement,i=s instanceof HTMLVideoElement,n=a?s.naturalWidth:i?s.videoWidth:s.width,h=a?s.naturalHeight:i?s.videoHeight:s.height;this._updatePerspectiveTransform(n,h),this.texture?i&&!s.paused&&(this.texture.setData(s),this.requestRender(),(Z(t.gl)||V(n)&&V(h))&&this.texture.generateMipmap()):(this.texture=new ke(t,{pixelFormat:We.RGBA,dataType:Ge.UNSIGNED_BYTE,samplingMode:Qe.LINEAR,wrapMode:Be.CLAMP_TO_EDGE,width:n,height:h,preMultiplyAlpha:!0},s),(Z(t.gl)||V(n)&&V(h))&&this.texture.generateMipmap(),i&&!s.paused&&this.requestRender())}super.beforeRender(e)}_createTransforms(){return null}updateDrawCoords(e,t){const s=this.elementView.coords;if(_(s))return;const[a,i,n,h]=s.rings[0],f=this._vertices,{x:o,y:l}=e,d=t!==0;d?f.set([i[0]-o,i[1]-l,a[0]-o,a[1]-l,n[0]-o,n[1]-l,h[0]-o,h[1]-l,h[0]-o,h[1]-l,i[0]+t-o,i[1]-l,i[0]+t-o,i[1]-l,a[0]+t-o,a[1]-l,n[0]+t-o,n[1]-l,h[0]+t-o,h[1]-l]):f.set([i[0]-o,i[1]-l,a[0]-o,a[1]-l,n[0]-o,n[1]-l,h[0]-o,h[1]-l]),this.isWrapAround=d}getVAO(e,t,s){if(_(this.elementView.coords))return null;const a=this._vertices;if(this._vao)this._geometryVbo.setData(a);else{this._geometryVbo=Y.createVertex(e,X.DYNAMIC_DRAW,a);const i=Y.createVertex(e,X.STATIC_DRAW,new Uint16Array([0,0,0,1,1,0,1,1,1,1,0,0,0,0,0,1,1,0,1,1]));this._vao=new Le(e,s,t,{geometry:this._geometryVbo,tex:i})}return this._vao}_updatePerspectiveTransform(e,t){const s=this._vertices;Xe(b,[0,0,e,0,0,t,e,t],[s[0],s[1],s[4],s[5],s[2],s[3],s[6],s[7]]),ve(this.perspectiveTransform,b[6]/b[8]*e,b[7]/b[8]*t)}}class et extends Ne{constructor(){super(...arguments),this._localOrigin=ge(0,0),this._viewStateId=-1,this._dvsMat3=we(),this.requiresDedicatedFBO=!1}get dvsMat3(){return this._dvsMat3}beforeRender(e){this._updateMatrices(e),this._updateOverlays(e,this.children);for(const t of this.children)t.beforeRender(e)}prepareRenderPasses(e){const t=e.registerRenderPass({name:"overlay",brushes:[Fe.overlay],target:()=>this.children,drawPhase:Je.MAP});return[...super.prepareRenderPasses(e),t]}_updateMatrices(e){const{state:t}=e,{id:s,size:a,pixelRatio:i,resolution:n,rotation:h,viewpoint:f,displayMat3:o}=t;if(this._viewStateId===s)return;const l=Math.PI/180*h,d=i*a[0],g=i*a[1],{x:$,y:S}=f.targetGeometry,A=Re($,t.spatialReference);this._localOrigin.x=A,this._localOrigin.y=S;const j=n*d,w=n*g,c=Me(this._dvsMat3);U(c,c,o),be(c,c,xe(d/2,g/2)),$e(c,c,He(d/j,-g/w,1)),je(c,c,-l),this._viewStateId=s}_updateOverlays(e,t){const{state:s}=e,{rotation:a,spatialReference:i,worldScreenWidth:n,size:h,viewpoint:f}=s,o=this._localOrigin;let l=0;if(i.isWrappable){const d=h[0],g=h[1],$=180/Math.PI*a,S=Math.abs(Math.cos($)),A=Math.abs(Math.sin($)),j=Math.round(d*S+g*A),[w,c]=Ce(i).valid,y=Ee(i),{x:L,y:se}=f.targetGeometry,re=[L,se],q=[0,0];s.toScreen(q,re);const C=[0,0];let D;D=j>n?.5*n:.5*j;const W=Math.floor((L+.5*y)/y),ie=w+W*y,ae=c+W*y,P=[q[0]+D,0];s.toMap(C,P),C[0]>ae&&(l=y),P[0]=q[0]-D,s.toMap(C,P),C[0]<ie&&(l=-y);for(const E of t){const G=E.elementView.bounds;if(_(G))continue;const[Q,,B]=G;Q<w&&B>w?E.updateDrawCoords(o,y):B>c&&Q<c?E.updateDrawCoords(o,-y):E.updateDrawCoords(o,l)}}else for(const d of t)d.updateDrawCoords(o,l)}}let v=class extends Ke(Ye){constructor(){super(...arguments),this._overlayContainer=null,this._fetchQueue=null,this._tileStrategy=null,this._elementReferences=new Map,this.layer=null,this.elements=new Te}attach(){this.handles.add(Ve(()=>this.layer.source,"refresh",()=>{for(const r of this._tileStrategy.tiles)this._updateTile(r);this.requestUpdate()})),this._overlayContainer=new et,this.container.addChild(this._overlayContainer),this._fetchQueue=new Se({tileInfoView:this.view.featuresTilingScheme,concurrency:10,process:(r,e)=>this._queryElements(r,e)}),this._tileStrategy=new Ae({cachePolicy:"purge",resampling:!0,acquireTile:r=>this._acquireTile(r),releaseTile:r=>this._releaseTile(r),tileInfoView:this.view.featuresTilingScheme}),this.requestUpdate()}detach(){this.handles.removeAll(),this.elements.removeAll(),this._tileStrategy.destroy(),this._fetchQueue.destroy(),this._overlayContainer.removeAllChildren(),this.container.removeAllChildren(),this._elementReferences.clear()}supportsSpatialReference(r){return!0}moveStart(){this.requestUpdate()}viewChange(){this.requestUpdate()}moveEnd(){this.requestUpdate()}update(r){this._tileStrategy.update(r)}async hitTest(r,e){const t=[],s=r.normalize(),a=[s.x,s.y];for(const{projectedElement:{normalizedCoords:i,element:n}}of this._elementReferences.values())R(i)&&qe(i.rings,a)&&t.push({type:"media",element:n,layer:this.layer,mapPoint:r});return t.reverse()}canResume(){return this.layer.source!=null&&super.canResume()}async doRefresh(){}_acquireTile(r){const e=new tt(r.clone());return this._updateTile(e),e}_updateTile(r){this.updatingHandles.addPromise(this._fetchQueue.push(r.key).then(e=>{const[t,s]=r.setElements(e);this._acquireElements(r,t),this._releaseElements(r,s),this.requestUpdate()},e=>{De(e)||K.getLogger(this.declaredClass).error(e)}))}_releaseTile(r){this._fetchQueue.abort(r.key.id),r.elements&&this._releaseElements(r,r.elements),this.requestUpdate()}async _queryElements(r,e){const t=this.layer.source;if(_(t))return[];this.view.featuresTilingScheme.getTileBounds(x,r,!0);const s=new Pe({xmin:x[0],ymin:x[1],xmax:x[2],ymax:x[3],spatialReference:this.view.spatialReference});return t.queryElements(s,e)}_acquireElements(r,e){const t=this.layer.source,s=this.view.spatialReference;if(!_(t))for(const a of e)Ue(this._elementReferences,a.uid,()=>{const i=new p({element:a,spatialReference:s}),n=new Ze(i);return this._overlayContainer.addChild(n),this.elements.add(a),{tiles:new Set,projectedElement:i,overlay:n}}).tiles.add(r)}_releaseElements(r,e){for(const t of e){const s=this._elementReferences.get(t.uid);s.tiles.delete(r),s.tiles.size||(this._overlayContainer.removeChild(s.overlay),s.overlay.destroy(),s.projectedElement.destroy(),this._elementReferences.delete(t.uid),this.elements.remove(t))}}};m([u()],v.prototype,"_fetchQueue",void 0),m([u()],v.prototype,"layer",void 0),m([u({readOnly:!0})],v.prototype,"elements",void 0),v=m([k("esri.views.2d.layers.MediaLayerView2D")],v);const x=Ie();class tt{constructor(e){this.key=e,this.elements=null,this.isReady=!1,this.visible=!0}setElements(e){const t=[],s=new Set(this.elements);this.elements=e;for(const a of e)s.has(a)?s.delete(a):t.push(a);return this.isReady=!0,[t,Array.from(s)]}}const $t=v;export{$t as default};
