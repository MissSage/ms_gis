import{n as pt}from"./deduplicate.1d8fe9a7.js";import{T as R}from"./InterleavedLayout.9c97d639.js";import{O as g}from"./VertexAttribute.42396f25.js";import{o as W}from"./glUtil.b02793dc.js";import{gn as et,oi as It,oj as At,ao as B,g8 as nt,g7 as H,g5 as ot,jf as ht,i2 as Ot,g4 as rt,gp as st,am as T,fN as St,c6 as wt,g6 as vt}from"./vendor.faf54504.js";const Tt=R().vec3f(g.POSITION).u16(g.COMPONENTINDEX).u16(g.U16PADDING),Et=R().vec2u8(g.SIDENESS);W(Et);const it=R().vec3f(g.POSITION0).vec3f(g.POSITION1).u16(g.COMPONENTINDEX).u8(g.VARIANTOFFSET,{glNormalized:!0}).u8(g.VARIANTSTROKE).u8(g.VARIANTEXTENSION,{glNormalized:!0}).u8(g.U8PADDING,{glPadding:!0}).u16(g.U16PADDING,{glPadding:!0}),X=it.clone().vec3f(g.NORMAL),G=it.clone().vec3f(g.NORMALA).vec3f(g.NORMALB);new Map([[g.POSITION0,0],[g.POSITION1,1],[g.COMPONENTINDEX,2],[g.VARIANTOFFSET,3],[g.VARIANTSTROKE,4],[g.VARIANTEXTENSION,5],[g.NORMAL,6],[g.NORMALA,6],[g.NORMALB,7],[g.SIDENESS,8]]);const V=-1;var ct;function Pt(t,e,o,r=Mt){const s=t.vertices.position,c=t.vertices.componentIndex,N=et(r.anglePlanar),a=et(r.angleSignificantEdge),d=Math.cos(a),l=Math.cos(N),f=K.edge,I=f.position0,A=f.position1,p=f.faceNormal0,E=f.faceNormal1,h=Lt(t),P=Dt(t),n=P.length/4,i=e.allocate(n);let u=0;const m=n,O=o.allocate(m);let v=0,$=0,S=0;const Q=It(0,n),F=new Float32Array(n);At(F,(D,w,x)=>{s.getVec(P[4*w+0],I),s.getVec(P[4*w+1],A),x[w]=St(I,A)}),Q.sort((D,w)=>F[w]-F[D]);const Y=new Array,Z=new Array;for(let D=0;D<n;D++){const w=Q[D],x=F[w],C=P[4*w+0],dt=P[4*w+1],L=P[4*w+2],U=P[4*w+3],tt=U===V;if(s.getVec(C,I),s.getVec(dt,A),tt)B(p,h[3*L+0],h[3*L+1],h[3*L+2]),nt(E,p),f.componentIndex=c.get(C),f.cosAngle=H(p,E);else{if(B(p,h[3*L+0],h[3*L+1],h[3*L+2]),B(E,h[3*U+0],h[3*U+1],h[3*U+2]),f.componentIndex=c.get(C),f.cosAngle=H(p,E),yt(f,l))continue;f.cosAngle<-.9999&&nt(E,p)}$+=x,S++,tt||$t(f,d)?(e.write(i,u++,f),Y.push(x)):Vt(f,N)&&(o.write(O,v++,f),Z.push(x))}const mt=new Float32Array(Y.reverse()),Nt=new Float32Array(Z.reverse());return{regular:{instancesData:e.trim(i,u),lodInfo:{lengths:mt}},silhouette:{instancesData:o.trim(O,v),lodInfo:{lengths:Nt}},averageEdgeLength:$/S}}function $t(t,e){return t.cosAngle<e}function yt(t,e){return t.cosAngle>e}function Vt(t,e){const o=ht(t.cosAngle),r=K.fwd,s=K.ortho;return Ot(r,t.position1,t.position0),o*(H(ot(s,t.faceNormal0,t.faceNormal1),r)>0?-1:1)>e}function Dt(t){const e=t.faces.length/3,o=t.faces,r=t.neighbors;let s=0;for(let a=0;a<e;a++){const d=r[3*a+0],l=r[3*a+1],f=r[3*a+2],I=o[3*a+0],A=o[3*a+1],p=o[3*a+2];s+=d===V||I<A?1:0,s+=l===V||A<p?1:0,s+=f===V||p<I?1:0}const c=new Int32Array(4*s);let N=0;for(let a=0;a<e;a++){const d=r[3*a+0],l=r[3*a+1],f=r[3*a+2],I=o[3*a+0],A=o[3*a+1],p=o[3*a+2];(d===V||I<A)&&(c[N++]=I,c[N++]=A,c[N++]=a,c[N++]=d),(l===V||A<p)&&(c[N++]=A,c[N++]=p,c[N++]=a,c[N++]=l),(f===V||p<I)&&(c[N++]=p,c[N++]=I,c[N++]=a,c[N++]=f)}return c}function Lt(t){const e=t.faces.length/3,o=t.vertices.position,r=t.faces,s=z.v0,c=z.v1,N=z.v2,a=new Float32Array(3*e);for(let d=0;d<e;d++){const l=r[3*d+0],f=r[3*d+1],I=r[3*d+2];o.getVec(l,s),o.getVec(f,c),o.getVec(I,N),rt(c,c,s),rt(N,N,s),ot(s,c,N),st(s,s),a[3*d+0]=s[0],a[3*d+1]=s[1],a[3*d+2]=s[2]}return a}(function(t){t[t.SOLID=0]="SOLID",t[t.SKETCH=1]="SKETCH"})(ct||(ct={}));const K={edge:{position0:T(),position1:T(),faceNormal0:T(),faceNormal1:T(),componentIndex:0,cosAngle:0},ortho:T(),fwd:T()},z={v0:T(),v1:T(),v2:T()},Mt={anglePlanar:4,angleSignificantEdge:35};function at(t,e,o){const r=e/3,s=new Uint32Array(o+1),c=new Uint32Array(o+1),N=(n,i)=>{n<i?s[n+1]++:c[i+1]++};for(let n=0;n<r;n++){const i=t[3*n],u=t[3*n+1],m=t[3*n+2];N(i,u),N(u,m),N(m,i)}let a=0,d=0;for(let n=0;n<o;n++){const i=s[n+1],u=c[n+1];s[n+1]=a,c[n+1]=d,a+=i,d+=u}const l=new Uint32Array(6*r),f=s[o],I=(n,i,u)=>{if(n<i){const m=s[n+1]++;l[2*m]=i,l[2*m+1]=u}else{const m=c[i+1]++;l[2*f+2*m]=n,l[2*f+2*m+1]=u}};for(let n=0;n<r;n++){const i=t[3*n],u=t[3*n+1],m=t[3*n+2];I(i,u,n),I(u,m,n),I(m,i,n)}const A=(n,i)=>{const u=2*n,m=i-n;for(let O=1;O<m;O++){const v=l[u+2*O],$=l[u+2*O+1];let S=O-1;for(;S>=0&&l[u+2*S]>v;S--)l[u+2*S+2]=l[u+2*S],l[u+2*S+3]=l[u+2*S+1];l[u+2*S+2]=v,l[u+2*S+3]=$}};for(let n=0;n<o;n++)A(s[n],s[n+1]),A(f+c[n],f+c[n+1]);const p=new Int32Array(3*r),E=(n,i)=>n===t[3*i]?0:n===t[3*i+1]?1:n===t[3*i+2]?2:-1,h=(n,i)=>{const u=E(n,i);p[3*i+u]=-1},P=(n,i,u,m)=>{const O=E(n,i);p[3*i+O]=m;const v=E(u,m);p[3*m+v]=i};for(let n=0;n<o;n++){let i=s[n];const u=s[n+1];let m=c[n];const O=c[n+1];for(;i<u&&m<O;){const v=l[2*i],$=l[2*f+2*m];v===$?(P(n,l[2*i+1],$,l[2*f+2*m+1]),i++,m++):v<$?(h(n,l[2*i+1]),i++):(h($,l[2*f+2*m+1]),m++)}for(;i<u;)h(n,l[2*i+1]),i++;for(;m<O;)h(l[2*f+2*m],l[2*f+2*m+1]),m++}return p}class lt{updateSettings(e){this.settings=e,this._edgeHashFunction=e.reducedPrecision?Rt:xt}write(e,o,r){const s=this._edgeHashFunction(r);j.seed=s;const c=j.getIntRange(0,255),N=j.getIntRange(0,this.settings.variants-1),a=.7,d=j.getFloat(),l=255*(.5*Ft(-(1-Math.min(d/a,1))+Math.max(0,d-a)/(1-a),1.2)+.5);e.position0.setVec(o,r.position0),e.position1.setVec(o,r.position1),e.componentIndex.set(o,r.componentIndex),e.variantOffset.set(o,c),e.variantStroke.set(o,N),e.variantExtension.set(o,l)}trim(e,o){return e.slice(0,o)}}const k=new Float32Array(6),_=new Uint32Array(k.buffer),y=new Uint32Array(1);function xt(t){const e=k;e[0]=t.position0[0],e[1]=t.position0[1],e[2]=t.position0[2],e[3]=t.position1[0],e[4]=t.position1[1],e[5]=t.position1[2],y[0]=5381;for(let o=0;o<_.length;o++)y[0]=31*y[0]+_[o];return y[0]}function Rt(t){const e=k;e[0]=M(t.position0[0]),e[1]=M(t.position0[1]),e[2]=M(t.position0[2]),e[3]=M(t.position1[0]),e[4]=M(t.position1[1]),e[5]=M(t.position1[2]),y[0]=5381;for(let o=0;o<_.length;o++)y[0]=31*y[0]+_[o];return y[0]}const ft=1e4;function M(t){return Math.round(t*ft)/ft}function Ft(t,e){const o=t<0?-1:1;return Math.abs(t)**e*o}class q{constructor(){this._commonWriter=new lt}updateSettings(e){this._commonWriter.updateSettings(e)}allocate(e){return X.createBuffer(e)}write(e,o,r){this._commonWriter.write(e,o,r),vt(b,r.faceNormal0,r.faceNormal1),st(b,b),e.normal.setVec(o,b)}trim(e,o){return this._commonWriter.trim(e,o)}}q.Layout=X,q.glLayout=W(X,1);class J{constructor(){this._commonWriter=new lt}updateSettings(e){this._commonWriter.updateSettings(e)}allocate(e){return G.createBuffer(e)}write(e,o,r){this._commonWriter.write(e,o,r),e.normalA.setVec(o,r.faceNormal0),e.normalB.setVec(o,r.faceNormal1)}trim(e,o){return this._commonWriter.trim(e,o)}}J.Layout=G,J.glLayout=W(G,1);const b=T(),j=new wt;function Ht(t){const e=Ut(t.data,t.skipDeduplicate,t.indices,t.indicesLength);return gt.updateSettings(t.writerSettings),ut.updateSettings(t.writerSettings),Pt(e,gt,ut)}function Ut(t,e,o,r){if(e){const N=at(o,r,t.count);return new _t(o,r,N,t)}const s=pt(t.buffer,t.stride/4,{originalIndices:o,originalIndicesLength:r}),c=at(s.indices,r,s.uniqueCount);return{faces:s.indices,facesLength:s.indices.length,neighbors:c,vertices:Tt.createView(s.buffer)}}class _t{constructor(e,o,r,s){this.faces=e,this.facesLength=o,this.neighbors=r,this.vertices=s}}const gt=new q,ut=new J,Xt=R().vec3f(g.POSITION0).vec3f(g.POSITION1),Gt=R().vec3f(g.POSITION0).vec3f(g.POSITION1).u16(g.COMPONENTINDEX).u16(g.U16PADDING,{glPadding:!0});export{Tt as A,Xt as a,Ht as f,Pt as h,Gt as m,Ut as u};
