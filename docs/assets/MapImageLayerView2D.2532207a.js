var C=Object.defineProperty,A=Object.defineProperties;var M=Object.getOwnPropertyDescriptors;var I=Object.getOwnPropertySymbols;var T=Object.prototype.hasOwnProperty,L=Object.prototype.propertyIsEnumerable;var G=(r,t,e)=>t in r?C(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e,b=(r,t)=>{for(var e in t||(t={}))T.call(t,e)&&G(r,e,t[e]);if(I)for(var e of I(t))L.call(t,e)&&G(r,e,t[e]);return r},F=(r,t)=>A(r,M(t));import{aD as m,aE as u,mt as q,aF as R,mO as H,er as z,n1 as O,g6 as Q,Y as S,eQ as B,lW as D,dI as W,U as k,n2 as N,O as v,X as K,n3 as X,et as Y,n4 as J,n5 as Z,eG as ee,iS as te,a9 as ie,K as se,at as E,ez as re,hN as ae}from"./vendor.1bde3be2.js";import{a as oe}from"./BitmapContainer.7555c21e.js";import{y as ne}from"./LayerView2D.b171dcd0.js";import{o as he}from"./BaseGraphicContainer.4435cd22.js";import{n as le}from"./HighlightGraphicContainer.16ca3cf0.js";import{v as pe}from"./ExportStrategy.397ad86b.js";import{u as ce}from"./LayerView.4356d8f0.js";import{s as V,a as me}from"./drapedUtils.548e20a2.js";import{d as de,s as ue}from"./popupUtils.60833c58.js";import{i as ye}from"./RefreshableLayerView.013b3b5b.js";import"./WGLContainer.8d2598e5.js";import"./enums.2d9e6f64.js";import"./pixelUtils.56448565.js";import"./utils.1743b4db.js";import"./Utils.7c0d2871.js";import"./number.30628ef2.js";import"./Texture.a39a8419.js";import"./VertexElementDescriptor.1fdca6da.js";import"./MaterialKey.5374c489.js";import"./alignmentUtils.6849a0a8.js";import"./definitions.d3c1cadf.js";import"./VertexArrayObject.1a48ce00.js";import"./vec4f32.f3b49d2e.js";import"./ProgramTemplate.1787c8d6.js";import"./StyleDefinition.c6d6e64a.js";import"./config.82550349.js";import"./GeometryUtils.51c4032a.js";import"./earcut.afc1d357.js";import"./cimAnalyzer.634e0c45.js";import"./BidiEngine.d8bba3fc.js";import"./Rect.95b0fd2e.js";import"./callExpressionWithFeature.549bbe4b.js";import"./GeometryUtils.4f19e772.js";import"./floatRGBA.4daa2263.js";import"./normalizeUtilsSync.9d282989.js";import"./FeatureContainer.8574c288.js";import"./TileContainer.6e7a8f40.js";import"./visualVariablesUtils.50808850.js";import"./visualVariablesUtils.09bb7ad8.js";import"./Matcher.c63fd4b6.js";import"./tileUtils.846c848b.js";import"./TileClipper.f7e6b335.js";import"./Geometry.d049a63c.js";import"./ExpandedCIM.e1e8d41e.js";import"./devEnvironmentUtils.d8d0484c.js";import"./schemaUtils.98621632.js";import"./createSymbolSchema.dec7dc29.js";import"./util.5241d02d.js";import"./ComputedAttributeStorage.8238c38f.js";import"./centroid.27e27241.js";import"./vec3f32.1121a836.js";import"./Bitmap.5488614e.js";let _=null;const ge=r=>{let t=class extends r{constructor(){super(...arguments),this._featuresResolutions=new WeakMap,this.highlightGraphics=new H,this.updateHighlightedFeatures=z(async e=>{this.destroyed||this.updatingHandles.addPromise(this._updateHighlightedFeaturesGeometries(e).catch(()=>{}))})}initialize(){this.exportImageParameters=new O({layer:this.layer}),this.handles.add([Q(()=>this.highlightGraphics,"change",e=>{this.updatingHandles.addPromise(this._updateHighlightedFeaturesSymbols(e.added).catch(()=>{})),this.updateHighlightedFeatures(this._highlightGeometriesResolution)})])}destroy(){this.exportImageParameters.destroy(),this.exportImageParameters=null}get exportImageVersion(){var e;return(e=this.exportImageParameters)==null||e.commitProperty("version"),this.commitProperty("timeExtent"),(this._get("exportImageVersion")||0)+1}async fetchPopupFeatures(e,i){var c,h,s,n,l,p;const{layer:o}=this;if(!e)throw new S("mapimagelayer:fetchPopupFeatures","Nothing to fetch without area",{layer:o});const a=(s=(h=(c=this.layer.capabilities)==null?void 0:c.operations)==null?void 0:h.supportsQuery)!=null?s:!0;if(!(((p=(l=(n=this.layer.capabilities)==null?void 0:n.operations)==null?void 0:l.supportsIdentify)!=null?p:!0)&&this.layer.version>=10.5)&&!a)throw new S("mapimagelayer:fetchPopupFeatures-not-supported","query operation is disabled for this service",{layer:o});return a?this._fetchPopupFeaturesUsingQueries(e,i):this._fetchPopupFeaturesUsingIdentify(e,i)}canResume(){var e;return!!super.canResume()&&!((e=this.timeExtent)==null?void 0:e.isEmpty)}async _updateHighlightedFeaturesSymbols(e){for(const i of e){const o="renderer"in i.sourceLayer&&i.sourceLayer.renderer;"geometryType"in i.sourceLayer&&i.sourceLayer.geometryType==="point"&&o&&"getSymbolAsync"in o&&o.getSymbolAsync(i).then(async a=>{var s;let c="width"in a&&"height"in a&&a.width!=null&&a.height!=null?Math.max(a.width,a.height):"size"in a?a.size:null;const h="visualVariables"in o&&((s=o.visualVariables)==null?void 0:s.find(n=>n.type==="size"));h&&(_||(_=(await import("./vendor.1bde3be2.js").then(function(n){return n.s3})).getSize),c=_(h,i,{view:this.view.type,scale:this.view.scale,shape:a.type==="simple-marker"?a.style:null})),this.highlightGraphics.includes(i)&&(i.symbol=new B({style:"square",size:c,xoffset:"xoffset"in a?a.xoffset:0,yoffset:"yoffset"in a?a.yoffset:0}),i.visible=!0,this.highlightGraphicUpdated(i,"symbol"))})}}async _updateHighlightedFeaturesGeometries(e){this._highlightGeometriesResolution=e;const i=this.highlightGraphics;if(!i.length||!this.layer.capabilities.operations.supportsQuery)return;const o=this._getTargetResolution(e),a=new Map;for(const s of i)if(!this._featuresResolutions.has(s)||this._featuresResolutions.get(s)>o){const n=s.sourceLayer;D(a,n,()=>new Map).set(s.getObjectId(),s)}const c=Array.from(a,([s,n])=>{const l=s.createQuery();return l.objectIds=[...n.keys()],l.outFields=[s.objectIdField],l.returnGeometry=!0,l.maxAllowableOffset=o,l.outSpatialReference=this.view.spatialReference,s.queryFeatures(l)}),h=await Promise.all(c);if(!this.destroyed)for(const{features:s}of h)for(const n of s){const l=n.sourceLayer,p=a.get(l).get(n.getObjectId());p&&this.highlightGraphics.includes(p)&&(p.geometry=n.geometry,this.highlightGraphicUpdated(p,"geometry"),this._featuresResolutions.set(p,o))}}_getTargetResolution(e){const i=e*W(this.view.spatialReference),o=i/16;return o<=10?0:e/i*o}async _fetchPopupFeaturesUsingIdentify(e,i){const o=await this._createIdentifyParameters(e,i);if(k(o))return[];const{results:a}=await N(this.layer.parsedUrl,o);return a.map(c=>c.feature)}async _createIdentifyParameters(e,i){const{floors:o,spatialReference:a,scale:c}=this.view,h=v(i)?i.event:null,s=await this._collectPopupProviders(this.layer.sublayers,c,i);if(!s.length)return null;await Promise.all(s.map(({sublayer:y})=>y.load().catch(()=>{})));const n=Math.min(K("mapimagelayer-popup-identify-max-tolerance"),this.layer.allSublayers.reduce((y,g)=>g.renderer?V({renderer:g.renderer,event:h}):y,2)),l=this.createFetchPopupFeaturesQueryGeometry(e,n),p=X(c,a),d=Math.round(l.width/p),w=new Y({xmin:l.center.x-p*d,ymin:l.center.y-p*d,xmax:l.center.x+p*d,ymax:l.center.y+p*d,spatialReference:l.spatialReference});return new J({floors:o,gdbVersion:this.layer.gdbVersion,geometry:e,height:d,layerOption:"popup",mapExtent:w,returnGeometry:!0,spatialReference:a,sublayers:this.layer.sublayers,timeExtent:this.timeExtent,tolerance:n,width:d})}async _fetchPopupFeaturesUsingQueries(e,i){const o=await this._collectPopupProviders(this.layer.sublayers,this.view.scale,i),a=v(i)?i.event:null,c=o.map(async({sublayer:h,popupTemplate:s})=>{var U,P;await h.load().catch(()=>{});const n=h.createQuery(),l=V({renderer:h.renderer,event:a}),p=this.createFetchPopupFeaturesQueryGeometry(e,l);if(n.geometry=p,n.outFields=await de(h,s),n.timeExtent=this.timeExtent,"floors"in this.view){const j=(P=(U=this.view)==null?void 0:U.floors)==null?void 0:P.clone(),x=Z(j,h);v(x)&&(n.where=n.where?`(${n.where}) AND (${x})`:x)}const d=this._getTargetResolution(p.width/l),w=await this._loadArcadeModules(s),y=h.geometryType==="point"||w&&w.arcadeUtils.hasGeometryOperations(s);y||(n.maxAllowableOffset=d);const{features:g}=await h.queryFeatures(n),$=y?0:d;for(const j of g)this._featuresResolutions.set(j,$);return g});return(await ee(c)).reverse().reduce((h,s)=>s.value?[...h,...s.value]:h,[]).filter(h=>h!=null)}async _collectPopupProviders(e,i,o){const a=[],c=async s=>{const n=s.minScale===0||i<=s.minScale,l=s.maxScale===0||i>=s.maxScale;if(s.visible&&n&&l){if(s.sublayers)s.sublayers.forEach(c);else if(s.popupEnabled){const p=ue(s,F(b({},o),{defaultPopupTemplateEnabled:!1}));v(p)&&a.unshift({sublayer:s,popupTemplate:p})}}},h=e.toArray().reverse().map(c);return await Promise.all(h),a}_loadArcadeModules(e){var i;if(((i=e.expressionInfos)==null?void 0:i.length)||Array.isArray(e.content)&&e.content.some(o=>o.type==="expression"))return te()}};return m([u()],t.prototype,"highlightGraphics",void 0),m([u()],t.prototype,"exportImageParameters",void 0),m([u({readOnly:!0})],t.prototype,"exportImageVersion",null),m([u()],t.prototype,"layer",void 0),m([u()],t.prototype,"suspended",void 0),m([u(q)],t.prototype,"timeExtent",void 0),t=m([R("esri.views.layers.MapImageLayerView")],t),t};let f=class extends ge(ye(ne(ce))){update(r){this.strategy.update(r).catch(t=>{ie(t)||se.getLogger(this.declaredClass).error(t)}),r.stationary&&this.updateHighlightedFeatures(r.state.resolution),this._highlightView.processUpdate(r)}attach(){const{imageMaxWidth:r,imageMaxHeight:t,version:e}=this.layer,i=e>=10.3,o=e>=10;this._bitmapContainer=new oe,this.container.addChild(this._bitmapContainer),this._highlightView=new he({view:this.view,graphics:this.highlightGraphics,requestUpdateCallback:()=>this.requestUpdate(),container:new le(this.view.featuresTilingScheme)}),this.container.addChild(this._highlightView.container),this.strategy=new pe({container:this._bitmapContainer,fetchSource:this.fetchImageBitmap.bind(this),requestUpdate:this.requestUpdate.bind(this),imageMaxWidth:r,imageMaxHeight:t,imageRotationSupported:i,imageNormalizationSupported:o,hidpi:!0}),this.handles.add(E(()=>this.exportImageVersion,()=>this.requestUpdate()),"exportImageVersion"),this.handles.add(E(()=>{var a;return(a=this.view)==null?void 0:a.floors},()=>this.requestUpdate()),"view.floors"),this.requestUpdate()}detach(){this.handles.remove("exportImageVersion"),this.handles.remove("view.floors"),this.strategy.destroy(),this.container.removeAllChildren(),this._bitmapContainer.removeAllChildren(),this._highlightView.destroy()}moveStart(){}viewChange(){}moveEnd(){this.requestUpdate()}highlight(r){let t=null;if(r instanceof re?t=[r]:ae.isCollection(r)&&r.length>0?t=r.toArray():Array.isArray(r)&&r.length>0&&(t=r),t=t==null?void 0:t.filter(Boolean),!t||!t.length)return{remove:()=>{}};for(const e of t)"geometryType"in e.sourceLayer&&e.sourceLayer.geometryType==="point"&&(e.visible=!1);return this.highlightGraphics.addMany(t),{remove:()=>{this.highlightGraphics.removeMany(t)}}}supportsSpatialReference(r){return this.layer.serviceSupportsSpatialReference(r)}createFetchPopupFeaturesQueryGeometry(r,t){return me(r,t,this.view)}async doRefresh(){this.requestUpdate()}isUpdating(){return this.strategy.updating||this.updateRequested}highlightGraphicUpdated(r,t){this._highlightView.graphicUpdateHandler({graphic:r,property:t})}fetchImage(r,t,e,i){return this.layer.fetchImage(r,t,e,b({timeExtent:this.timeExtent,floors:this.view.floors},i))}fetchImageBitmap(r,t,e,i){return this.layer.fetchImageBitmap(r,t,e,b({timeExtent:this.timeExtent,floors:this.view.floors},i))}};m([u()],f.prototype,"strategy",void 0),m([u()],f.prototype,"updating",void 0),f=m([R("esri.views.2d.layers.MapImageLayerView2D")],f);const gt=f;export{gt as default};
