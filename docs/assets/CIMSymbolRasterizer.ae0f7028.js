import{q0 as J,a8 as N,cR as B,cO as d,bJ as j,ac as A,q1 as L,a1 as K,bI as Q,q2 as V,q3 as U}from"./vendor.ad8aa1ba.js";import{s as Z,i as $,b as W,W as ee,T as te,m as ae,O as ie}from"./cimAnalyzer.209d4429.js";import{o as se,c as re}from"./Rasterizer.de49efb9.js";import"./fontUtils.c3d9f30f.js";import"./BidiEngine.d8bba3fc.js";import"./alignmentUtils.6849a0a8.js";import"./definitions.d3c1cadf.js";import"./number.30628ef2.js";import"./Rect.95b0fd2e.js";import"./callExpressionWithFeature.ebb41fc5.js";import"./GeometryUtils.4f19e772.js";import"./floatRGBA.cc457c75.js";import"./imageutils.c5bd8d1b.js";import"./rasterizingUtils.f70fef8e.js";var q;(function(y){y.Legend="legend",y.Preview="preview"})(q||(q={}));const X=y=>y&&y.scaleFactor?y.scaleFactor:1,ne=96/72;class ve{constructor(a,e){this._spatialReference=a,this._avoidSDF=e,this._resourceCache=new Map,this._imageDataCanvas=null,this._pictureMarkerCache=new Map,this._textRasterizer=new Z,this._cimResourceManager=new se,this._rasterizer=new re(this._cimResourceManager)}get resourceManager(){return this._cimResourceManager}async rasterizeCIMSymbolAsync(a,e,r,t,i,s,h,n){if(!a)return null;const{data:c}=a;if(!c||c.type!=="CIMSymbolReference"||!c.symbol)return null;const{symbol:C}=c;s||(s=J(C));const M=await $.resolveSymbolOverrides(c,e,this._spatialReference,i,s,h,n);this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));const g=this._imageDataCanvas,l=this._cimResourceManager,u=[];W.fetchResources(M,l,u),u.length>0&&await Promise.all(u);const{width:m,height:f}=r,_=oe(s,m,f,t),o=W.getEnvelope(M,_,l);if(!o)return null;const D=(window.devicePixelRatio||1)*ne;let v=1,k=0,z=0;switch(C.type){case"CIMPointSymbol":case"CIMTextSymbol":{let b=1;o.width>m&&(b=m/o.width);let P=1;o.height>f&&(P=f/o.height),t==="preview"&&(o.width<m&&(b=m/o.width),o.height<f&&(P=f/o.height)),v=Math.min(b,P),k=o.x+o.width/2,z=o.y+o.height/2}break;case"CIMLineSymbol":{let b=1;o.height>f&&(b=f/o.height),v=b,z=o.y+o.height/2;const P=o.x*v+m/2,p=(o.x+o.width)*v+m/2;if(P<0){const{paths:w}=_;w[0][0][0]-=P}if(p>m){const{paths:w}=_;w[0][2][0]-=p-m}}break;case"CIMPolygonSymbol":{k=o.x+o.width/2,z=o.y+o.height/2;const b=o.x*v+m/2,P=(o.x+o.width)*v+m/2,p=o.y*v+f/2,w=(o.y+o.height)*v+f/2,{rings:I}=_;b<0&&(I[0][0][0]-=b,I[0][3][0]-=b,I[0][4][0]-=b),p<0&&(I[0][0][1]+=p,I[0][1][1]+=p,I[0][4][1]+=p),P>m&&(I[0][1][0]-=P-m,I[0][2][0]-=P-m),w>f&&(I[0][2][1]+=w-f,I[0][3][1]+=w-f)}}g.width=m*D,g.height=f*D;const x=1;g.width+=2*x,g.height+=2*x;const S=g.getContext("2d"),R=ie.createIdentity();return R.translate(-k,-z),R.scale(v*D,-v*D),R.translate(m*D/2+x,f*D/2+x),S.clearRect(0,0,g.width,g.height),new ee(S,l,R,!0).drawSymbol(M,_),S.getImageData(0,0,g.width,g.height)}async analyzeCIMSymbol(a,e,r,t,i){const s=[],h=e?{geometryType:t,spatialReference:this._spatialReference,fields:e}:null;let n;await te(a.data,h,this._cimResourceManager,s,this._avoidSDF),N(i);for(const c of s)c.cim.type!=="CIMPictureMarker"&&c.cim.type!=="CIMPictureFill"&&c.cim.type!=="CIMPictureStroke"||(n||(n=[]),n.push(this._fetchPictureMarkerResource(c,i))),r&&c.type==="text"&&typeof c.text=="string"&&c.text.includes("[")&&(c.text=B(r,c.text,c.cim.textCase));return n&&await Promise.all(n),s}rasterizeCIMSymbol3D(a,e,r,t,i,s){const h=[];for(const n of a){t&&typeof t.scaleFactor=="function"&&(t.scaleFactor=t.scaleFactor(e,i,s));const c=this._getRasterizedResource(n,e,r,t,i,s);if(!c)continue;let C=0,M=c.anchorX||0,g=c.anchorY||0,l=!1,u=0,m=0;if(r==="esriGeometryPoint"){const f=X(t);if(u=d(n.offsetX,e,i,s)*f||0,m=d(n.offsetY,e,i,s)*f||0,n.type==="marker")C=d(n.rotation,e,i,s)||0,l=!!n.rotateClockwise&&n.rotateClockwise;else if(n.type==="text"){if(C=d(n.angle,e,i,s)||0,n.horizontalAlignment!==void 0)switch(n.horizontalAlignment){case"left":M=-.5;break;case"right":M=.5;break;default:M=0}if(n.verticalAlignment!==void 0)switch(n.verticalAlignment){case"top":g=.5;break;case"bottom":g=-.5;break;case"baseline":g=-.25;break;default:g=0}}}c!=null&&h.push({angle:C,rotateClockWise:l,anchorX:M,anchorY:g,offsetX:u,offsetY:m,rasterizedResource:c})}return this.getSymbolImage(h)}getSymbolImage(a){const e=document.createElement("canvas"),r=j(e.getContext("2d"));let t=0,i=0,s=0,h=0;const n=[];for(let g=0;g<a.length;g++){const l=a[g],u=l.rasterizedResource;if(!u)continue;const m=u.size,f=l.offsetX,_=l.offsetY,o=l.anchorX,D=l.anchorY,v=l.rotateClockWise||!1;let k=l.angle,z=A(f)-m[0]*(.5+o),x=A(_)-m[1]*(.5+D),S=z+m[0],R=x+m[1];if(k){v&&(k=-k);const p=Math.sin(k*Math.PI/180),w=Math.cos(k*Math.PI/180),I=z*w-x*p,Y=z*p+x*w,F=z*w-R*p,T=z*p+R*w,O=S*w-R*p,E=S*p+R*w,G=S*w-x*p,H=S*p+x*w;z=Math.min(I,F,O,G),x=Math.min(Y,T,E,H),S=Math.max(I,F,O,G),R=Math.max(Y,T,E,H)}t=z<t?z:t,i=x<i?x:i,s=S>s?S:s,h=R>h?R:h;const b=r.createImageData(u.size[0],u.size[1]);b.data.set(new Uint8ClampedArray(u.image.buffer));const P={offsetX:f,offsetY:_,rotateClockwise:v,angle:k,rasterizedImage:b,anchorX:o,anchorY:D};n.push(P)}e.width=s-t,e.height=h-i;const c=-t,C=h;for(let g=0;g<n.length;g++){const l=n[g],u=this._imageDataToCanvas(l.rasterizedImage),m=l.rasterizedImage.width,f=l.rasterizedImage.height,_=c-m*(.5+l.anchorX),o=C-f*(.5-l.anchorY);if(l.angle){const D=(360-l.angle)*Math.PI/180;r.save(),r.translate(A(l.offsetX),-A(l.offsetY)),r.translate(c,C),r.rotate(D),r.translate(-c,-C),r.drawImage(u,_,o),r.restore()}else r.drawImage(u,_+A(l.offsetX),o-A(l.offsetY))}const M=new L({x:c/e.width-.5,y:C/e.height-.5});return{imageData:e.width!==0&&e.height!==0?r.getImageData(0,0,e.width,e.height):r.createImageData(1,1),anchorPosition:M}}async _fetchPictureMarkerResource(a,e){const r=a.materialHash;if(!this._pictureMarkerCache.get(r)){const t=(await K(a.cim.url,{responseType:"image",signal:e&&e.signal})).data;this._pictureMarkerCache.set(r,t)}}_imageDataToCanvas(a){this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));const e=this._imageDataCanvas,r=j(e.getContext("2d"));return e.width=a.width,e.height=a.height,r.putImageData(a,0,0),e}_imageTo32Array(a,e,r,t){this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));const i=this._imageDataCanvas,s=j(i.getContext("2d"));if(i.width=e,i.height=r,s.drawImage(a,0,0,e,r),t){s.save();const h=new Q(t);s.fillStyle=h.toHex(),s.globalCompositeOperation="multiply",s.fillRect(0,0,e,r),s.globalCompositeOperation="destination-atop",s.drawImage(a,0,0,e,r),s.restore()}return new Uint32Array(s.getImageData(0,0,e,r).data.buffer)}_getRasterizedResource(a,e,r,t,i,s){let h,n,c;const C=null,M=null;if(a.type==="text")return this._rasterizeTextResource(a,e,t,i,s);({analyzedCIM:h,hash:n}=ce(a,e,i,s));const g=X(t);if(a.cim.type==="CIMPictureMarker"){const m=d(a.size,e,i,s)*g,{image:f,width:_,height:o}=j(this._getPictureResource(a,m,d(a.color,e,i,s)));return c={image:f,size:[_,o],sdf:!1,simplePattern:!1,anchorX:a.anchorPoint?a.anchorPoint.x:0,anchorY:a.anchorPoint?a.anchorPoint.y:0},c}V(h,g,{preserveOutlineWidth:!1});const l=h;n+=r,t&&(n+=JSON.stringify(t));const u=this._resourceCache;return u.has(n)?u.get(n):(c=this._rasterizer.rasterizeJSONResource({cim:l,type:a.type,url:a.url,mosaicHash:n,size:C,path:M},window.devicePixelRatio||1,this._avoidSDF),u.set(n,c),c)}_rasterizeTextResource(a,e,r,t,i){const s=X(r),h=d(a.text,e,t,i);if(!h||h.length===0)return null;const n=d(a.fontName,e,t,i),c=d(a.style,e,t,i),C=d(a.weight,e,t,i),M=d(a.decoration,e,t,i),g=d(a.size,e,t,i)*s,l=d(a.horizontalAlignment,e,t,i),u=d(a.verticalAlignment,e,t,i),m=U(d(a.color,e,t,i)),f=U(d(a.outlineColor,e,t,i)),_={color:m,size:g,horizontalAlignment:l,verticalAlignment:u,font:{family:n,style:c,weight:C,decoration:M},halo:{size:d(a.outlineSize,e,t,i)||0,color:f,style:c},pixelRatio:1,premultiplyColors:!this._avoidSDF};return this._textRasterizer.rasterizeText(h,_)}_getPictureResource(a,e,r){const t=this._pictureMarkerCache.get(a.materialHash);if(!t)return null;const i=t.height/t.width,s=e?i>1?A(e):A(e)/i:t.width,h=e?i>1?A(e)*i:A(e):t.height;return{image:this._imageTo32Array(t,s,h,r),width:s,height:h}}}function oe(y,a,e,r){const t=1,i=-a/2+t,s=a/2-t,h=e/2-t,n=-e/2+t;switch(y){case"esriGeometryPoint":return{x:0,y:0};case"esriGeometryPolyline":return{paths:[[[i,0],[0,0],[s,0]]]};default:return r==="legend"?{rings:[[[i,h],[s,0],[s,n],[i,n],[i,h]]]}:{rings:[[[i,h],[s,h],[s,n],[i,n],[i,h]]]}}}function ce(y,a,e,r){let t,i;return typeof y.materialHash=="function"?(t=(0,y.materialHash)(a,e,r),i=ae(y.cim,y.materialOverrides)):(t=y.materialHash,i=y.cim),{analyzedCIM:i,hash:t}}export{ve as CIMSymbolRasterizer,q as GeometryStyle};
