var M=Object.defineProperty;var v=Object.getOwnPropertySymbols;var F=Object.prototype.hasOwnProperty,U=Object.prototype.propertyIsEnumerable;var P=(r,e,t)=>e in r?M(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,I=(r,e)=>{for(var t in e||(e={}))F.call(e,t)&&P(r,t,e[t]);if(v)for(var t of v(e))U.call(e,t)&&P(r,t,e[t]);return r};import{aD as s,aE as m,mt as L,aF as S,Y as g,a9 as R,K as W,at as $,et as q}from"./vendor.1bde3be2.js";import{a as V}from"./BitmapContainer.7555c21e.js";import{y as D}from"./LayerView2D.b171dcd0.js";import{v as B}from"./ExportStrategy.397ad86b.js";import{u as z}from"./LayerView.4356d8f0.js";import{i as A}from"./RefreshableLayerView.013b3b5b.js";import{l as G}from"./ExportWMSImageParameters.5009eec4.js";import"./WGLContainer.8d2598e5.js";import"./enums.2d9e6f64.js";import"./pixelUtils.56448565.js";import"./utils.1743b4db.js";import"./Utils.7c0d2871.js";import"./number.30628ef2.js";import"./Texture.a39a8419.js";import"./VertexElementDescriptor.1fdca6da.js";import"./MaterialKey.5374c489.js";import"./alignmentUtils.6849a0a8.js";import"./definitions.d3c1cadf.js";import"./VertexArrayObject.1a48ce00.js";import"./vec4f32.f3b49d2e.js";import"./ProgramTemplate.1787c8d6.js";import"./StyleDefinition.c6d6e64a.js";import"./config.82550349.js";import"./GeometryUtils.51c4032a.js";import"./earcut.afc1d357.js";import"./Bitmap.5488614e.js";const H=r=>{let e=class extends r{initialize(){this.exportImageParameters=new G({layer:this.layer})}destroy(){this.exportImageParameters.destroy(),this.exportImageParameters=null}get exportImageVersion(){var t;return(t=this.exportImageParameters)==null||t.commitProperty("version"),this.commitProperty("timeExtent"),(this._get("exportImageVersion")||0)+1}fetchPopupFeatures(t){const{layer:a}=this;if(!t)return Promise.reject(new g("wmslayerview:fetchPopupFeatures","Nothing to fetch without area",{layer:a}));const{popupEnabled:n}=a;if(!n)return Promise.reject(new g("wmslayerview:fetchPopupFeatures","popupEnabled should be true",{popupEnabled:n}));const d=this.createFetchPopupFeaturesQuery(t);if(!d)return Promise.resolve([]);const{extent:i,width:o,height:p,x:u,y:c}=d;if(!(i&&o&&p))throw new g("wmslayerview:fetchPopupFeatures","WMSLayer does not support fetching features.",{extent:i,width:o,height:p});return a.fetchFeatureInfo(i,o,p,u,c)}};return s([m()],e.prototype,"exportImageParameters",void 0),s([m({readOnly:!0})],e.prototype,"exportImageVersion",null),s([m()],e.prototype,"layer",void 0),s([m(L)],e.prototype,"timeExtent",void 0),e=s([S("esri.layers.mixins.WMSLayerView")],e),e};let h=class extends H(A(D(z))){constructor(){super(...arguments),this.bitmapContainer=new V}supportsSpatialReference(r){return this.layer.serviceSupportsSpatialReference(r)}update(r){this.strategy.update(r).catch(e=>{R(e)||W.getLogger(this.declaredClass).error(e)})}attach(){const{layer:r}=this,{imageMaxHeight:e,imageMaxWidth:t}=r;this.bitmapContainer=new V,this.container.addChild(this.bitmapContainer),this.strategy=new B({container:this.bitmapContainer,fetchSource:this.fetchImage.bind(this),requestUpdate:this.requestUpdate.bind(this),imageMaxHeight:e,imageMaxWidth:t,imageRotationSupported:!1,imageNormalizationSupported:!1,hidpi:!1}),this.handles.add($(()=>this.exportImageVersion,()=>this.requestUpdate()),"exportImageVersion")}detach(){this.handles.remove("exportImageVersion"),this.strategy.destroy(),this.strategy=null,this.container.removeAllChildren()}moveStart(){}viewChange(){}moveEnd(){this.requestUpdate()}createFetchPopupFeaturesQuery(r){const{view:e,bitmapContainer:t}=this,{x:a,y:n}=r,{spatialReference:d}=e;let i=null,o=0,p=0;if(t.children.some(C=>{const{width:f,height:x,resolution:j,x:l,y}=C,w=l+j*f,b=y-j*x;return a>=l&&a<=w&&n<=y&&n>=b&&(i=new q({xmin:l,ymin:b,xmax:w,ymax:y,spatialReference:d}),o=f,p=x,!0)}),!i)return null;const u=i.width/o,c=Math.round((a-i.xmin)/u),E=Math.round((i.ymax-n)/u);return{extent:i,width:o,height:p,x:c,y:E}}async doRefresh(){this.requestUpdate()}isUpdating(){return this.strategy.updating||this.updateRequested}fetchImage(r,e,t,a){return this.layer.fetchImageBitmap(r,e,t,I({timeExtent:this.timeExtent},a))}};s([m()],h.prototype,"strategy",void 0),s([m()],h.prototype,"updating",void 0),h=s([S("esri.views.2d.layers.WMSLayerView2D")],h);const ge=h;export{ge as default};
