var M=Object.defineProperty;var b=Object.getOwnPropertySymbols;var U=Object.prototype.hasOwnProperty,F=Object.prototype.propertyIsEnumerable;var P=(r,e,t)=>e in r?M(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,I=(r,e)=>{for(var t in e||(e={}))U.call(e,t)&&P(r,t,e[t]);if(b)for(var t of b(e))F.call(e,t)&&P(r,t,e[t]);return r};import{aJ as s,aK as m,mz as L,aL as S,a3 as f,af as R,S as W,az as $,ez as q}from"./vendor.faf54504.js";import{a as V}from"./BitmapContainer.b16692d9.js";import{y as z}from"./LayerView2D.f9d8756f.js";import{v as D}from"./ExportStrategy.a59544af.js";import{u as B}from"./LayerView.9097b9c4.js";import{i as A}from"./RefreshableLayerView.21a246c0.js";import{l as G}from"./ExportWMSImageParameters.203702a1.js";import"./WGLContainer.3275b1cd.js";import"./enums.2d9e6f64.js";import"./pixelUtils.34cd9289.js";import"./utils.f12e4514.js";import"./Utils.b66268a2.js";import"./number.30628ef2.js";import"./Texture.5f3d51a1.js";import"./VertexElementDescriptor.1fdca6da.js";import"./MaterialKey.41925623.js";import"./alignmentUtils.6849a0a8.js";import"./definitions.d3c1cadf.js";import"./VertexArrayObject.cccbf8c8.js";import"./vec4f32.f3b49d2e.js";import"./ProgramTemplate.c4ecd603.js";import"./StyleDefinition.099454d7.js";import"./config.82550349.js";import"./GeometryUtils.51c4032a.js";import"./earcut.afc1d357.js";import"./Bitmap.64843fff.js";const H=r=>{let e=class extends r{initialize(){this.exportImageParameters=new G({layer:this.layer})}destroy(){this.exportImageParameters.destroy(),this.exportImageParameters=null}get exportImageVersion(){var t;return(t=this.exportImageParameters)==null||t.commitProperty("version"),this.commitProperty("timeExtent"),(this._get("exportImageVersion")||0)+1}fetchPopupFeatures(t){const{layer:a}=this;if(!t)return Promise.reject(new f("wmslayerview:fetchPopupFeatures","Nothing to fetch without area",{layer:a}));const{popupEnabled:n}=a;if(!n)return Promise.reject(new f("wmslayerview:fetchPopupFeatures","popupEnabled should be true",{popupEnabled:n}));const d=this.createFetchPopupFeaturesQuery(t);if(!d)return Promise.resolve([]);const{extent:i,width:o,height:p,x:u,y:c}=d;if(!(i&&o&&p))throw new f("wmslayerview:fetchPopupFeatures","WMSLayer does not support fetching features.",{extent:i,width:o,height:p});return a.fetchFeatureInfo(i,o,p,u,c)}};return s([m()],e.prototype,"exportImageParameters",void 0),s([m({readOnly:!0})],e.prototype,"exportImageVersion",null),s([m()],e.prototype,"layer",void 0),s([m(L)],e.prototype,"timeExtent",void 0),e=s([S("esri.layers.mixins.WMSLayerView")],e),e};let h=class extends H(A(z(B))){constructor(){super(...arguments),this.bitmapContainer=new V}supportsSpatialReference(r){return this.layer.serviceSupportsSpatialReference(r)}update(r){this.strategy.update(r).catch(e=>{R(e)||W.getLogger(this.declaredClass).error(e)})}attach(){const{layer:r}=this,{imageMaxHeight:e,imageMaxWidth:t}=r;this.bitmapContainer=new V,this.container.addChild(this.bitmapContainer),this.strategy=new D({container:this.bitmapContainer,fetchSource:this.fetchImage.bind(this),requestUpdate:this.requestUpdate.bind(this),imageMaxHeight:e,imageMaxWidth:t,imageRotationSupported:!1,imageNormalizationSupported:!1,hidpi:!1}),this.handles.add($(()=>this.exportImageVersion,()=>this.requestUpdate()),"exportImageVersion")}detach(){this.handles.remove("exportImageVersion"),this.strategy.destroy(),this.strategy=null,this.container.removeAllChildren()}moveStart(){}viewChange(){}moveEnd(){this.requestUpdate()}createFetchPopupFeaturesQuery(r){const{view:e,bitmapContainer:t}=this,{x:a,y:n}=r,{spatialReference:d}=e;let i=null,o=0,p=0;if(t.children.some(E=>{const{width:g,height:x,resolution:j,x:l,y}=E,w=l+j*g,v=y-j*x;return a>=l&&a<=w&&n<=y&&n>=v&&(i=new q({xmin:l,ymin:v,xmax:w,ymax:y,spatialReference:d}),o=g,p=x,!0)}),!i)return null;const u=i.width/o,c=Math.round((a-i.xmin)/u),C=Math.round((i.ymax-n)/u);return{extent:i,width:o,height:p,x:c,y:C}}async doRefresh(){this.requestUpdate()}isUpdating(){return this.strategy.updating||this.updateRequested}fetchImage(r,e,t,a){return this.layer.fetchImageBitmap(r,e,t,I({timeExtent:this.timeExtent},a))}};s([m()],h.prototype,"strategy",void 0),s([m()],h.prototype,"updating",void 0),h=s([S("esri.views.2d.layers.WMSLayerView2D")],h);const fe=h;export{fe as default};
