var z=Object.defineProperty,X=Object.defineProperties;var q=Object.getOwnPropertyDescriptors;var k=Object.getOwnPropertySymbols;var Y=Object.prototype.hasOwnProperty,_=Object.prototype.propertyIsEnumerable;var A=(n,t,e)=>t in n?z(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e,f=(n,t)=>{for(var e in t||(t={}))Y.call(t,e)&&A(n,e,t[e]);if(k)for(var e of k(t))_.call(t,e)&&A(n,e,t[e]);return n},w=(n,t)=>X(n,q(t));import{op as g,oN as C,U as h,oO as H,J as m,oP as J,dN as R,oQ as v,bb as G,E,eg as Q,fq as B,nF as F,ey as K,ez as Z,et as ee,oR as te,A as U}from"./vendor.150443b7.js";import{s as ne}from"./geojson.778f322f.js";import{n as S,o as x}from"./xmlUtils.56e603f6.js";function ae(n){var t;return(t=se(n))!=null?t:re(n)}function re(n){const t=new Date(n).getTime();return Number.isNaN(t)?null:t}function se(n){var y,d,P,$;const t=oe.exec(n);if(!(t==null?void 0:t.groups))return null;const e=t.groups,a=+e.year,r=+e.month-1,s=+e.day,o=+((y=e.hours)!=null?y:"0"),i=+((d=e.minutes)!=null?d:"0"),u=+((P=e.seconds)!=null?P:"0");if(o>23||i>59||u>59)return null;const p=($=e.ms)!=null?$:"0",c=p?+p.padEnd(3,"0").substring(0,3):0;let l;if(e.isUTC)l=Date.UTC(a,r,s,o,i,u,c);else if(e.offsetSign){const V=+e.offsetHours,W=+e.offsetMinutes;l=6e4*(e.offsetSign==="+"?-1:1)*(60*V+W)+Date.UTC(a,r,s,o,i,u,c)}else l=new Date(a,r,s,o,i,u,c).getTime();return Number.isNaN(l)?null:l}const oe=/^(?:(?<year>-?\d{4,})-(?<month>\d{2})-(?<day>\d{2}))(?:T(?<hours>\d{2}):(?<minutes>\d{2}):(?<seconds>\d{2})(?:\.(?<ms>\d+))?)?(?:(?<isUTC>Z)|(?:(?<offsetSign>\+|-)(?<offsetHours>\d{2}):(?<offsetMinutes>\d{2})))?$/,N="xlink:href",b="2.0.0",D="__esri_wfs_id__",ie="wfs-layer:getWFSLayerTypeInfo-error",ue="wfs-layer:empty-service",j="wfs-layer:feature-type-not-found",pe="wfs-layer:geojson-not-supported",ce="wfs-layer:kvp-encoding-not-supported",le="wfs-layer:malformed-json",O="wfs-layer:unknown-geometry-type",me="wfs-layer:unknown-field-type",ye="wfs-layer:unsupported-spatial-reference",fe="wfs-layer:unsupported-wfs-version";async function je(n,t){const e=de((await h(n,{responseType:"text",query:f({SERVICE:"WFS",REQUEST:"GetCapabilities",VERSION:b},t==null?void 0:t.customParameters),signal:t==null?void 0:t.signal})).data);return be(n,e),e}function de(n){const t=L(n);Re(t),M(t);const e=t.firstElementChild,a=H(Te(e));return{operations:we(e),get featureTypes(){return Array.from(a())},readFeatureTypes:a}}const ge=new Set(["json","application/json","geojson","application/json; subtype=geojson"]);function we(n){let t=!1;const e={GetCapabilities:{url:""},DescribeFeatureType:{url:""},GetFeature:{url:"",outputFormat:null,supportsPagination:!1}};if(x(n,{OperationsMetadata:{Operation:a=>{switch(a.getAttribute("name")){case"GetCapabilities":return{DCP:{HTTP:{Get:r=>{e.GetCapabilities.url=r.getAttribute(N)}}}};case"DescribeFeatureType":return{DCP:{HTTP:{Get:r=>{e.DescribeFeatureType.url=r.getAttribute(N)}}}};case"GetFeature":return{DCP:{HTTP:{Get:r=>{e.GetFeature.url=r.getAttribute(N)}}},Parameter:r=>{if(r.getAttribute("name")==="outputFormat")return{AllowedValues:{Value:s=>{const o=s.textContent;o&&ge.has(o.toLowerCase())&&(e.GetFeature.outputFormat=o)}}}}}}},Constraint:a=>{switch(a.getAttribute("name")){case"KVPEncoding":return{DefaultValue:r=>{t=r.textContent.toLowerCase()==="true"}};case"ImplementsResultPaging":return{DefaultValue:r=>{e.GetFeature.supportsPagination=r.textContent.toLowerCase()==="true"}}}}}}),!t)throw new m(ce,"WFS service doesn't support key/value pair (KVP) encoding");if(E(e.GetFeature.outputFormat))throw new m(pe,"WFS service doesn't support GeoJSON output format");return e}function be(n,t){J(n)&&(R(n,t.operations.DescribeFeatureType.url,!0)&&(t.operations.DescribeFeatureType.url=v(t.operations.DescribeFeatureType.url)),R(n,t.operations.GetFeature.url,!0)&&(t.operations.GetFeature.url=v(t.operations.GetFeature.url)))}function Te(n){return S(n,{FeatureTypeList:{FeatureType:t=>{const e={typeName:"undefined:undefined",name:"",title:"",description:"",extent:null,namespacePrefix:"",namespaceUri:"",supportedSpatialReferences:[]},a=new Set([4326]),r=s=>{var i,u,p,c;const o=parseInt((c=(p=(u=(i=s.textContent)==null?void 0:i.match(/(?<wkid>\d+$)/i))==null?void 0:u.groups)==null?void 0:p.wkid)!=null?c:"",10);Number.isNaN(o)||a.add(o)};return x(t,{Name:s=>{const{name:o,prefix:i}=T(s.textContent);e.typeName=`${i}:${o}`,e.name=o,e.namespacePrefix=i,e.namespaceUri=s.lookupNamespaceURI(i)},Abstract:s=>{e.description=s.textContent},Title:s=>{e.title=s.textContent},WGS84BoundingBox:s=>{e.extent=he(s)},DefaultSRS:r,DefaultCRS:r,OtherSRS:r,OtherCRS:r}),e.title||(e.title=e.name),e.supportedSpatialReferences.push(...a),e}}})}function he(n){let t,e,a,r;for(const s of n.children)switch(s.localName){case"LowerCorner":[t,e]=s.textContent.split(" ").map(o=>Number.parseFloat(o));break;case"UpperCorner":[a,r]=s.textContent.split(" ").map(o=>Number.parseFloat(o))}return{xmin:t,ymin:e,xmax:a,ymax:r,spatialReference:F}}function Fe(n,t,e){return C(n,a=>e?a.name===t&&a.namespaceUri===e:a.typeName===t||a.name===t)}async function Oe(n,t,e,a={}){var l;const{featureType:r,extent:s}=await Se(n,t,e,a),{fields:o,geometryType:i,swapXY:u,objectIdField:p,geometryField:c}=await xe(n,r.typeName,a);return{url:n.operations.GetCapabilities.url,name:r.name,namespaceUri:r.namespaceUri,fields:o,geometryField:c,geometryType:i,objectIdField:p,spatialReference:(l=a.spatialReference)!=null?l:G.WGS84,extent:s,swapXY:u,wfsCapabilities:n,customParameters:a.customParameters}}async function Se(n,t,e,a={}){const{spatialReference:r=G.WGS84}=a,s=n.readFeatureTypes(),o=t?Fe(s,t,e):s.next().value;if(E(o))throw t?new m(j,`The type '${t}' could not be found in the service`):new m(ue,"The service is empty");let i=new Q(w(f({},o.extent),{spatialReference:r}));if(!B(r,F))try{await K(F,r,void 0,a),i=Z(i,F)}catch{throw new m(ye,"Projection not supported")}return{extent:i,spatialReference:r,featureType:o}}async function xe(n,t,e={}){var p,c,l,y,d;const[a,r]=await ee([Ne(n.operations.DescribeFeatureType.url,t,e),Ee(n,t,e)]);if(a.error||r.error)throw new m(ie,`An error occurred while getting info about the feature type '${t}'`,{error:a.error||r.error});const{fields:s,errors:o}=(p=a.value)!=null?p:{},i=((c=a.value)==null?void 0:c.geometryType)||((l=r.value)==null?void 0:l.geometryType),u=(d=(y=r.value)==null?void 0:y.swapXY)!=null?d:!1;if(E(i))throw new m(O,`The geometry type could not be determined for type '${t}`,{typeName:t,geometryType:i,fields:s,errors:o});return w(f({},Ce(s!=null?s:[])),{geometryType:i,swapXY:u})}function Ce(n){var a;const t=n.find(r=>r.type==="geometry");let e=n.find(r=>r.type==="oid");return n=n.filter(r=>r.type!=="geometry"),e||(e=new g({name:D,type:"oid",alias:D}),n.unshift(e)),{geometryField:(a=t==null?void 0:t.name)!=null?a:null,objectIdField:e.name,fields:n}}async function Ee(n,t,e={}){var u;let a,r=!1;const[s,o]=await Promise.all([Ae(n.operations.GetFeature.url,t,n.operations.GetFeature.outputFormat,w(f({},e),{count:1})),h(n.operations.GetFeature.url,{responseType:"text",query:I(t,void 0,w(f({},e),{count:1})),signal:e==null?void 0:e.signal})]),i=s.type==="FeatureCollection"&&((u=s.features[0])==null?void 0:u.geometry);if(i){let p;switch(a=te.fromJSON(ne(i.type)),i.type){case"Point":p=i.coordinates;break;case"LineString":case"MultiPoint":p=i.coordinates[0];break;case"MultiLineString":case"Polygon":p=i.coordinates[0][0];break;case"MultiPolygon":p=i.coordinates[0][0][0]}const c=/<[^>]*pos[^>]*> *(-?\d+(?:\.\d+)?) (-?\d+(?:\.\d+)?)/.exec(o.data);if(c){const l=p[0].toFixed(3),y=p[1].toFixed(3),d=parseFloat(c[1]).toFixed(3);l===parseFloat(c[2]).toFixed(3)&&y===d&&(r=!0)}}return{geometryType:a,swapXY:r}}async function Ne(n,t,e){return Pe(t,(await h(n,{responseType:"text",query:f({SERVICE:"WFS",REQUEST:"DescribeFeatureType",VERSION:b,TYPENAME:t},e==null?void 0:e.customParameters),signal:e==null?void 0:e.signal})).data)}function Pe(n,t){const{name:e}=T(n),a=L(t);M(a);const r=C(S(a.firstElementChild,{element:s=>({name:s.getAttribute("name"),typeName:T(s.getAttribute("type")).name})}),({name:s})=>s===e);if(U(r)){const s=C(S(a.firstElementChild,{complexType:o=>o}),o=>o.getAttribute("name")===r.typeName);if(U(s))return ke(s)}throw new m(j,`Type '${n}' not found in document`,{document:new XMLSerializer().serializeToString(a)})}const $e=new Set(["objectid","fid"]);function ke(n){const t=[],e=[];let a;const r=S(n,{complexContent:{extension:{sequence:{element:s=>s}}}});for(const s of r){const o=s.getAttribute("name");if(!o)continue;let i,u;if(s.hasAttribute("type")?i=T(s.getAttribute("type")).name:x(s,{simpleType:{restriction:l=>(i=T(l.getAttribute("base")).name,{maxLength:y=>{u=+y.getAttribute("value")}})}}),!i)continue;const p=s.getAttribute("nillable")==="true";let c=!1;switch(i.toLowerCase()){case"integer":case"nonpositiveinteger":case"negativeinteger":case"long":case"int":case"short":case"byte":case"nonnegativeinteger":case"unsignedlong":case"unsignedint":case"unsignedshort":case"unsignedbyte":case"positiveinteger":e.push(new g({name:o,alias:o,type:"integer",nullable:p}));break;case"float":case"double":case"decimal":e.push(new g({name:o,alias:o,type:"double",nullable:p}));break;case"boolean":case"string":case"gyearmonth":case"gyear":case"gmonthday":case"gday":case"gmonth":case"anyuri":case"qname":case"notation":case"normalizedstring":case"token":case"language":case"idrefs":case"entities":case"nmtoken":case"nmtokens":case"name":case"ncname":case"id":case"idref":case"entity":case"duration":case"time":e.push(new g({name:o,alias:o,type:"string",nullable:p,length:u!=null?u:255}));break;case"datetime":case"date":e.push(new g({name:o,alias:o,type:"date",nullable:p,length:u!=null?u:36}));break;case"pointpropertytype":a="point",c=!0;break;case"multipointpropertytype":a="multipoint",c=!0;break;case"curvepropertytype":case"multicurvepropertytype":case"multilinestringpropertytype":a="polyline",c=!0;break;case"surfacepropertytype":case"multisurfacepropertytype":case"multipolygonpropertytype":a="polygon",c=!0;break;case"geometrypropertytype":case"multigeometrypropertytype":c=!0,t.push(new m(O,`geometry type '${i}' is not supported`,{type:new XMLSerializer().serializeToString(n)}));break;default:t.push(new m(me,`Unknown field type '${i}'`,{type:new XMLSerializer().serializeToString(n)}))}c&&e.push(new g({name:o,alias:o,type:"geometry",nullable:p}))}for(const s of e)if(s.type==="integer"&&!s.nullable&&$e.has(s.name.toLowerCase())){s.type="oid";break}return{geometryType:a,fields:e,errors:t}}async function Ae(n,t,e,a){var s;let{data:r}=await h(n,{responseType:"text",query:I(t,e,a),signal:a==null?void 0:a.signal});r=r.replace(/": +(-?\d+),(\d+)(,)?/g,'": $1.$2$3');try{if((s=a==null?void 0:a.dateFields)==null?void 0:s.length){const o=new Set(a.dateFields);return JSON.parse(r,(i,u)=>o.has(i)?ae(u):u)}return JSON.parse(r)}catch(o){throw new m(le,"Error while parsing the\xA0response",{response:r,error:o})}}function I(n,t,e){return f({SERVICE:"WFS",REQUEST:"GetFeature",VERSION:b,TYPENAMES:n,OUTPUTFORMAT:t,SRSNAME:"EPSG:4326",STARTINDEX:e==null?void 0:e.startIndex,COUNT:e==null?void 0:e.count},e==null?void 0:e.customParameters)}function L(n){return new DOMParser().parseFromString(n.trim(),"text/xml")}function T(n){const[t,e]=n.split(":");return{prefix:e?t:"",name:e!=null?e:t}}function Re(n){var e;const t=(e=n.firstElementChild)==null?void 0:e.getAttribute("version");if(t&&t!==b)throw new m(fe,`Unsupported WFS version ${t}. Supported version: ${b}`)}function M(n){let t="",e="";if(x(n.firstElementChild,{Exception:a=>(t=a.getAttribute("exceptionCode"),{ExceptionText:r=>{e=r.textContent}})}),t)throw new m(`wfs-layer:${t}`,e)}export{D as C,je as D,Ae as K,Fe as W,Oe as X,Ce as z};
