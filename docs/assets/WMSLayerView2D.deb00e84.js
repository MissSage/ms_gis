var M=Object.defineProperty;var v=Object.getOwnPropertySymbols;var U=Object.prototype.hasOwnProperty,F=Object.prototype.propertyIsEnumerable;var P=(r,e,t)=>e in r?M(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,I=(r,e)=>{for(var t in e||(e={}))U.call(e,t)&&P(r,t,e[t]);if(v)for(var t of v(e))F.call(e,t)&&P(r,t,e[t]);return r};import{aq as s,ar as m,mg as L,as as S,J as g,X as R,x as q,ag as W,eg as $}from"./vendor.150443b7.js";import{a as V}from"./BitmapContainer.43ffce21.js";import{y as D}from"./LayerView2D.494015a0.js";import{v as B}from"./ExportStrategy.7515610b.js";import{u as z}from"./LayerView.2481493a.js";import{i as A}from"./RefreshableLayerView.43d2ae17.js";import{l as G}from"./ExportWMSImageParameters.21f7f6d4.js";import"./WGLContainer.8ea5db01.js";import"./enums.2d9e6f64.js";import"./pixelUtils.e6b9584d.js";import"./utils.9098e95e.js";import"./Utils.eb4237a0.js";import"./number.30628ef2.js";import"./Texture.0551b3c6.js";import"./VertexElementDescriptor.1fdca6da.js";import"./MaterialKey.420ab2c9.js";import"./alignmentUtils.6849a0a8.js";import"./definitions.d3c1cadf.js";import"./VertexArrayObject.b8066877.js";import"./vec4f32.f3b49d2e.js";import"./ProgramTemplate.30b3a6f7.js";import"./StyleDefinition.5e257d9e.js";import"./config.82550349.js";import"./GeometryUtils.51c4032a.js";import"./earcut.afc1d357.js";import"./Bitmap.3f05d3f3.js";const H=r=>{let e=class extends r{initialize(){this.exportImageParameters=new G({layer:this.layer})}destroy(){this.exportImageParameters.destroy(),this.exportImageParameters=null}get exportImageVersion(){var t;return(t=this.exportImageParameters)==null||t.commitProperty("version"),this.commitProperty("timeExtent"),(this._get("exportImageVersion")||0)+1}fetchPopupFeatures(t){const{layer:a}=this;if(!t)return Promise.reject(new g("wmslayerview:fetchPopupFeatures","Nothing to fetch without area",{layer:a}));const{popupEnabled:n}=a;if(!n)return Promise.reject(new g("wmslayerview:fetchPopupFeatures","popupEnabled should be true",{popupEnabled:n}));const d=this.createFetchPopupFeaturesQuery(t);if(!d)return Promise.resolve([]);const{extent:i,width:o,height:p,x:u,y:l}=d;if(!(i&&o&&p))throw new g("wmslayerview:fetchPopupFeatures","WMSLayer does not support fetching features.",{extent:i,width:o,height:p});return a.fetchFeatureInfo(i,o,p,u,l)}};return s([m()],e.prototype,"exportImageParameters",void 0),s([m({readOnly:!0})],e.prototype,"exportImageVersion",null),s([m()],e.prototype,"layer",void 0),s([m(L)],e.prototype,"timeExtent",void 0),e=s([S("esri.layers.mixins.WMSLayerView")],e),e};let h=class extends H(A(D(z))){constructor(){super(...arguments),this.bitmapContainer=new V}supportsSpatialReference(r){return this.layer.serviceSupportsSpatialReference(r)}update(r){this.strategy.update(r).catch(e=>{R(e)||q.getLogger(this.declaredClass).error(e)})}attach(){const{layer:r}=this,{imageMaxHeight:e,imageMaxWidth:t}=r;this.bitmapContainer=new V,this.container.addChild(this.bitmapContainer),this.strategy=new B({container:this.bitmapContainer,fetchSource:this.fetchImage.bind(this),requestUpdate:this.requestUpdate.bind(this),imageMaxHeight:e,imageMaxWidth:t,imageRotationSupported:!1,imageNormalizationSupported:!1,hidpi:!1}),this.handles.add(W(()=>this.exportImageVersion,()=>this.requestUpdate()),"exportImageVersion")}detach(){this.handles.remove("exportImageVersion"),this.strategy.destroy(),this.strategy=null,this.container.removeAllChildren()}moveStart(){}viewChange(){}moveEnd(){this.requestUpdate()}createFetchPopupFeaturesQuery(r){const{view:e,bitmapContainer:t}=this,{x:a,y:n}=r,{spatialReference:d}=e;let i=null,o=0,p=0;if(t.children.some(E=>{const{width:f,height:x,resolution:j,x:c,y}=E,w=c+j*f,b=y-j*x;return a>=c&&a<=w&&n<=y&&n>=b&&(i=new $({xmin:c,ymin:b,xmax:w,ymax:y,spatialReference:d}),o=f,p=x,!0)}),!i)return null;const u=i.width/o,l=Math.round((a-i.xmin)/u),C=Math.round((i.ymax-n)/u);return{extent:i,width:o,height:p,x:l,y:C}}async doRefresh(){this.requestUpdate()}isUpdating(){return this.strategy.updating||this.updateRequested}fetchImage(r,e,t,a){return this.layer.fetchImageBitmap(r,e,t,I({timeExtent:this.timeExtent},a))}};s([m()],h.prototype,"strategy",void 0),s([m()],h.prototype,"updating",void 0),h=s([S("esri.views.2d.layers.WMSLayerView2D")],h);const ge=h;export{ge as default};
