var M=Object.defineProperty;var v=Object.getOwnPropertySymbols;var F=Object.prototype.hasOwnProperty,U=Object.prototype.propertyIsEnumerable;var P=(r,e,t)=>e in r?M(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,I=(r,e)=>{for(var t in e||(e={}))F.call(e,t)&&P(r,t,e[t]);if(v)for(var t of v(e))U.call(e,t)&&P(r,t,e[t]);return r};import{aD as s,aE as m,mY as L,aF as S,Y as f,a9 as R,K as W,at as $,e8 as q}from"./vendor.ad8aa1ba.js";import{a as V}from"./BitmapContainer.b79f1977.js";import{y as D}from"./LayerView2D.dfaa8db6.js";import{v as B}from"./ExportStrategy.c01fbce9.js";import{u as z}from"./LayerView.e359e190.js";import{i as A}from"./RefreshableLayerView.a566bbdb.js";import{l as G}from"./ExportWMSImageParameters.eadc1300.js";import"./WGLContainer.af3d731a.js";import"./enums.2d9e6f64.js";import"./pixelUtils.62190471.js";import"./utils.baffb554.js";import"./Utils.4c2feac4.js";import"./number.30628ef2.js";import"./Texture.22d23c43.js";import"./VertexElementDescriptor.1fdca6da.js";import"./MaterialKey.6f6162d1.js";import"./alignmentUtils.6849a0a8.js";import"./definitions.d3c1cadf.js";import"./VertexArrayObject.6d35aaee.js";import"./vec4f32.f3b49d2e.js";import"./ProgramTemplate.83597331.js";import"./StyleDefinition.02cc41be.js";import"./config.82550349.js";import"./GeometryUtils.51c4032a.js";import"./earcut.afc1d357.js";import"./Bitmap.11b33ab6.js";const H=r=>{let e=class extends r{initialize(){this.exportImageParameters=new G({layer:this.layer})}destroy(){this.exportImageParameters.destroy(),this.exportImageParameters=null}get exportImageVersion(){var t;return(t=this.exportImageParameters)==null||t.commitProperty("version"),this.commitProperty("timeExtent"),(this._get("exportImageVersion")||0)+1}fetchPopupFeatures(t){const{layer:i}=this;if(!t)return Promise.reject(new f("wmslayerview:fetchPopupFeatures","Nothing to fetch without area",{layer:i}));const{popupEnabled:n}=i;if(!n)return Promise.reject(new f("wmslayerview:fetchPopupFeatures","popupEnabled should be true",{popupEnabled:n}));const d=this.createFetchPopupFeaturesQuery(t);if(!d)return Promise.resolve([]);const{extent:a,width:o,height:p,x:u,y:c}=d;if(!(a&&o&&p))throw new f("wmslayerview:fetchPopupFeatures","WMSLayer does not support fetching features.",{extent:a,width:o,height:p});return i.fetchFeatureInfo(a,o,p,u,c)}};return s([m()],e.prototype,"exportImageParameters",void 0),s([m({readOnly:!0})],e.prototype,"exportImageVersion",null),s([m()],e.prototype,"layer",void 0),s([m(L)],e.prototype,"timeExtent",void 0),e=s([S("esri.layers.mixins.WMSLayerView")],e),e};let h=class extends H(A(D(z))){constructor(){super(...arguments),this.bitmapContainer=new V}supportsSpatialReference(r){return this.layer.serviceSupportsSpatialReference(r)}update(r){this.strategy.update(r).catch(e=>{R(e)||W.getLogger(this.declaredClass).error(e)})}attach(){const{layer:r}=this,{imageMaxHeight:e,imageMaxWidth:t}=r;this.bitmapContainer=new V,this.container.addChild(this.bitmapContainer),this.strategy=new B({container:this.bitmapContainer,fetchSource:this.fetchImage.bind(this),requestUpdate:this.requestUpdate.bind(this),imageMaxHeight:e,imageMaxWidth:t,imageRotationSupported:!1,imageNormalizationSupported:!1,hidpi:!1}),this.handles.add($(()=>this.exportImageVersion,()=>this.requestUpdate()),"exportImageVersion")}detach(){this.handles.remove("exportImageVersion"),this.strategy.destroy(),this.strategy=null,this.container.removeAllChildren()}moveStart(){}viewChange(){}moveEnd(){this.requestUpdate()}createFetchPopupFeaturesQuery(r){const{view:e,bitmapContainer:t}=this,{x:i,y:n}=r,{spatialReference:d}=e;let a=null,o=0,p=0;if(t.children.some(C=>{const{width:g,height:x,resolution:j,x:l,y}=C,w=l+j*g,b=y-j*x;return i>=l&&i<=w&&n<=y&&n>=b&&(a=new q({xmin:l,ymin:b,xmax:w,ymax:y,spatialReference:d}),o=g,p=x,!0)}),!a)return null;const u=a.width/o,c=Math.round((i-a.xmin)/u),E=Math.round((a.ymax-n)/u);return{extent:a,width:o,height:p,x:c,y:E}}async doRefresh(){this.requestUpdate()}isUpdating(){return this.strategy.updating||this.updateRequested}fetchImage(r,e,t,i){return this.layer.fetchImageBitmap(r,e,t,I({timeExtent:this.timeExtent},i))}};s([m()],h.prototype,"strategy",void 0),s([m()],h.prototype,"updating",void 0),h=s([S("esri.views.2d.layers.WMSLayerView2D")],h);const fe=h;export{fe as default};
